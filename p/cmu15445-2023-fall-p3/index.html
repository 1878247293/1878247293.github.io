<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="È°πÁõÆÁΩëÂùÄÔºö È°πÁõÆ #3 - Êü•ËØ¢ÊâßË°å |CMU 15-445/645 ÔºöÔºö Êï∞ÊçÆÂ∫ìÁ≥ªÁªüÁÆÄ‰ªãÔºà2023 Âπ¥ÁßãÂ≠£Ôºâ\n‰∏Ä„ÄÅSQLËØ≠Âè•ÊâßË°åÊµÅÁ®ã 1 ÊÄª‰Ωì ËøôÈÉ®ÂàÜËØæ‰∏äÊúâÂæàËØ¶ÁªÜÁöÑËß£Èáä\nÂú®Êî∂Âà∞‰∏ÄÊù° SQL ËØ≠Âè•ÂêéÔºåÊü•ËØ¢Â§ÑÁêÜÂ±ÇÈ¶ñÂÖà‰ºöÈÄöËøáËß£ÊûêÂô® Parser Â∞Ü SQL ËØ≠Âè•Ëß£Êûê‰∏∫‰∏ÄÈ¢óÊäΩË±°Âè•Ê≥ïÊ†ë ASTÔºàAbstracct Syntax TreeÔºâ„ÄÇÊé•‰∏ãÊù•ÁªëÂÆöÂô® Binder ‰ºöÈÅçÂéÜËøôÊ£µÂè•Ê≥ïÊ†ëÔºåÂ∞ÜË°®Âêç„ÄÅÂàóÂêçÁ≠âÊò†Â∞ÑÂà∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂÆûÈôÖÂØπË±°‰∏äÔºåÂπ∂Áî±ËÆ°ÂàíÂô® Planner ÁîüÊàêÂàùÊ≠•ÁöÑÊü•ËØ¢ËÆ°Âàí„ÄÇÊü•ËØ¢ËÆ°Âàí‰ºö‰ª•Ê†ëÁöÑÂΩ¢ÂºèË°®Á§∫ÔºåÊï∞ÊçÆ‰ªéÂè∂Â≠êËäÇÁÇπÊµÅÂêëÁà∂ËäÇÁÇπ„ÄÇ\n">
<title>cmu15445 2023 fall   p3</title>

<link rel='canonical' href='https://1878247293.github.io/p/cmu15445-2023-fall-p3/'>

<link rel="stylesheet" href="/scss/style.min.35b5cf656aeed6866c8c29f06538873b76aac06fc1c8c993b42ce1408b061e7a.css"><meta property='og:title' content="cmu15445 2023 fall   p3">
<meta property='og:description' content="È°πÁõÆÁΩëÂùÄÔºö È°πÁõÆ #3 - Êü•ËØ¢ÊâßË°å |CMU 15-445/645 ÔºöÔºö Êï∞ÊçÆÂ∫ìÁ≥ªÁªüÁÆÄ‰ªãÔºà2023 Âπ¥ÁßãÂ≠£Ôºâ\n‰∏Ä„ÄÅSQLËØ≠Âè•ÊâßË°åÊµÅÁ®ã 1 ÊÄª‰Ωì ËøôÈÉ®ÂàÜËØæ‰∏äÊúâÂæàËØ¶ÁªÜÁöÑËß£Èáä\nÂú®Êî∂Âà∞‰∏ÄÊù° SQL ËØ≠Âè•ÂêéÔºåÊü•ËØ¢Â§ÑÁêÜÂ±ÇÈ¶ñÂÖà‰ºöÈÄöËøáËß£ÊûêÂô® Parser Â∞Ü SQL ËØ≠Âè•Ëß£Êûê‰∏∫‰∏ÄÈ¢óÊäΩË±°Âè•Ê≥ïÊ†ë ASTÔºàAbstracct Syntax TreeÔºâ„ÄÇÊé•‰∏ãÊù•ÁªëÂÆöÂô® Binder ‰ºöÈÅçÂéÜËøôÊ£µÂè•Ê≥ïÊ†ëÔºåÂ∞ÜË°®Âêç„ÄÅÂàóÂêçÁ≠âÊò†Â∞ÑÂà∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂÆûÈôÖÂØπË±°‰∏äÔºåÂπ∂Áî±ËÆ°ÂàíÂô® Planner ÁîüÊàêÂàùÊ≠•ÁöÑÊü•ËØ¢ËÆ°Âàí„ÄÇÊü•ËØ¢ËÆ°Âàí‰ºö‰ª•Ê†ëÁöÑÂΩ¢ÂºèË°®Á§∫ÔºåÊï∞ÊçÆ‰ªéÂè∂Â≠êËäÇÁÇπÊµÅÂêëÁà∂ËäÇÁÇπ„ÄÇ\n">
<meta property='og:url' content='https://1878247293.github.io/p/cmu15445-2023-fall-p3/'>
<meta property='og:site_name' content='ÊòéÂ§©ÂÜçËßÅ‰∏™‰∫∫ÂçöÂÆ¢'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-11-11T15:29:00&#43;08:00'/><meta property='article:modified_time' content='2025-03-21T21:48:57&#43;08:00'/>
<meta name="twitter:title" content="cmu15445 2023 fall   p3">
<meta name="twitter:description" content="È°πÁõÆÁΩëÂùÄÔºö È°πÁõÆ #3 - Êü•ËØ¢ÊâßË°å |CMU 15-445/645 ÔºöÔºö Êï∞ÊçÆÂ∫ìÁ≥ªÁªüÁÆÄ‰ªãÔºà2023 Âπ¥ÁßãÂ≠£Ôºâ\n‰∏Ä„ÄÅSQLËØ≠Âè•ÊâßË°åÊµÅÁ®ã 1 ÊÄª‰Ωì ËøôÈÉ®ÂàÜËØæ‰∏äÊúâÂæàËØ¶ÁªÜÁöÑËß£Èáä\nÂú®Êî∂Âà∞‰∏ÄÊù° SQL ËØ≠Âè•ÂêéÔºåÊü•ËØ¢Â§ÑÁêÜÂ±ÇÈ¶ñÂÖà‰ºöÈÄöËøáËß£ÊûêÂô® Parser Â∞Ü SQL ËØ≠Âè•Ëß£Êûê‰∏∫‰∏ÄÈ¢óÊäΩË±°Âè•Ê≥ïÊ†ë ASTÔºàAbstracct Syntax TreeÔºâ„ÄÇÊé•‰∏ãÊù•ÁªëÂÆöÂô® Binder ‰ºöÈÅçÂéÜËøôÊ£µÂè•Ê≥ïÊ†ëÔºåÂ∞ÜË°®Âêç„ÄÅÂàóÂêçÁ≠âÊò†Â∞ÑÂà∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂÆûÈôÖÂØπË±°‰∏äÔºåÂπ∂Áî±ËÆ°ÂàíÂô® Planner ÁîüÊàêÂàùÊ≠•ÁöÑÊü•ËØ¢ËÆ°Âàí„ÄÇÊü•ËØ¢ËÆ°Âàí‰ºö‰ª•Ê†ëÁöÑÂΩ¢ÂºèË°®Á§∫ÔºåÊï∞ÊçÆ‰ªéÂè∂Â≠êËäÇÁÇπÊµÅÂêëÁà∂ËäÇÁÇπ„ÄÇ\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu6528894822542699760.png" width="300"
                            height="236" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">ÊòéÂ§©ÂÜçËßÅ‰∏™‰∫∫ÂçöÂÆ¢</a></h1>
            <h2 class="site-description">Ê¨¢ËøéÊù•Âà∞ÊàëÁöÑÁΩëÁ´ô</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/366783890?spm_id_from=333.1007.0.0'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/dashboard'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>‰∏ªÈ°µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>ÂÖ≥‰∫é</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>ÂΩíÊ°£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>ÊêúÁ¥¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>ÂèãÊÉÖÈìæÊé•</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>ÊöóËâ≤Ê®°Âºè</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#‰∏ÄsqlËØ≠Âè•ÊâßË°åÊµÅÁ®ã">‰∏Ä„ÄÅSQLËØ≠Âè•ÊâßË°åÊµÅÁ®ã</a>
          <ol>
            <li></li>
          </ol>
        </li>
        <li><a href="#‰∫åbustub-Ë°®ÁªìÊûÑ">‰∫å„ÄÅbustub Ë°®ÁªìÊûÑ</a></li>
        <li><a href="#Êï∞ÊçÆÂ∫ìÁªìÊûÑÂõæËØ¶Ëß£Èõ∂Âü∫Á°ÄÂèãÂ•ΩÁâà">Êï∞ÊçÆÂ∫ìÁªìÊûÑÂõæËØ¶Ëß£‚Äî‚ÄîÈõ∂Âü∫Á°ÄÂèãÂ•ΩÁâà</a>
          <ol>
            <li><a href="#‰∏ÄÊï¥‰ΩìÁªìÊûÑÂÉè‰∏ÄÊú¨‰π¶ÁöÑÂõæ‰π¶È¶Ü"><strong>‰∏Ä„ÄÅÊï¥‰ΩìÁªìÊûÑÔºöÂÉè‰∏ÄÊú¨‰π¶ÁöÑÂõæ‰π¶È¶Ü</strong></a></li>
            <li><a href="#‰∫åÊ†∏ÂøÉÁªÑ‰ª∂ÈÄêÂ±ÇËß£Êûê"><strong>‰∫å„ÄÅÊ†∏ÂøÉÁªÑ‰ª∂ÈÄêÂ±ÇËß£Êûê</strong></a></li>
            <li><a href="#‰∏âÊï∞ÊçÆÂ≠òÂèñÊµÅÁ®ãÁ§∫‰æã"><strong>‰∏â„ÄÅÊï∞ÊçÆÂ≠òÂèñÊµÅÁ®ãÁ§∫‰æã</strong></a></li>
            <li><a href="#ÂõõÂÖ≥ÈîÆÊ¶ÇÂøµÊÄªÁªì"><strong>Âõõ„ÄÅÂÖ≥ÈîÆÊ¶ÇÂøµÊÄªÁªì</strong></a></li>
            <li><a href="#‰∫îÊñ∞ÊâãÂ∏∏ËßÅÁñëÈóÆËß£Á≠î"><strong>‰∫î„ÄÅÊñ∞ÊâãÂ∏∏ËßÅÁñëÈóÆËß£Á≠î</strong></a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#‰ªªÂä°-1---ËÆøÈóÆÊñπÊ≥ïÊâßË°åÁ®ãÂ∫è">‰ªªÂä° #1 - ËÆøÈóÆÊñπÊ≥ïÊâßË°åÁ®ãÂ∫è</a></li>
    <li><a href="#‰ªªÂä°-2---ËÅöÂêàÂíåËÅîÊé•ÊâßË°åËÄÖ">‰ªªÂä° #2 - ËÅöÂêàÂíåËÅîÊé•ÊâßË°åËÄÖ</a></li>
    <li><a href="#‰ªªÂä°-3---hashjoin-ÊâßË°åÁ®ãÂ∫èÂíå‰ºòÂåñ">‰ªªÂä° #3 - HashJoin ÊâßË°åÁ®ãÂ∫èÂíå‰ºòÂåñ</a></li>
    <li><a href="#‰ªªÂä°-4ÊéíÂ∫è--ÈôêÂà∂ÊâßË°åÁ®ãÂ∫è--Á™óÂè£ÂáΩÊï∞--top-n-‰ºòÂåñ">‰ªªÂä° #4ÔºöÊéíÂ∫è + ÈôêÂà∂ÊâßË°åÁ®ãÂ∫è + Á™óÂè£ÂáΩÊï∞ + Top-N ‰ºòÂåñ</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/cmu15445-2023-fall-p3/">cmu15445 2023 fall   p3</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 11, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 43 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>È°πÁõÆÁΩëÂùÄÔºö
<a class="link" href="https://15445.courses.cs.cmu.edu/fall2023/project3/"  target="_blank" rel="noopener"
    >È°πÁõÆ #3 - Êü•ËØ¢ÊâßË°å |CMU 15-445/645 ÔºöÔºö Êï∞ÊçÆÂ∫ìÁ≥ªÁªüÁÆÄ‰ªãÔºà2023 Âπ¥ÁßãÂ≠£Ôºâ</a></p>
<h3 id="‰∏ÄsqlËØ≠Âè•ÊâßË°åÊµÅÁ®ã">‰∏Ä„ÄÅSQLËØ≠Âè•ÊâßË°åÊµÅÁ®ã
</h3><h5 id="1-ÊÄª‰Ωì">1 ÊÄª‰Ωì
</h5><p>ËøôÈÉ®ÂàÜËØæ‰∏äÊúâÂæàËØ¶ÁªÜÁöÑËß£Èáä</p>
<p><img src="/p/cmu15445-2023-fall-p3/v2-0153721c0fdae293c9f05afc7fca6f26_r.jpg"
	width="720"
	height="470"
	srcset="/p/cmu15445-2023-fall-p3/v2-0153721c0fdae293c9f05afc7fca6f26_r_hu1188234299884625231.jpg 480w, /p/cmu15445-2023-fall-p3/v2-0153721c0fdae293c9f05afc7fca6f26_r_hu6753897992435815574.jpg 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="153"
		data-flex-basis="367px"
	
></p>
<p>Âú®Êî∂Âà∞‰∏ÄÊù° SQL ËØ≠Âè•ÂêéÔºåÊü•ËØ¢Â§ÑÁêÜÂ±ÇÈ¶ñÂÖà‰ºöÈÄöËøáËß£ÊûêÂô® Parser Â∞Ü SQL ËØ≠Âè•Ëß£Êûê‰∏∫‰∏ÄÈ¢óÊäΩË±°Âè•Ê≥ïÊ†ë ASTÔºàAbstracct Syntax TreeÔºâ„ÄÇÊé•‰∏ãÊù•ÁªëÂÆöÂô® Binder ‰ºöÈÅçÂéÜËøôÊ£µÂè•Ê≥ïÊ†ëÔºåÂ∞ÜË°®Âêç„ÄÅÂàóÂêçÁ≠âÊò†Â∞ÑÂà∞Êï∞ÊçÆÂ∫ì‰∏≠ÁöÑÂÆûÈôÖÂØπË±°‰∏äÔºåÂπ∂Áî±ËÆ°ÂàíÂô® Planner ÁîüÊàêÂàùÊ≠•ÁöÑÊü•ËØ¢ËÆ°Âàí„ÄÇÊü•ËØ¢ËÆ°Âàí‰ºö‰ª•Ê†ëÁöÑÂΩ¢ÂºèË°®Á§∫ÔºåÊï∞ÊçÆ‰ªéÂè∂Â≠êËäÇÁÇπÊµÅÂêëÁà∂ËäÇÁÇπ„ÄÇ</p>
<p><img src="/p/cmu15445-2023-fall-p3/b2d6646deea01ab132d02ca201df6898.png"
	width="458"
	height="501"
	srcset="/p/cmu15445-2023-fall-p3/b2d6646deea01ab132d02ca201df6898_hu1884340708351099970.png 480w, /p/cmu15445-2023-fall-p3/b2d6646deea01ab132d02ca201df6898_hu1556303524938805176.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="91"
		data-flex-basis="219px"
	
></p>
<p>ÊúÄÂêéÔºå‰ºòÂåñÂô® Optimizer ‰ºö‰ºòÂåñÁîüÊàêÊúÄÁªàÁöÑÊü•ËØ¢ËÆ°ÂàíÔºåÁÑ∂Âêé‰∫§Áî±Êü•ËØ¢ÊâßË°åÂ±ÇÁöÑÊâßË°åÂô®ÊâßË°åÔºåËÄåËøôÈáåÈù¢ÁöÑÈÉ®ÂàÜÊâßË°åÂô®ÈúÄË¶ÅÊàë‰ª¨Êù•ÂÆûÁé∞„ÄÇ</p>
<h5 id="2-‰æãÂ≠ê">2 ‰æãÂ≠ê
</h5><p>ÔºàËØ≠Âè•ÂâçÈù¢Âä†explainÂèØ‰ª•ÊâìÂç∞Âá∫ËØ≠Âè•ÁöÑÊü•ËØ¢ËÆ°ÂàíÔºâ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">bustub</span><span class="o">&gt;</span> <span class="n">explain</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">test_1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*ËøôÈÉ®ÂàÜÊèèËø∞‰∫ÜÊü•ËØ¢ÁªëÂÆöÂô®ÔºàBinderÔºâÂ¶Ç‰ΩïÂ§ÑÁêÜSQLÊü•ËØ¢„ÄÇÂÆÉËß£Êûê‰∫ÜÊü•ËØ¢ÔºåÂπ∂Â∞ÜSQLÁöÑÊñáÊú¨Ë°®Á§∫ËΩ¨Êç¢‰∏∫ÂÜÖÈÉ®ÁöÑÊï∞ÊçÆÁªìÊûÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">Âú®Ëøô‰∏™‰æãÂ≠ê‰∏≠ÔºåÂÆÉË°®Á§∫Êü•ËØ¢ÈÄâÊã©‰∫Ü test_1 Ë°®‰∏≠ÁöÑÊâÄÊúâÂàóÔºàcolA, colB, colC, colDÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">Ê≤°Êúâ‰ΩøÁî® GROUP BY, HAVING, WHERE, LIMIT, OFFSET, Êàñ ORDER BY Â≠êÂè•„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">‰πü‰∏çÊòØ‰∏Ä‰∏™DISTINCTÊü•ËØ¢ÔºåÂπ∂‰∏îÊ≤°Êúâ‰ΩøÁî®ÂÖ¨ÂÖ±Ë°®Ë°®ËææÂºèÔºàCTEÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">===</span> <span class="n">BINDER</span> <span class="o">===</span>
</span></span><span class="line"><span class="cl"><span class="n">BoundSelect</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">table</span><span class="o">=</span><span class="n">BoundBaseTableRef</span> <span class="p">{</span> <span class="n">table</span><span class="o">=</span><span class="n">test_1</span><span class="p">,</span> <span class="n">oid</span><span class="o">=</span><span class="mi">20</span> <span class="p">},</span>
</span></span><span class="line"><span class="cl">  <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="n">test_1</span><span class="p">.</span><span class="n">colA</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="n">colB</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="n">colC</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="n">colD</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">  <span class="n">groupBy</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="n">having</span><span class="o">=</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">where</span><span class="o">=</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">limit</span><span class="o">=</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">offset</span><span class="o">=</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">order_by</span><span class="o">=</span><span class="p">[],</span>
</span></span><span class="line"><span class="cl">  <span class="n">is_distinct</span><span class="o">=</span><span class="nb">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">ctes</span><span class="o">=</span><span class="p">,</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*ËøôÈÉ®ÂàÜÂ±ïÁ§∫‰∫ÜÊü•ËØ¢ËßÑÂàíÂô®ÔºàPlannerÔºâÁîüÊàêÁöÑÊü•ËØ¢ÊâßË°åËÆ°Âàí„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">ProjectionÔºöËøôÊòØ‰∏Ä‰∏™ÊäïÂΩ±Êìç‰ΩúÔºåÊÑèÂë≥ÁùÄÂÆÉÂ∞Ü‰ªé‰∏ã‰∏ÄÁ∫ßÊìç‰ΩúÔºàÂú®ËøôÁßçÊÉÖÂÜµ‰∏ãÊòØ SeqScanÔºâ‰∏≠ÈÄâÊã©ÁâπÂÆöÁöÑÂàóÔºàËøôÈáåÊòØ #0.0 Âà∞ #0.3ÔºåÂÆÉ‰ª¨ÂØπÂ∫î‰∫é test_1 Ë°®ÁöÑ colA Âà∞ colDÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">SeqScanÔºöËøôÊòØ‰∏Ä‰∏™È°∫Â∫èÊâ´ÊèèÊìç‰ΩúÔºåÊÑèÂë≥ÁùÄÂÆÉÂ∞ÜÊâ´ÊèèÊï¥‰∏™ test_1 Ë°®‰ª•Ëé∑ÂèñÊï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">===</span> <span class="n">PLANNER</span> <span class="o">===</span>
</span></span><span class="line"><span class="cl"><span class="n">Projection</span> <span class="p">{</span> <span class="n">exprs</span><span class="o">=</span><span class="p">[</span><span class="err">#</span><span class="mf">0.0</span><span class="p">,</span> <span class="err">#</span><span class="mf">0.1</span><span class="p">,</span> <span class="err">#</span><span class="mf">0.2</span><span class="p">,</span> <span class="err">#</span><span class="mf">0.3</span><span class="p">]</span> <span class="p">}</span> <span class="o">|</span> <span class="p">(</span><span class="n">test_1</span><span class="p">.</span><span class="nl">colA</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colB</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colC</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colD</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">  <span class="n">SeqScan</span> <span class="p">{</span> <span class="n">table</span><span class="o">=</span><span class="n">test_1</span> <span class="p">}</span> <span class="o">|</span> <span class="p">(</span><span class="n">test_1</span><span class="p">.</span><span class="nl">colA</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colB</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colC</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colD</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*ËøôÈÉ®ÂàÜÂ±ïÁ§∫‰∫ÜÊü•ËØ¢‰ºòÂåñÂô®ÔºàOptimizerÔºâÂèØËÉΩÂ¶Ç‰ΩïËøõ‰∏ÄÊ≠•‰ºòÂåñÊü•ËØ¢ÊâßË°åËÆ°Âàí„ÄÇ‰ΩÜÂú®Ëøô‰∏™‰æãÂ≠ê‰∏≠ÔºåÂÆÉ‰ºº‰πéÊ≤°ÊúâÂÅö‰ªª‰Ωï‰ºòÂåñÔºåÂè™ÊòØÁÆÄÂçïÂú∞ËøîÂõû‰∫Ü‰∏éPlannerÁõ∏ÂêåÁöÑËÆ°Âàí„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">ÊâÄ‰ª•Ôºå‰ºòÂåñÂêéÁöÑËÆ°Âàí‰ªçÁÑ∂ÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÈ°∫Â∫èÊâ´ÊèèÔºàSeqScanÔºâÊìç‰Ωú„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="o">===</span> <span class="n">OPTIMIZER</span> <span class="o">===</span>
</span></span><span class="line"><span class="cl"><span class="n">SeqScan</span> <span class="p">{</span> <span class="n">table</span><span class="o">=</span><span class="n">test_1</span> <span class="p">}</span> <span class="o">|</span> <span class="p">(</span><span class="n">test_1</span><span class="p">.</span><span class="nl">colA</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colB</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colC</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">test_1</span><span class="p">.</span><span class="nl">colD</span><span class="p">:</span><span class="n">INTEGER</span><span class="p">)</span><span class="n">bustub</span><span class="o">&gt;</span> <span class="n">explain</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">test_1</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="‰∫åbustub-Ë°®ÁªìÊûÑ">‰∫å„ÄÅbustub Ë°®ÁªìÊûÑ
</h3><p>‰∏çÂæó‰∏çËØ¥Ëøô‰∏™ÂõæÁúüÁöÑÂÅöÁöÑÂ§™Â•Ω‰∫ÜÔºåËøô‰∏™ÁúãÊáÇ‰∫ÜÊâçËÉΩÂÅö‰∏ãÂéª</p>
<img src="Êï∞ÊçÆÂ∫ì.jpg" style="zoom:33%;" />
<p><strong>1 ÂõæÁöÑËß£ËØª</strong>
È¶ñÂÖàÔºåBustub Êúâ‰∏Ä‰∏™ Catalog„ÄÇCatalog Áª¥Êä§‰∫ÜÂá†Âº† hashmapÔºå‰øùÂ≠ò‰∫Ü table id Âíå table name Âà∞ table info ÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇtable id Áî± Catalog Âú®Êñ∞Âª∫ table Êó∂Ëá™Âä®ÂàÜÈÖçÔºåtable name ÂàôÁî±Áî®Êà∑ÊåáÂÆö„ÄÇ</p>
<p>‚Äã		ËøôÈáåÁöÑ table info ÂåÖÂê´‰∫Ü‰∏ÄÂº† table ‰ø°ÊÅØÔºåÊúâ schema„ÄÅname„ÄÅid ÂíåÊåáÂêë table heap ÁöÑÊåáÈíà„ÄÇÁ≥ªÁªüÁöÑÂÖ∂‰ªñÈÉ®ÂàÜÊÉ≥Ë¶ÅËÆøÈóÆ‰∏ÄÂº† table Êó∂ÔºåÂÖà‰ΩøÁî® name Êàñ id ‰ªé Catalog ÂæóÂà∞ table infoÔºåÂÜçËÆøÈóÆ table info ‰∏≠ÁöÑ table heap„ÄÇ</p>
<p>‚Äã		table heap ÊòØÁÆ°ÁêÜ table Êï∞ÊçÆÁöÑÁªìÊûÑÔºåÂåÖÂê´ table Áõ∏ÂÖ≥Êìç‰Ωú„ÄÇtable heap ÂèØËÉΩÁî±Â§ö‰∏™ table page ÁªÑÊàêÔºå‰ªÖ‰øùÂ≠òÂÖ∂Á¨¨‰∏Ä‰∏™ table page ÁöÑ page id„ÄÇÈúÄË¶ÅËÆøÈóÆÊüê‰∏™ table page Êó∂ÔºåÈÄöËøá page id ÁªèÁî± buffer pool ËÆøÈóÆ„ÄÇ</p>
<p>‚Äã		table page ÊòØÂÆûÈôÖÂ≠òÂÇ® table Êï∞ÊçÆÁöÑÁªìÊûÑÔºåÂΩìÈúÄË¶ÅÊñ∞Â¢û tuple Êó∂Ôºåtable heap ‰ºöÊâæÂà∞ÂΩìÂâçÂ±û‰∫éËá™Â∑±ÁöÑÊúÄÂêé‰∏ÄÂº† table pageÔºåÂ∞ùËØïÊèíÂÖ•ÔºåËã•ÊúÄÂêé‰∏ÄÂº† table page Â∑≤Êª°ÔºåÂàôÊñ∞Âª∫‰∏ÄÂº† table page ÊèíÂÖ• tuple„ÄÇtable page ‰ΩéÂú∞ÂùÄÂ≠òÊîæ headerÔºåtuple ‰ªéÈ´òÂú∞ÂùÄ‰πüÂ∞±ÊòØ table page Â∞æÈÉ®ÂºÄÂßãÊèíÂÖ•„ÄÇ</p>
<p>‚Äã		tuple ÂØπÂ∫îÊï∞ÊçÆË°®‰∏≠ÁöÑ‰∏ÄË°åÊï∞ÊçÆ„ÄÇÊØè‰∏™ tuple ÈÉΩÁî± RID ÂîØ‰∏ÄÊ†áËØÜ„ÄÇRID Áî± page id + slot num ÊûÑÊàê„ÄÇtuple Áî± value ÁªÑÊàêÔºåvalue ÁöÑ‰∏™Êï∞ÂíåÁ±ªÂûãÁî± table info ‰∏≠ÁöÑ schema ÊåáÂÆö„ÄÇvalue ÂàôÊòØÊüê‰∏™Â≠óÊÆµÂÖ∑‰ΩìÁöÑÂÄºÔºåvalue Êú¨Ë∫´Ëøò‰øùÂ≠ò‰∫ÜÁ±ªÂûã‰ø°ÊÅØ„ÄÇ</p>
<p><strong>2 ÁªìÂêà‰ª£Á†ÅËß£ËØª</strong>
È¶ñÂÖàÔºåÊàë‰ª¨‰ªéÊâÄÊúâÊâßË°åÂô®ÁöÑÂü∫Á±ªÊäΩË±°ÊâßË°åÂô® AbstractExecutor ÂÖ•ÊâãÔºàË∑ØÂæÑÔºö src/include/execution/executors/abstract_executor.hÔºâÔºåÊäΩË±°ÊâßË°åÂô®ÂÆûÁé∞‰∫Ü‰∏Ä‰∏™ tuple-at-a-time ÂΩ¢ÂºèÁöÑÁÅ´Â±±Ëø≠‰ª£Âô®Ê®°ÂûãÔºåtuple-at-a-time Ë°®ÊòéÊØèÊ¨°Ë∞ÉÁî® Next() ÂáΩÊï∞‰ºö‰ªéÂΩìÂâçÊâßË°åÂô®Ëé∑Âèñ‰∏Ä‰∏™ tupleÔºåÁÅ´Â±±Ê®°ÂûãÂàôË°®ÊòéÊï∞ÊçÆ‰ªéÂ≠êÊâßË°åÂô®ÂêëÁà∂ÊâßË°åÂô®‰º†ÈÄíÔºåÊ†πËäÇÁÇπÁöÑËæìÂá∫Âç≥‰∏∫ÊúÄÁªàÁöÑÊâßË°åÁªìÊûú„ÄÇÂÆÉ‰∏ªË¶ÅÂåÖÊã¨ Init() Âíå Next() ‰∏§‰∏™ÊàêÂëòÂáΩÊï∞„ÄÇ</p>
<p>‚Äã		AbstractExecutor Âè™ÊúâÊâßË°åÂô®‰∏ä‰∏ãÊñá ExecutorContext Ëøô‰∏Ä‰∏™ÊàêÂëòÂèòÈáè(Ë∑ØÂæÑÔºösrc/include/execution/executor_context.h)ÔºåExecutorContext ÂåÖÊã¨ÂΩìÂâç‰∫ãÂä° TransactionÔºàÂèòÈáèÂêçÔºötransactionÔºâ„ÄÅÁºìÂÜ≤Ê±†ÁÆ°ÁêÜÂô® BufferPoolManagerÔºàÂèòÈáèÂêçÔºöbpmÔºâ„ÄÅ‰∫ãÂä°ÁÆ°ÁêÜÂô® TransactionManagerÔºàÂèòÈáèÂêçÔºötxn_mgrÔºâ„ÄÅÈîÅÁÆ°ÁêÜÂô® LockManagerÔºàÂèòÈáèÂêçÔºölock_mgrÔºâ ‰ª•ÂèäÁõÆÂΩï CatalogÔºàÂèòÈáèÂêçÔºöcatalogÔºâ„ÄÇ</p>
<p>‚Äã		‰∏éË°®ÁÆ°ÁêÜÁõ¥Êé•Áõ∏ÂÖ≥ÁöÑÂ∞±ÊòØÊâßË°åÂô®‰∏ä‰∏ãÊñá‰∏≠ÁöÑÁõÆÂΩï CatalogÔºàËßÅ‰∏äÂõæÔºâÔºåÁõÆÂΩï‰∏≠‰∏ªË¶ÅÂåÖÂê´‰∫Ü‰∏Ä‰∏™Ë°®Ê†áËØÜÁ¨¶Âà∞Ë°®‰ø°ÊÅØ TableInfo ÁöÑÊò†Â∞Ñ std::unordered_map&lt;table_oid_t, std::unique_ptr<TableInfo>&gt; tables_; Âíå‰∏Ä‰∏™Ë°®ÂêçÂà∞Ë°®Ê†áËØÜÁ¨¶ÁöÑÊò†Â∞Ñ std::unordered_map&lt;std::string, table_oid_t&gt; table_names_;(‰∏äÂõæ‰∏≠ÁªøËâ≤ÁöÑtableInfo)„ÄÇ</p>
<p>‚Äã		Ë°®‰ø°ÊÅØ TableInfo ‰∏ªË¶Å‰øùÂ≠ò‰∫ÜÊúâÂÖ≥Ë°®ÁöÑ‰∏Ä‰∫õÂÖÉÊï∞ÊçÆÔºåÂÖ∂‰∏≠ÊúÄ‰∏ªË¶ÅÁöÑÂ∞±ÊòØ TableHeapÔºàË∑ØÂæÑÔºöIdentification: src/include/storage/table/table_heap_.hÔºâÔºåTableHeap Ë°®Á§∫Á£ÅÁõò‰∏äÁöÑÁâ©ÁêÜË°®ÔºåÂÆÉÊòØ‰∏Ä‰∏™ÂèåÂêëÈìæË°®ÁöÑÈ°µÈõÜÂêàÔºåÈÄöËøá TableHeap Âç≥ÂèØÂæóÂà∞È¶ñ‰∏™Ë°®È°µÈù¢ TablePage ‰∏≠È¶ñ‰∏™ÂÖÉÁªÑ TupleÔºàÊØè‰∏™ÂÖÉÁªÑÂØπÂ∫îË°®‰∏≠ÁöÑ‰∏ÄË°åÊï∞ÊçÆÔºâÁöÑËø≠‰ª£Âô®Ôºå‰ªéËÄåÂÆûÁé∞Ë°®ÈÅçÂéÜ„ÄÇ</p>
<p>Âª∫ËÆÆÂÖÖÂàÜ‰∫ÜËß£‰∫Ü‰ª•ÂêéÂÜçÂÜô‰ª£Á†Å„ÄÇ</p>
<h3 id="Êï∞ÊçÆÂ∫ìÁªìÊûÑÂõæËØ¶Ëß£Èõ∂Âü∫Á°ÄÂèãÂ•ΩÁâà">Êï∞ÊçÆÂ∫ìÁªìÊûÑÂõæËØ¶Ëß£‚Äî‚ÄîÈõ∂Âü∫Á°ÄÂèãÂ•ΩÁâà
</h3><hr>
<h4 id="‰∏ÄÊï¥‰ΩìÁªìÊûÑÂÉè‰∏ÄÊú¨‰π¶ÁöÑÂõæ‰π¶È¶Ü"><strong>‰∏Ä„ÄÅÊï¥‰ΩìÁªìÊûÑÔºöÂÉè‰∏ÄÊú¨‰π¶ÁöÑÂõæ‰π¶È¶Ü</strong>
</h4><p>ÊÉ≥Ë±°Êï∞ÊçÆÂ∫ìÊòØ‰∏Ä‰∏™Â§ßÂûãÂõæ‰π¶È¶ÜÔºåÊØèÊú¨‰π¶ÂØπÂ∫î‰∏ÄÂº†Ë°®ÔºàTableÔºâÔºåËÄåËøôÂº†ÂõæÂ±ïÁ§∫‰∫ÜÂõæ‰π¶È¶ÜÁöÑÁõÆÂΩïÁ≥ªÁªüÔºàCatalogÔºâ„ÄÅ‰π¶Á±ç‰ø°ÊÅØÂç°ÔºàTable InfoÔºâ„ÄÅ‰π¶Êû∂‰∏äÁöÑ‰π¶ÔºàTable HeapÔºâÂíå‰π¶ÈáåÁöÑÊØè‰∏ÄÈ°µÔºàTable PageÔºâ„ÄÇËÆ©Êàë‰ª¨‰∏ÄÊ≠•Ê≠•ÊãÜËß£Ôºö</p>
<hr>
<h4 id="‰∫åÊ†∏ÂøÉÁªÑ‰ª∂ÈÄêÂ±ÇËß£Êûê"><strong>‰∫å„ÄÅÊ†∏ÂøÉÁªÑ‰ª∂ÈÄêÂ±ÇËß£Êûê</strong>
</h4><h5 id="1-catalogÁõÆÂΩïÂõæ‰π¶È¶ÜÁöÑÊÄªÁõÆÂΩï"><strong>1. CatalogÔºàÁõÆÂΩïÔºâ‚Äî‚ÄîÂõæ‰π¶È¶ÜÁöÑÊÄªÁõÆÂΩï</strong>
</h5><p>‚Ä¢ <strong>‰ΩúÁî®</strong>ÔºöËÆ∞ÂΩïÊï¥‰∏™Êï∞ÊçÆÂ∫ì‰∏≠ÊúâÂì™‰∫õ‚Äú‰π¶‚ÄùÔºàË°®ÔºâÔºåÁõ∏ÂΩì‰∫éÂõæ‰π¶È¶ÜÂÖ•Âè£ÁöÑÊÄªÁõÆÂΩï„ÄÇ
‚Ä¢ <strong>ÂåÖÂê´ÂÜÖÂÆπ</strong>Ôºö
‚Ä¢ ÊØè‰∏™<strong>Ë°®ÁöÑÂîØ‰∏ÄID</strong>ÔºàÁ±ª‰ºº‰π¶ÁöÑÁºñÂè∑ÔºåÂ¶Ç<code>T001</code>Ôºâ„ÄÇ
‚Ä¢ ÊØè‰∏™Ë°®ÂØπÂ∫îÁöÑ<strong>Table Info</strong>Ôºà‰π¶ÁöÑËØ¶ÁªÜ‰ø°ÊÅØÂç°Ôºâ„ÄÇ</p>
<hr>
<h5 id="2-table-infoË°®‰ø°ÊÅØÂç°‰π¶ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ"><strong>2. Table InfoÔºàË°®‰ø°ÊÅØÂç°Ôºâ‚Äî‚Äî‰π¶ÁöÑËØ¶ÁªÜ‰ø°ÊÅØ</strong>
</h5><p>‚Ä¢ <strong>‰ΩúÁî®</strong>ÔºöÊèèËø∞‰∏ÄÂº†Ë°®ÁöÑ‚ÄúÁªìÊûÑËßÑÂàô‚ÄùÔºåÂ∞±ÂÉè‰π¶ÁöÑÂ∞ÅÈù¢ÂíåÁõÆÂΩïÈ°µ„ÄÇ
‚Ä¢ <strong>ÂåÖÂê´ÂÜÖÂÆπ</strong>Ôºö
‚Ä¢ <strong>SchemaÔºàË°®ÁªìÊûÑÔºâ</strong>ÔºöÂÆö‰πâË°®ÁöÑÂàóÂêç„ÄÅÊï∞ÊçÆÁ±ªÂûãÔºàÂ¶ÇÂßìÂêçÊòØÂ≠óÁ¨¶‰∏≤ÔºåÂπ¥ÈæÑÊòØÊï¥Êï∞Ôºâ„ÄÇ
‚Ä¢ <strong>NameÔºàË°®ÂêçÔºâ</strong>Ôºö‰æãÂ¶Ç<code>Áî®Êà∑Ë°®</code>Êàñ<code>ËÆ¢ÂçïË°®</code>„ÄÇ
‚Ä¢ <strong>IDÔºàË°®ÂîØ‰∏ÄÊ†áËØÜÔºâ</strong>Ôºö‰æãÂ¶Ç<code>T001</code>„ÄÇ</p>
<hr>
<h5 id="3-table-heapË°®Â†Ü‰π¶Êû∂‰∏äÁöÑÂ§öÊú¨‰π¶"><strong>3. Table HeapÔºàË°®Â†ÜÔºâ‚Äî‚Äî‰π¶Êû∂‰∏äÁöÑÂ§öÊú¨‰π¶</strong>
</h5><p>‚Ä¢ <strong>‰ΩúÁî®</strong>ÔºöÂÆûÈôÖÂ≠òÊîæË°®ÁöÑÊâÄÊúâÊï∞ÊçÆÔºåÂÉè‰∏Ä‰∏™Ë£ÖÊª°‰π¶ÁöÑ‰π¶Êû∂„ÄÇ
‚Ä¢ <strong>ÁªÑÊàêÊñπÂºè</strong>Ôºö
‚Ä¢ Áî±Â§ö‰∏™<strong>Table PageÔºàË°®È°µÔºâ</strong> ÁªÑÊàêÔºåÊØè‰∏™È°µÂ≠òÂÇ®‰∏ÄÈÉ®ÂàÜÊï∞ÊçÆ„ÄÇ
‚Ä¢ Êï∞ÊçÆÊåâÈ°µÂ†ÜÂè†ÔºåÁ±ª‰ºº‰∫é‰∏ÄÊú¨‰π¶ÁöÑÊØè‰∏ÄÈ°µÊåâÈ°∫Â∫èÂè†Êîæ„ÄÇ</p>
<hr>
<h5 id="4-table-pageË°®È°µ‰π¶‰∏≠ÁöÑ‰∏ÄÈ°µÁ∫∏"><strong>4. Table PageÔºàË°®È°µÔºâ‚Äî‚Äî‰π¶‰∏≠ÁöÑ‰∏ÄÈ°µÁ∫∏</strong>
</h5><p>‚Ä¢ <strong>‰ΩúÁî®</strong>ÔºöÂ≠òÂÇ®ÂÖ∑‰ΩìÊï∞ÊçÆÁöÑÊúÄÂ∞èÂçï‰ΩçÔºåÂÉè‰π¶‰∏≠ÁöÑ‰∏ÄÈ°µÔºåÂÜôÊª°ÂêéÊç¢‰∏ã‰∏ÄÈ°µ„ÄÇ
‚Ä¢ <strong>ËØ¶ÁªÜÁªìÊûÑ</strong>Ôºö
‚Ä¢ <strong>È°µÂ§¥ÔºàHeaderÔºâ</strong>ÔºöËÆ∞ÂΩïÊú¨È°µÁöÑÂÖÉÊï∞ÊçÆÔºö
‚ó¶ <strong>È°µID</strong>ÔºöÂΩìÂâçÈ°µÁöÑÁºñÂè∑ÔºàÂ¶Ç<code>P001</code>Ôºâ„ÄÇ
‚ó¶ <strong>ÂâçÂêéÈ°µID</strong>ÔºöÁ±ª‰ºº‰π¶È°µÁöÑÂâçÂêéÈ°µÁ†ÅÔºå‰æø‰∫éÂø´ÈÄüÁøªÈ°µ„ÄÇ
‚ó¶ <strong>Á©∫Èó≤Á©∫Èó¥</strong>ÔºöÊú¨È°µËøòÂâ©Â§öÂ∞ëÁ©∫ÁôΩÂå∫ÂüüÂèØÂÜôÊï∞ÊçÆ„ÄÇ
‚Ä¢ <strong>ÂÖÉÁªÑÔºàTuplesÔºâ</strong>ÔºöÂÆûÈôÖÂ≠òÂÇ®ÁöÑÊï∞ÊçÆË°åÔºàÁ±ª‰ººË°®Ê†º‰∏≠ÁöÑ‰∏ÄË°åÔºâ„ÄÇ
‚ó¶ ÊØè‰∏™ÂÖÉÁªÑÂåÖÂê´Ôºö
‚ó¶ <strong>RIDÔºàË°åÂîØ‰∏ÄÊ†áËØÜÔºâ</strong>ÔºöÁî±<code>È°µID + ÊßΩÂè∑</code>ÁªÑÊàêÔºåÂÉè‰π¶‰∏≠ÁöÑ‚ÄúÁ¨¨3È°µÁ¨¨5Ë°å‚Äù„ÄÇ
‚ó¶ <strong>Êï∞ÊçÆÂÄº</strong>Ôºö‰æãÂ¶ÇÁî®Êà∑ID‰∏∫<code>1001</code>ÔºåÂßìÂêç‰∏∫<code>Âº†‰∏â</code>„ÄÇ</p>
<hr>
<h4 id="‰∏âÊï∞ÊçÆÂ≠òÂèñÊµÅÁ®ãÁ§∫‰æã"><strong>‰∏â„ÄÅÊï∞ÊçÆÂ≠òÂèñÊµÅÁ®ãÁ§∫‰æã</strong>
</h4><p>‰ª•Êü•ËØ¢Áî®Êà∑<code>Âº†‰∏â</code>‰∏∫‰æãÔºö</p>
<ol>
<li><strong>Êü•ÁõÆÂΩï</strong>ÔºöÈÄöËøáCatalogÊâæÂà∞<code>Áî®Êà∑Ë°®</code>ÁöÑIDÔºàÂ¶Ç<code>T001</code>Ôºâ„ÄÇ</li>
<li><strong>ËØªË°®‰ø°ÊÅØ</strong>ÔºöÊ†πÊçÆTable InfoÂæóÁü•Áî®Êà∑Ë°®Êúâ<code>ID„ÄÅÂßìÂêç„ÄÅÂπ¥ÈæÑ</code>‰∏âÂàó„ÄÇ</li>
<li><strong>ÊâæÊï∞ÊçÆ‰ΩçÁΩÆ</strong>ÔºöËøõÂÖ•Table HeapÔºåÊåâÈ°µIDÈÄêÈ°µÊâ´ÊèèÔºàÁ±ª‰ººÁøª‰π¶Ôºâ„ÄÇ</li>
<li><strong>ÂÆö‰ΩçÂÖ∑‰ΩìË°å</strong>ÔºöÂú®Êüê‰∏™Table Page‰∏≠ÊâæÂà∞RID‰∏∫<code>P003-S05</code>ÁöÑÂÖÉÁªÑÔºåËØªÂèñ<code>Âº†‰∏â</code>ÁöÑÊï∞ÊçÆ„ÄÇ</li>
</ol>
<hr>
<h4 id="ÂõõÂÖ≥ÈîÆÊ¶ÇÂøµÊÄªÁªì"><strong>Âõõ„ÄÅÂÖ≥ÈîÆÊ¶ÇÂøµÊÄªÁªì</strong>
</h4><div class="table-wrapper"><table>
  <thead>
      <tr>
          <th><strong>ÁªÑ‰ª∂</strong></th>
          <th><strong>Á±ªÊØî</strong></th>
          <th><strong>Ê†∏ÂøÉ‰ΩúÁî®</strong></th>
          <th><strong>Á§∫‰æã</strong></th>
      </tr>
  </thead>
  <tbody>
      <tr>
          <td><strong>Catalog</strong></td>
          <td>Âõæ‰π¶È¶ÜÊÄªÁõÆÂΩï</td>
          <td>ÁÆ°ÁêÜÊâÄÊúâË°®ÁöÑÂü∫Êú¨‰ø°ÊÅØ</td>
          <td>ËÆ∞ÂΩïÊúâ<code>Áî®Êà∑Ë°®(T001)</code>Âíå<code>ËÆ¢ÂçïË°®(T002)</code></td>
      </tr>
      <tr>
          <td><strong>Table Info</strong></td>
          <td>‰π¶Á±ç‰ø°ÊÅØÂç°</td>
          <td>ÂÆö‰πâË°®ÁöÑÁªìÊûÑËßÑÂàô</td>
          <td>Áî®Êà∑Ë°®ÂåÖÂê´<code>ID(int)„ÄÅÂßìÂêç(varchar)</code></td>
      </tr>
      <tr>
          <td><strong>Table Heap</strong></td>
          <td>‰π¶Êû∂‰∏äÁöÑ‰π¶</td>
          <td>Â≠òÂÇ®Ë°®ÁöÑÊâÄÊúâÊï∞ÊçÆ</td>
          <td>Áî®Êà∑Ë°®Êï∞ÊçÆÂàÜÂ∏ÉÂú®100‰∏™Table Page‰∏≠</td>
      </tr>
      <tr>
          <td><strong>Table Page</strong></td>
          <td>‰π¶‰∏≠ÁöÑ‰∏ÄÈ°µ</td>
          <td>Â≠òÂÇ®ÂÖ∑‰ΩìÊï∞ÊçÆÁöÑÊúÄÂ∞èÂçïÂÖÉ</td>
          <td>È°µ<code>P003</code>Â≠òÂÇ®‰∫ÜÁî®Êà∑<code>Âº†‰∏â</code>ÁöÑÊï∞ÊçÆ</td>
      </tr>
  </tbody>
</table></div>
<hr>
<h4 id="‰∫îÊñ∞ÊâãÂ∏∏ËßÅÁñëÈóÆËß£Á≠î"><strong>‰∫î„ÄÅÊñ∞ÊâãÂ∏∏ËßÅÁñëÈóÆËß£Á≠î</strong>
</h4><ol>
<li>
<p><strong>‰∏∫‰ªÄ‰πàÂàÜËøô‰πàÂ§öÂ±ÇÔºü</strong><br>
‚Ä¢ <strong>Ëß£ËÄ¶ËÆæËÆ°</strong>ÔºöÁõÆÂΩï„ÄÅÁªìÊûÑ„ÄÅÊï∞ÊçÆÂàÜÁ¶ªÔºå‰æø‰∫éÂçïÁã¨ÁÆ°ÁêÜÔºàÂ¶Ç‰øÆÊîπË°®ÁªìÊûÑ‰∏çÂΩ±ÂìçÂ∑≤ÊúâÊï∞ÊçÆÔºâ„ÄÇ
‚Ä¢ <strong>È´òÊïàÊü•ËØ¢</strong>ÔºöÈÄöËøáÁõÆÂΩïÂø´ÈÄüÂÆö‰ΩçÔºåÈÅøÂÖçÂÖ®ÁõòÊâ´Êèè„ÄÇ</p>
</li>
<li>
<p><strong>ÂÖÉÁªÑÔºàTupleÔºâÂíåË°åÔºàRowÔºâÁöÑÂå∫Âà´Ôºü</strong><br>
‚Ä¢ Âú®Êï∞ÊçÆÂ∫ì‰∏≠‰∫åËÄÖÈÄöÂ∏∏Á≠â‰ª∑Ôºå‰ΩÜÂÖÉÁªÑÊõ¥Âº∫Ë∞É‚Äú‰∏çÂèØÂèòÁöÑÊï∞ÊçÆÈõÜÂêà‚Äù„ÄÇ</p>
</li>
<li>
<p><strong>È°µ‰∏∫‰ªÄ‰πàË¶ÅËÆ∞ÂΩïÂâçÂêéÈ°µIDÔºü</strong><br>
‚Ä¢ ÊîØÊåÅÈ°∫Â∫èÈÅçÂéÜÔºàÂ¶ÇÁøªÈ°µÊü•ËØ¢ÔºâÔºå‰πü‰æø‰∫éÊèíÂÖ•Êñ∞È°µÊó∂Áª¥Êä§ÈìæË°®ÂÖ≥Á≥ª„ÄÇ</p>
</li>
</ol>
<hr>
<p>ÈÄöËøáËøô‰∏™ÁªìÊûÑÔºåÊï∞ÊçÆÂ∫ìÂÉèÂõæ‰π¶È¶Ü‰∏ÄÊ†∑<strong>Â±ÇÊ¨°Ê∏ÖÊô∞„ÄÅÈ´òÊïàÁÆ°ÁêÜÊµ∑ÈáèÊï∞ÊçÆ</strong>„ÄÇÁêÜËß£Ëøô‰∫õÂü∫Á°ÄÊ¶ÇÂøµÂêéÔºåÂêéÁª≠Â≠¶‰π†Á¥¢Âºï„ÄÅ‰∫ãÂä°Á≠âÈ´òÁ∫ßÁâπÊÄß‰ºöÊõ¥ËΩªÊùæÔºÅ</p>
<h2 id="‰ªªÂä°-1---ËÆøÈóÆÊñπÊ≥ïÊâßË°åÁ®ãÂ∫è">‰ªªÂä° #1 - ËÆøÈóÆÊñπÊ≥ïÊâßË°åÁ®ãÂ∫è
</h2><p>Âú®Ê≠§‰ªªÂä°‰∏≠ÔºåÊÇ®Â∞ÜÂÆûÁé∞ÂØπÂ≠òÂÇ®Á≥ªÁªü‰∏≠ÁöÑË°®ËøõË°åËØªÂèñÂíåÂÜôÂÖ•ÁöÑÊâßË°åÁ®ãÂ∫è„ÄÇÊÇ®Â∞ÜÂú®‰ª•‰∏ãÊñá‰ª∂‰∏≠ÂÆåÊàêÂÆûÊñΩÔºö</p>
<ul>
<li><code>src/include/execution/seq_scan_executor.h</code></li>
<li><code>src/execution/seq_scan_executor.cpp</code></li>
<li><code>src/include/execution/insert_executor.h</code></li>
<li><code>src/execution/insert_executor.cpp</code></li>
<li><code>src/include/execution/update_executor.h</code></li>
<li><code>src/execution/update_executor.cpp</code></li>
<li><code>src/include/execution/delete_executor.h</code></li>
<li><code>src/execution/delete_executor.cpp</code></li>
<li><code>src/include/execution/index_scan_executor.h</code></li>
<li><code>src/execution/index_scan_executor.cpp</code></li>
<li><code>src/optimizer/seqscan_as_indexscan.cpp</code></li>
</ul>
<p><strong>1 SeqScan</strong>
<strong>1.1 ÊÄùË∑Ø</strong>
Init ÊñπÊ≥ïÈ¶ñÂÖàËé∑ÂèñË¶ÅÊâ´ÊèèÁöÑË°®ÁöÑÂ†ÜÔºàtable_heap_ÔºâÔºåÁÑ∂ÂêéÂàõÂª∫‰∏Ä‰∏™Ëø≠‰ª£Âô® iterÊù•ÈÅçÂéÜËøô‰∏™Â†Ü„ÄÇÂÆÉÈÅçÂéÜÂ†Ü‰∏≠ÁöÑÊâÄÊúâËÆ∞ÂΩïÔºåÂπ∂Â∞ÜÂÆÉ‰ª¨ÁöÑËÆ∞ÂΩïÊ†áËØÜÁ¨¶ÔºàRIDÔºâÂ≠òÂÇ®Âú®rids_ÂàóË°®‰∏≠„ÄÇÊúÄÂêéÔºåÂÆÉÂ∞Ürid_iter_ËÆæÁΩÆ‰∏∫rids_ÂàóË°®ÁöÑËµ∑Âßã‰ΩçÁΩÆ„ÄÇ
NextÊñπÊ≥ïÁî®‰∫é‰ªéË°®‰∏≠Ê£ÄÁ¥¢‰∏ã‰∏Ä‰∏™Êª°Ë∂≥Êù°‰ª∂ÁöÑÂÖÉÁªÑ„ÄÇÂÆÉ‰ΩøÁî®‰∏Ä‰∏™do-whileÂæ™ÁéØÊù•ÈÅçÂéÜrids_ ÂàóË°®‰∏≠ÁöÑ RID„ÄÇÂØπ‰∫éÊØè‰∏™ RIDÔºåÂÆÉÈ¶ñÂÖàËé∑ÂèñËØ• RID ÂØπÂ∫îÁöÑÂÖÉÁªÑÁöÑÂÖÉÊï∞ÊçÆÔºàTupleMetaÔºâ„ÄÇÂ¶ÇÊûúËØ•ÂÖÉÁªÑÊ≤°ÊúâË¢´Âà†Èô§Ôºà!meta.is_deleted_ÔºâÔºåÂàôÂ∞ÜËØ•ÂÖÉÁªÑÂ§çÂà∂Âà∞‰º†ÂÖ•ÁöÑ tupleÂèÇÊï∞‰∏≠ÔºåÂπ∂Â∞Ü RID Â§çÂà∂Âà∞ridÂèÇÊï∞‰∏≠„ÄÇ
ÁÑ∂ÂêéÔºåÂÆÉÊ£ÄÊü•ÊòØÂê¶ÊúâËøáÊª§Êù°‰ª∂Ôºàplan_-&gt;filter_predicate_Ôºâ„ÄÇÂ¶ÇÊûúÊúâÔºåÂÆÉ‰ºöËØÑ‰º∞Ëøô‰∏™ËøáÊª§Êù°‰ª∂ÔºåÂπ∂Ê£ÄÊü•ÁªìÊûúÊòØÂê¶‰∏∫ true„ÄÇÂè™ÊúâÂΩìÂÖÉÁªÑÊ≤°ÊúâË¢´Âà†Èô§‰∏îÊª°Ë∂≥ËøáÊª§Êù°‰ª∂Êó∂Ôºådo-while Âæ™ÁéØÊâç‰ºöÁªìÊùü„ÄÇ</p>
<p><strong>1.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** The sequential scan plan node to be executed */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Ë¶ÅÊâßË°åÁöÑÈ°∫Â∫èÊâ´ÊèèËÆ°ÂàíËäÇÁÇπ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">SeqScanPlanNode</span> <span class="o">*</span><span class="n">plan_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">TableInfo</span> <span class="o">*</span><span class="n">table_info_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">TableHeap</span> <span class="o">*</span><span class="n">table_heap_</span><span class="p">;</span>  <span class="c1">//Ë°®Â†ÜÊòØË°®Á§∫Áâ©ÁêÜË°®Âú®Á£ÅÁõò‰∏äÁöÑÂ≠òÂÇ®ÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RID</span><span class="o">&gt;</span> <span class="n">rids_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RID</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">rids_iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">// ÊûÑÈÄ†ÂáΩÊï∞,ÂàùÂßãÂåñÈ°∫Â∫èÊâ´ÊèèÊâßË°åÂô®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SeqScanExecutor</span><span class="o">::</span><span class="n">SeqScanExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">SeqScanPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">),</span> <span class="n">plan_</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span> <span class="p">{}</span><span class="c1">// exec_ctxÔºöÊâßË°å‰∏ä‰∏ãÊñáÔºàÂåÖÂê´‰∫ãÂä°„ÄÅÁõÆÂΩïÁ≠âÔºâ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// planÔºöÈ°∫Â∫èÊâ´ÊèèËÆ°ÂàíËäÇÁÇπÔºàÂåÖÂê´Ë¶ÅÊâ´ÊèèÁöÑË°®ID„ÄÅËøáÊª§Êù°‰ª∂Á≠âÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ÂáÜÂ§áÊâ´ÊèèÊâÄÈúÄÁöÑÊï∞ÊçÆÁªìÊûÑ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂÖàËé∑ÂèñË°®ÁöÑ‰ø°ÊÅØÔºàÂà∞table_heap_Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Êî∂ÈõÜÊâÄÊúâÁöÑRIDÔºàauto iter = table_heap_-&gt;MakeIterator();Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÊâÄÊúâË°åÁöÑ RIDÔºàË°åÊ†áËØÜÁ¨¶ÔºâÂ≠òÂÖ• rids_ ÂàóË°®
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñËø≠‰ª£Âô®,rids_iter_ ÊåáÂêë RID ÂàóË°®ÁöÑËµ∑Âßã‰ΩçÁΩÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">SeqScanExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> <span class="c1">//{ throw NotImplementedException(&#34;SeqScanExecutor is not implemented&#34;); }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÈÄöËøáÁõÆÂΩïÔºàCatalogÔºâÊ†πÊçÆË°®OIDËé∑ÂèñË°®ÁöÑÂÖÉÊï∞ÊçÆÔºàÂ¶Ç Schema„ÄÅÊï∞ÊçÆÂ≠òÂÇ®‰ΩçÁΩÆÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÁõÆÂâçÊàëÁöÑÁêÜËß£ÊòØËé∑ÂèñË°®ÁöÑÊâÄÊúâ‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">table_info_</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTable</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetTableOid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// table_heap_ ÊòØÂÆûÈôÖÂ≠òÂÇ®Ë°®Êï∞ÊçÆÁöÑÁªìÊûÑÔºàÁ±ª‰ºº‰∏Ä‰∏™Êï∞ÁªÑÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÁõÆÂâçÊàëÁöÑÁêÜËß£ÊòØÂ∞ÜË°®ÂÜÖÁöÑÊï∞ÊçÆÈÉ®ÂàÜÈÉΩÊèêÂèñÂá∫Êù•,Ëé∑ÂèñÊâÄÊúâÁöÑË°®È°µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">table_heap_</span> <span class="o">=</span> <span class="n">table_info_</span><span class="o">-&gt;</span><span class="n">table_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Êî∂ÈõÜÊâÄÊúâ RIDÔºöÔºàË°åÊ†áËØÜÁ¨¶Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">iter</span> <span class="o">=</span> <span class="n">table_heap_</span><span class="o">-&gt;</span><span class="n">MakeIterator</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">rids_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>  
</span></span><span class="line"><span class="cl">    <span class="c1">//iter ÊòØË°®Â†ÜÁöÑËø≠‰ª£Âô®ÔºåÁî®‰∫éÈÅçÂéÜË°®‰∏≠ÊØè‰∏ÄË°å„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Âæ™ÁéØÂ∞ÜÊâÄÊúâË°åÁöÑ RIDÔºàË°åÊ†áËØÜÁ¨¶ÔºâÂ≠òÂÖ• rids_ ÂàóË°®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">iter</span><span class="p">.</span><span class="n">IsEnd</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">rids_</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">iter</span><span class="p">.</span><span class="n">GetRID</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">iter</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàùÂßãÂåñËø≠‰ª£Âô®,rids_iter_ ÊåáÂêë RID ÂàóË°®ÁöÑËµ∑Âßã‰ΩçÁΩÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rids_iter_</span> <span class="o">=</span> <span class="n">rids_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// Ëé∑Âèñ‰∏ã‰∏ÄË°åÊï∞ÊçÆÔºåË∑≥ËøáË¢´Âà†Èô§ÁöÑË°åÂíå‰∏çÁ¨¶ÂêàËøáÊª§Êù°‰ª∂ÁöÑË°å„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â¶ÇÊûú RID Ëø≠‰ª£Âô®Âà∞ËææÊú´Â∞æÔºåËøîÂõû falseÔºåÂê¶ÂàôÁªßÁª≠
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈÄöËøárids_iter_Âú®table_heap_‰∏≠Ëé∑ÂèñÂÖÉÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ê£ÄÊü•ÂΩìÂâçË°åÊòØÂê¶Ë¢´Âà†Èô§
</span></span></span><span class="line"><span class="cl"><span class="cm">		Ëã•Êú™Âà†Èô§ÔºåÂ∞ÜÂΩìÂâçË°åÁöÑÊï∞ÊçÆÂíå RID ËµãÂÄºÁªôËæìÂá∫ÂèÇÊï∞ÔºåÁÑ∂ÂêéÈÄÄÂá∫Âæ™ÁéØ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Âê¶ÂàôÔºåË¢´Âà†Èô§ÊàñËÄÖ‰∏çÁ¨¶ÂêàËøáÊª§Êù°‰ª∂ÁöÑÊÉÖÂÜµ‰∏ã‰ºöÁªßÁª≠ËøõË°åÂæ™ÁéØ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">SeqScanExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span><span class="c1">// { return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TupleMeta</span> <span class="n">meta</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ‚ÄãÁªàÊ≠¢Êù°‰ª∂ÔºöÂ¶ÇÊûú RID Ëø≠‰ª£Âô®Âà∞ËææÊú´Â∞æÔºåËøîÂõû falseÔºàÊó†Êõ¥Â§öÊï∞ÊçÆÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">rids_iter_</span> <span class="o">==</span> <span class="n">rids_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="n">meta</span> <span class="o">=</span> <span class="n">table_heap_</span><span class="o">-&gt;</span><span class="n">GetTupleMeta</span><span class="p">(</span><span class="o">*</span><span class="n">rids_iter_</span><span class="p">);</span><span class="c1">// Ëé∑ÂèñÂÖÉÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Ê£ÄÊü•ÂΩìÂâçË°åÊòØÂê¶Ë¢´Âà†Èô§Ôºàmeta.is_deleted_Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">meta</span><span class="p">.</span><span class="n">is_deleted_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//Ëã•Êú™Âà†Èô§ÔºåÂ∞ÜÂΩìÂâçË°åÁöÑÊï∞ÊçÆÂíå RID ËµãÂÄºÁªôËæìÂá∫ÂèÇÊï∞„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">table_heap_</span><span class="o">-&gt;</span><span class="n">GetTuple</span><span class="p">(</span><span class="o">*</span><span class="n">rids_iter_</span><span class="p">).</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">rid</span> <span class="o">=</span> <span class="o">*</span><span class="n">rids_iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">rids_iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="n">is_deleted_</span> <span class="o">||</span> <span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">filter_predicate_</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span><span class="c1">// meta.is_deletedÊó∂ÁªßÁª≠Âæ™ÁéØ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Evaluate ÊñπÊ≥ïÊ†πÊçÆË°®ÁöÑ Schema ËÆ°ÁÆóÊù°‰ª∂Ë°®ËææÂºèÁöÑÁªìÊûú„ÄÇÔºàÊàëËÆ§‰∏∫ÂÖ∂ÂÆûÂ∞±ÊòØ‰∏çÁ¨¶ÂêàËøáÊª§Êù°‰ª∂Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="o">!</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">filter_predicate_</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="n">table_info_</span><span class="o">-&gt;</span><span class="n">schema_</span><span class="p">).</span><span class="n">GetAs</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2 Insert</strong>
<strong>2.1 ÊÄùË∑Ø</strong>
Ë¶ÅÊ±ÇÔºö ÊâßË°åÂô®ÁîüÊàê‰∏Ä‰∏™Êï¥Êï∞Á±ªÂûãÁöÑÂÖÉÁªÑ‰Ωú‰∏∫ËæìÂá∫ÔºåÂπ∂ÊåáÁ§∫ÊúâÂ§öÂ∞ëË°åÂ∑≤ÁªèË¢´ÊèíÂÖ•Âà∞Ë°®‰∏≠„ÄÇÂΩìÂêëË°®‰∏≠ÊèíÂÖ•Êï∞ÊçÆÊó∂ÔºåÂ¶ÇÊûúË°®ÊúâÂÖ≥ËÅîÁöÑÁ¥¢ÂºïÔºåËØ∑ËÆ∞ÂæóÊõ¥Êñ∞Ëøô‰∫õÁ¥¢Âºï„ÄÇ
ÊÄùË∑ØÔºöÊääË¶ÅÊèíÂÖ•ÁöÑÂÜÖÂÆπÊîæÂú®Â≠êÊâßË°åÂô® child_executor_‰∏≠ÔºåÁÑ∂ÂêéËé∑Âèñ‰∏Ä‰∫õÂøÖË¶ÅÂèÇÊï∞ÔºåÂÖ∂‰∏≠ÊèíÂÖ•Âà∞Ë°®‰∏≠ÁöÑË°åÊï∞ÁöÑÊï¥Êï∞ÂÖÉÁªÑ ÂíåÊèíÂÖ•Êìç‰Ωú‰∫ßÁîüÁöÑ‰∏ã‰∏Ä‰∏™ÂÖÉÁªÑRIDÂ∑≤ÁªèÁªôÂá∫‰∫Ü„ÄÇÁî®whileËØ≠Âè•ÊääÂ≠êÊâßË°åÂô®‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁªÑÈÉΩÊèíËøõÂéªÔºàËøòÊúâÊõ¥Êñ∞Á¥¢ÂºïÔºâÔºåÊúÄÂêéÁÆó‰∏ã‰∏ÄÂÖ±ÊèíÂÖ•Â§öÂ∞ëË°å</p>
<p><strong>2.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** The insert plan node to be executed*/</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Ë¶ÅÊâßË°åÁöÑÊèíÂÖ•ËÆ°ÂàíËäÇÁÇπ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">InsertPlanNode</span> <span class="o">*</span><span class="n">plan_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">///////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ‰ªé‰∏≠Ëé∑ÂèñÂÖÉÁªÑÁöÑÂ≠êÊâßË°åÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">child_executor_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** Next()‰πãÂâçÊòØÂê¶Ë¢´Ë∞ÉÁî®Ëøá */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">called_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">///////////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span><span class="lnt">86
</span><span class="lnt">87
</span><span class="lnt">88
</span><span class="lnt">89
</span><span class="lnt">90
</span><span class="lnt">91
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">// ÂàùÂßãÂåñÊèíÂÖ•ÊâßË°åÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">InsertExecutor</span><span class="o">::</span><span class="n">InsertExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">InsertPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">child_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">),</span> <span class="n">plan_</span><span class="p">(</span><span class="n">plan</span><span class="p">),</span> <span class="n">child_executor_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">child_executor</span><span class="p">))</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//child_executorÔºöÂ≠êÊâßË°åÂô®ÔºàÂ¶Ç ValuesExecutorÔºåÁî®‰∫éÊèê‰æõÂæÖÊèíÂÖ•ÁöÑÊï∞ÊçÆÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñÂ≠êÊâßË°åÂô®,ËÆ©ÂÖ∂ÂáÜÂ§áÂ•ΩÂæÖÊèíÂÖ•ÁöÑÊï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">	 ÂàùÂßãÂåñcalled_ = false;Ë°®Á§∫ÁõÆÂâçÊ≤°Ë¢´Ë∞ÉÁî®Ëøá
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">InsertExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÂàùÂßãÂåñÂ≠êÊâßË°åÂô®Ôºö‰æãÂ¶ÇÔºåÂ¶ÇÊûúÂ≠êÊâßË°åÂô®ÊòØ ValuesExecutorÔºåÂÆÉ‰ºöÂáÜÂ§áÂ•ΩÂæÖÊèíÂÖ•ÁöÑÊï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">called_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">// Ë°®Á§∫ÁõÆÂâçÊ≤°Ë¢´Ë∞ÉÁî®Ëøá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñË°®„ÄÅ‰∫ãÂä°„ÄÅÁ¥¢Âºï‰ø°ÊÅØ„Äêtx„ÄÅtable_heap„ÄÅindex_info_vector„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	Âæ™ÁéØËØªÂèñÂ≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Ëé∑ÂèñË¶ÅÊèíÂÖ•ÁöÑÊï∞ÊçÆÂíåÁõ∏Â∫îÁöÑË°åÊï∞
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÊèíÂÖ•ÂÖÉÁªÑÂà∞Ë°®
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â§ÑÁêÜ RIDÔºàË°åÊ†áËØÜÁ¨¶Ôºâ„ÄêÂ¶ÇÊûúÊèíÂÖ•ÁöÑÊï∞ÊçÆÊ≤°ÊúâRIDÔºåÂàôËá™Âä®ÁîüÊàê‰∏Ä‰∏™Êñ∞ÁöÑRIDÔºåÊèíÂÖ•ËøõÂéª„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â∞ÜÊèíÂÖ•ÁöÑÊï∞ÊçÆÂêåÊ≠•Êõ¥Êñ∞Âà∞ÊâÄÊúâÂÖ≥ËÅîÁ¥¢ÂºïÔºàÂ¶Ç B+Ê†ëÁ¥¢ÂºïÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÁªüËÆ°ÊèíÂÖ•Ë°åÊï∞ÔºåÈáçÁΩÆ RID
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÁªßÁª≠Âæ™ÁéØÔºåÁü•ÈÅìË¶ÅÊèíÂÖ•ÁöÑÊï∞ÊçÆÈÉΩÂ§ÑÁêÜÂÆå
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÊûÑÈÄ†ËøîÂõûÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÊèíÂÖ•Ë°åÊï∞‰Ωú‰∏∫ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÊéßÂà∂ËøîÂõûÂÄºÔºåÂà§Êñ≠ËøîÂõûtureËøòÊòØfalse
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">InsertExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="na">[[maybe_unused]]</span> <span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// 1. Ëé∑ÂèñË°®„ÄÅ‰∫ãÂä°„ÄÅÁ¥¢Âºï‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TableInfo</span> <span class="o">*</span><span class="n">table_info</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTable</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetTableOid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">Transaction</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTransaction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">TableHeap</span> <span class="o">*</span><span class="n">table_heap</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">-&gt;</span><span class="n">table_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IndexInfo</span> <span class="o">*&gt;</span> <span class="n">index_info_vector</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTableIndexes</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">name_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 2. Âæ™ÁéØËØªÂèñÂ≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Tuple</span> <span class="n">child_tuple</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_tuple</span><span class="p">,</span> <span class="n">rid</span><span class="p">))</span> <span class="p">{</span><span class="c1">//Ëé∑ÂèñË¶ÅÊèíÂÖ•ÁöÑÊï∞ÊçÆÂíåÁõ∏Â∫îÁöÑË°åÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// 3. ÊèíÂÖ•ÂÖÉÁªÑÂà∞Ë°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// ÂÖÉÁªÑÂÖÉÊï∞ÊçÆÔºåÂåÖÂê´‰∫ãÂä°Êó∂Èó¥Êà≥Ôºàtx-&gt;GetTransactionTempTs()ÔºâÂíåÂà†Èô§Ê†áËÆ∞Ôºàfalse Ë°®Á§∫Êú™Âà†Èô§Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// ÂæÖÊèíÂÖ•ÁöÑÊï∞ÊçÆË°å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// ÈîÅÁÆ°ÁêÜÂô®ÔºåÁî®‰∫éÂπ∂ÂèëÊéßÂà∂ÔºàÂ¶ÇË°åÁ∫ßÈîÅÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>         <span class="c1">// ‰∫ãÂä°ÂØπË±°ÔºåËÆ∞ÂΩïÊìç‰ΩúÊó•ÂøóÔºàÂ¶Ç undo log Âíå redo logÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">rid_optional</span> <span class="o">=</span> <span class="n">table_heap</span><span class="o">-&gt;</span><span class="n">InsertTuple</span><span class="p">(</span><span class="n">TupleMeta</span><span class="p">{</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">GetTransactionTempTs</span><span class="p">(),</span> <span class="nb">false</span><span class="p">},</span> <span class="n">child_tuple</span><span class="p">,</span><span class="c1">//Ë¶ÅÊèíÂÖ•ÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                  <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetLockManager</span><span class="p">(),</span> <span class="n">tx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// 4. Â§ÑÁêÜ RIDÔºàË°åÊ†áËØÜÁ¨¶Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="c1">//‚ÄãÊù°‰ª∂ÔºöÂ¶ÇÊûúÂéüÂßã rid ÊòØÁ©∫ÂÄºÔºàÈªòËÆ§ÊûÑÈÄ†ÁöÑ RID()ÔºâÔºå‰∏îÊèíÂÖ•Êìç‰ΩúËøîÂõû‰∫Ü‰∏Ä‰∏™ÊúâÊïàÁöÑ RIDÔºàrid_optional.has_value() ‰∏∫ trueÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//‚ÄãÊìç‰ΩúÔºöÂ∞ÜÊèíÂÖ•ÂêéÁîüÊàêÁöÑÊñ∞ RIDÔºàrid_optional.value()ÔºâËµãÂÄºÁªôÂéüÂßã rid ÊåáÈíà„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">rid</span> <span class="o">==</span> <span class="n">RID</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">rid_optional</span><span class="p">.</span><span class="n">has_value</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">rid</span> <span class="o">=</span> <span class="n">rid_optional</span><span class="p">.</span><span class="n">value</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 5. Â∞ÜÊèíÂÖ•ÁöÑÊï∞ÊçÆÂêåÊ≠•Êõ¥Êñ∞Âà∞ÊâÄÊúâÂÖ≥ËÅîÁ¥¢ÂºïÔºàÂ¶Ç B+Ê†ëÁ¥¢ÂºïÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//‰ªéÊï∞ÊçÆË°å‰∏≠ÊèêÂèñÁ¥¢ÂºïÈîÆÔºàÂ¶ÇÁî®Êà∑IDÔºâÔºåÂü∫‰∫éË°®Ê®°ÂºèÔºàtable_info-&gt;schema_ÔºâÂíåÁ¥¢ÂºïÈîÆÂÆö‰πâÔºàindex_info-&gt;key_schema_Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//Êñ∞ÊèíÂÖ•Ë°åÁöÑÁâ©ÁêÜÂú∞ÂùÄÔºåÁî®‰∫éÁ¥¢ÂºïÈîÆÂà∞Êï∞ÊçÆÁöÑÊò†Â∞Ñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ‰∫ãÂä°ÂØπË±°ÔºåËÆ∞ÂΩïÁ¥¢ÂºïÊìç‰ΩúÁöÑÊó•ÂøóÔºàÂ¶Ç redo logÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">index_info</span> <span class="p">:</span> <span class="n">index_info_vector</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">InsertEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">child_tuple</span><span class="p">.</span><span class="n">KeyFromTuple</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">schema_</span><span class="p">,</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">key_schema_</span><span class="p">,</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">GetKeyAttrs</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">rid</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span><span class="c1">// Ë°åÊ†áËØÜÁ¨¶Ôºå‰∫ãÂä°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">      <span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="c1">// ÁªüËÆ°ÊèíÂÖ•Ë°åÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">*</span><span class="n">rid</span> <span class="o">=</span> <span class="n">RID</span><span class="p">();</span><span class="c1">// ÈáçÁΩÆ RID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 6. ÊûÑÈÄ†ËøîÂõûÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊèíÂÖ•Ë°åÊï∞‰Ωú‰∏∫ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// 7. ÊéßÂà∂ËøîÂõûÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1">//   Âú®Êï∞ÊçÆÂ∫ìÊâßË°åÂô®ÔºàÂ¶ÇInsertExecutorÔºâ‰∏≠ÔºåNext()ÊñπÊ≥ïÈÄöÂ∏∏ÈááÁî®Ëø≠‰ª£Âô®Ê®°ÂºèËÆæËÆ°ÔºåÈúÄË¶ÅÊòéÁ°Æ‰∏§ÁßçÁä∂ÊÄÅÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">// ËøîÂõûtrueÔºöË°®Á§∫‚ÄúÂ∑≤Â§ÑÁêÜÂÆåÊàê‚ÄùÔºàÊó†ËÆ∫ÊòØÂê¶ÂÆûÈôÖÊâßË°åÊìç‰ΩúÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãËøîÂõûfalseÔºöË°®Á§∫‚ÄúÊó†Êõ¥Â§öÊï∞ÊçÆÈúÄÂ§ÑÁêÜ‚Äù„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">called_</span><span class="p">)</span> <span class="p">{</span><span class="c1">//ËøôÈáåÊàëËÆ§‰∏∫ÁõÆÁöÑÊòØ‰∏∫‰∫Ü‰ΩøÂæóÊèíÂÖ•0Ë°åÁöÑÊÉÖÂÜµÂèØ‰ª•ÈÄöËøáÔºå‰∏çÁÑ∂Â∞±‰ºöÈªòËÆ§‰∏çÊèíÂÖ•‰∫Ü„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                <span class="c1">//ÂΩìÁÑ∂ÊàëÁü•ÈÅì‰ª•‰∏äÁåúÊµã‰∏çÂØπÂä≤ÔºåÂ§ßÊ¶ÇÁéáÂ∫îËØ•ÊòØ‰∏∫‰∫ÜNEXTÔºàÔºâÂàùÂßãÂåñÁî®ÁöÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">called_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span><span class="c1">// ÊèíÂÖ• 0 Ë°å‰∏î‰ª•ÂâçÊ≤°Ë¢´Ë∞ÉÁî®ËøáÊó∂ËøîÂõû true ‰∏ÄÊ¨°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">called_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// ÊèíÂÖ•Ë°åÊï∞ &gt;0 Êó∂ËøîÂõû true ‰∏ÄÊ¨°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3 UpDate</strong>
<strong>3.1 ÊÄùË∑Ø</strong>
Ë¶ÅÊ±ÇÔºöÊâßË°åÂô®Â∞ÜËæìÂá∫‰∏Ä‰∏™Êï¥Êï∞Á±ªÂûãÁöÑÂÖÉÁªÑÔºåË°®Á§∫Â∑≤Êõ¥Êñ∞ÁöÑË°åÊï∞„ÄÇ
ÊÄùË∑ØÔºö Êõ¥Êñ∞ÈÄªËæëÊòØÊääÂéüÊù•ÁöÑÂÖÉÁªÑËÆæÁΩÆ‰∏∫Â∑≤Âà†Èô§ÔºåÁÑ∂ÂêéÊèíÂÖ•Êñ∞ÁöÑÂÖÉÁªÑ„ÄÇ</p>
<p><strong>3.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** The update plan node to be executed */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Ë¶ÅÊâßË°åÁöÑÊõ¥Êñ∞ËÆ°ÂàíËäÇÁÇπ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">UpdatePlanNode</span> <span class="o">*</span><span class="n">plan_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/** Metadata identifying the table that should be updated */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Ê†áËØÜÂ∫îËØ•Êõ¥Êñ∞ÁöÑË°®ÁöÑÂÖÉÊï∞ÊçÆ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">TableInfo</span> <span class="o">*</span><span class="n">table_info_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/** The child executor to obtain value from */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** ‰ªé‰∏≠Ëé∑ÂèñÂÄºÁöÑÂ≠êÊâßË°åÂô® */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">child_executor_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">is_end_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// ÂàùÂßãÂåñÊõ¥Êñ∞ÊâßË°åÂô®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// , plan_{plan}, child_executor_{std::move(child_executor)}
</span></span></span><span class="line"><span class="cl"><span class="c1">//child_executorÔºöÂ≠êÊâßË°åÂô®ÔºåÊèê‰æõÂæÖÊõ¥Êñ∞ÁöÑÊï∞ÊçÆÔºà‰æãÂ¶ÇÈÄöËøá WHERE Êù°‰ª∂Á≠õÈÄâÂá∫ÁöÑÊï∞ÊçÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">UpdateExecutor</span><span class="o">::</span><span class="n">UpdateExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">UpdatePlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">child_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">)</span> <span class="p">,</span> <span class="n">plan_</span><span class="p">{</span><span class="n">plan</span><span class="p">},</span> <span class="n">child_executor_</span><span class="p">{</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">child_executor</span><span class="p">)}{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// As of Fall 2022, you DON&#39;T need to implement update executor to have perfect score in project 3 / project 4.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Êà™Ëá≥ 2022 Âπ¥ÁßãÂ≠£ÔºåÊÇ®Êó†ÈúÄÂÆûÁé∞Êõ¥Êñ∞ÊâßË°åÂô®Âç≥ÂèØÂú®È°πÁõÆ 3 / È°πÁõÆ 4 ‰∏≠Ëé∑ÂæóÊª°ÂàÜ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//  ÂàùÂßãÂåñÊñπÊ≥ï 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñÂ≠êÊâßË°åÂô®,ËÆ©ÂÖ∂ÂáÜÂ§áÂ•ΩÂæÖÊèíÂÖ•ÁöÑÊï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñË°®‰ø°ÊÅØ„Äêtable_info_„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	is_end_ = false;Ê†áËÆ∞ÊòØÂê¶ÂÆåÊàêÊõ¥Êñ∞Êìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">UpdateExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> <span class="c1">//{ throw NotImplementedException(&#34;UpdateExecutor is not implemented&#34;); }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span><span class="c1">// ÂàùÂßãÂåñÂ≠êÊâßË°åÂô®ÔºàÂ¶ÇÂºÄÂßãÊâ´ÊèèÊï∞ÊçÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ‰ªéÊï∞ÊçÆÂ∫ìÁõÆÂΩïÔºàCatalogÔºâ‰∏≠Ëé∑ÂèñË°®ÁªìÊûÑÔºàÂ¶ÇÂ≠óÊÆµÂêç„ÄÅÁ±ªÂûãÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">table_info_</span> <span class="o">=</span> <span class="n">exec_ctx_</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTable</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetTableOid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">is_end_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">// Ê†áËÆ∞ÊòØÂê¶ÂÆåÊàêÊõ¥Êñ∞Êìç‰Ωú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËØ∫Â∑≤ÊâßË°åËøáÊõ¥Êñ∞ÔºåÁõ¥Êé•ËøîÂõûfalse
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑Âèñ‰∫ãÂä°„ÄÅË°®‰ø°ÊÅØ„ÄÅÁ¥¢Âºï‰ø°ÊÅØ„Äêtx„ÄÅtable_info„ÄÅindex_info_vector„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	Âæ™ÁéØËØªÂèñÂ≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÁîüÊàêÊñ∞Êï∞ÊçÆÔºàÊ†πÊçÆÊõ¥Êñ∞Ë°®ËææÂºèÂíåÊóßÁöÑÂÖÉÁªÑÊï∞ÊçÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Êõ¥Êñ∞Ë°®‰∏≠ÁöÑÊï∞ÊçÆË°å
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÁªüËÆ°Êõ¥Êñ∞Ë°åÊï∞‰ª•ÂèäÊõ¥Êñ∞ÊâÄÊúâÁ¥¢ÂºïÔºàÂÖàÂà†Èô§ÊóßÁ¥¢ÂºïÔºåÂÜçÊèíÂÖ•Êñ∞Á¥¢ÂºïÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆËØªÂèñÂÆåÂêéÈÄÄÂá∫Âæ™ÁéØ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÊûÑÈÄ†ËøîÂõûÁªìÊûúÔºàÊõ¥Êñ∞ÁöÑË°åÊï∞Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">UpdateExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="na">[[maybe_unused]]</span> <span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">is_end_</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Â∑≤ÊâßË°åËøáÊõ¥Êñ∞ÔºåÁõ¥Êé•ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Ëé∑Âèñ‰∫ãÂä°„ÄÅË°®‰ø°ÊÅØ„ÄÅÁ¥¢Âºï‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Transaction</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTransaction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">TableInfo</span> <span class="o">*</span><span class="n">table_info</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTable</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetTableOid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IndexInfo</span> <span class="o">*&gt;</span> <span class="n">index_info_vector</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTableIndexes</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">name_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Tuple</span> <span class="n">old_tuple</span><span class="p">{};</span><span class="c1">// ÊóßÊï∞ÊçÆÔºàÂæÖÊõ¥Êñ∞ÁöÑÂéüÂßãË°åÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">int32_t</span> <span class="n">update_count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// ÁªüËÆ°Êõ¥Êñ∞ÁöÑË°åÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Âæ™ÁéØËØªÂèñÂ≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_tuple</span><span class="p">,</span> <span class="n">rid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÁîüÊàêÊñ∞Êï∞ÊçÆÔºàÊ†πÊçÆÊõ¥Êñ∞Ë°®ËææÂºèÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">expr</span> <span class="p">:</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">target_expressions_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">expr</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">old_tuple</span><span class="p">,</span> <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">to_update_tuple</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Êõ¥Êñ∞Ë°®‰∏≠ÁöÑÊï∞ÊçÆË°å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">updated</span> <span class="o">=</span><span class="c1">// ÂÖÉÊï∞ÊçÆÔºàÊó∂Èó¥Êà≥„ÄÅÊú™Âà†Èô§ÔºâÔºõ// Êñ∞Êï∞ÊçÆÔºõ// Ë°åÊ†áËØÜÁ¨¶ÔºàÂÆö‰ΩçË¶Å‰øÆÊîπÁöÑË°åÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">table_info_</span><span class="o">-&gt;</span><span class="n">table_</span><span class="o">-&gt;</span><span class="n">UpdateTupleInPlace</span><span class="p">(</span><span class="n">TupleMeta</span><span class="p">{</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">GetTransactionTempTs</span><span class="p">(),</span> <span class="nb">false</span><span class="p">},</span> <span class="n">to_update_tuple</span><span class="p">,</span> <span class="o">*</span><span class="n">rid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">updated</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">update_count</span><span class="o">++</span><span class="p">;</span> <span class="c1">// ÁªüËÆ°ÊàêÂäüÊõ¥Êñ∞ÁöÑË°åÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Êõ¥Êñ∞ÊâÄÊúâÁ¥¢ÂºïÔºàÂÖàÂà†Èô§ÊóßÁ¥¢ÂºïÔºåÂÜçÊèíÂÖ•Êñ∞Á¥¢ÂºïÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">index_info</span> <span class="p">:</span> <span class="n">index_info_vector</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">DeleteEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">old_tuple</span><span class="p">.</span><span class="n">KeyFromTuple</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">schema_</span><span class="p">,</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">key_schema_</span><span class="p">,</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">GetKeyAttrs</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">            <span class="o">*</span><span class="n">rid</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">InsertEntry</span><span class="p">(</span><span class="n">to_update_tuple</span><span class="p">.</span><span class="n">KeyFromTuple</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">schema_</span><span class="p">,</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">key_schema_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                                     <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">GetKeyAttrs</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                                        <span class="o">*</span><span class="n">rid</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ÊûÑÈÄ†ËøîÂõûÁªìÊûúÔºàÊõ¥Êñ∞ÁöÑË°åÊï∞Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="n">values</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">TypeId</span><span class="o">::</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">update_count</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">  <span class="n">is_end_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span><span class="c1">// Ê†áËÆ∞Â∑≤ÊâßË°åÂÆåÊàê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span> <span class="c1">// ËøîÂõûtrueË°®Á§∫ÊúâÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>4 Delete</strong>
Ê≤°‰ªÄ‰πàËØ¥ÁöÑÔºåÂíåupdateÂ∑Æ‰∏çÂ§öÔºåÊääÊõ¥Êñ∞ÁöÑÈÉ®ÂàÜÂà†ÊéâÔºåÂà†Èô§ÁöÑÈÉ®ÂàÜ‰øùÁïôÂ∞±Ë°å</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** The delete plan node to be executed */</span>
</span></span><span class="line"><span class="cl">   <span class="cm">/** Ë¶ÅÊâßË°åÁöÑÂà†Èô§ËÆ°ÂàíËäÇÁÇπ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">DeletePlanNode</span> <span class="o">*</span><span class="n">plan_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/** The child executor from which RIDs for deleted tuples are pulled */</span>
</span></span><span class="line"><span class="cl">    <span class="cm">/** Â≠êÊâßË°åÂô®Ôºå‰ªé‰∏≠ÊèêÂèñÂ∑≤Âà†Èô§ÂÖÉÁªÑÁöÑ RID */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">child_executor_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/** Whether the Next() has been called before */</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">called_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// , plan_(plan), child_executor_(std::move(child_executor)) 
</span></span></span><span class="line"><span class="cl"><span class="c1">//child_executor_ÔºöÂ≠êÊâßË°åÂô®ÔºåÁî®‰∫éÊèê‰æõÂæÖÂà†Èô§ÁöÑÊï∞ÊçÆÔºà‰æãÂ¶ÇÈÄöËøá WHERE Êù°‰ª∂Á≠õÈÄâÂá∫ÁöÑÊï∞ÊçÆÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">DeleteExecutor</span><span class="o">::</span><span class="n">DeleteExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">DeletePlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                               <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">child_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">),</span> <span class="n">plan_</span><span class="p">(</span><span class="n">plan</span><span class="p">),</span> <span class="n">child_executor_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">child_executor</span><span class="p">))</span>  <span class="p">{}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ÂàùÂßãÂåñÂà†Èô§ÊâßË°åÂô®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñÂ≠êÊâßË°åÂô®,ËÆ©ÂÖ∂ÂáÜÂ§áÂ•ΩÂæÖÊèíÂÖ•ÁöÑÊï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">	 ÂàùÂßãÂåñcalled_ = false;Ë°®Á§∫ÁõÆÂâçÊ≤°Ë¢´Ë∞ÉÁî®Ëøá
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">DeleteExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span><span class="c1">// ‰æãÂ¶ÇÔºåËã•Â≠êÊâßË°åÂô®ÊòØÊâ´ÊèèÊâßË°åÂô®ÔºàSeqScanExecutorÔºâÔºå‰ºöÂºÄÂßãÊâ´ÊèèË°®Êï∞ÊçÆ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">called_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñË°®„ÄÅ‰∫ãÂä°„ÄÅÁ¥¢Âºï‰ø°ÊÅØ„Äêtx„ÄÅtable_heap„ÄÅindex_info_vector„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	Âæ™ÁéØËØªÂèñÂ≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Ê†áËÆ∞Êï∞ÊçÆ‰∏∫Â∑≤Âà†Èô§
</span></span></span><span class="line"><span class="cl"><span class="cm">		Êõ¥Êñ∞ÊâÄÊúâÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÁªüËÆ°Âà†Èô§Ë°åÊï∞
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆËØªÂèñÂÆåÂêéÈÄÄÂá∫Âæ™ÁéØ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÊûÑÈÄ†ËøîÂõûÁªìÊûúÔºàÂà†Èô§Ë°åÊï∞Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Âà§Êñ≠ËøîÂõûtureËøòÊòØfalse
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">DeleteExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="na">[[maybe_unused]]</span> <span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Ëé∑ÂèñË°®„ÄÅ‰∫ãÂä°„ÄÅÁ¥¢Âºï‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">TableInfo</span> <span class="o">*</span><span class="n">table_info</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTable</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetTableOid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">Transaction</span> <span class="o">*</span><span class="n">tx</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTransaction</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">TableHeap</span> <span class="o">*</span><span class="n">table_heap</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">-&gt;</span><span class="n">table_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">IndexInfo</span> <span class="o">*&gt;</span> <span class="n">index_info_vector</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTableIndexes</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">name_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">Tuple</span> <span class="n">child_tuple</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">int</span> <span class="n">size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âæ™ÁéØËØªÂèñÂ≠êÊâßË°åÂô®ÁöÑÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_tuple</span><span class="p">,</span> <span class="n">rid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Ê†áËÆ∞Êï∞ÊçÆ‰∏∫Â∑≤Âà†Èô§
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">table_heap</span><span class="o">-&gt;</span><span class="n">UpdateTupleMeta</span><span class="p">(</span><span class="n">TupleMeta</span><span class="p">{</span><span class="n">tx</span><span class="o">-&gt;</span><span class="n">GetTransactionTempTs</span><span class="p">(),</span> <span class="nb">true</span><span class="p">},</span> <span class="o">*</span><span class="n">rid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Êõ¥Êñ∞ÊâÄÊúâÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">index_info</span> <span class="p">:</span> <span class="n">index_info_vector</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">DeleteEntry</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="n">child_tuple</span><span class="p">.</span><span class="n">KeyFromTuple</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">schema_</span><span class="p">,</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">key_schema_</span><span class="p">,</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">GetKeyAttrs</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">                <span class="o">*</span><span class="n">rid</span><span class="p">,</span> <span class="n">tx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">      <span class="n">size</span><span class="o">++</span><span class="p">;</span><span class="c1">// ÁªüËÆ°Âà†Èô§Ë°åÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ÊûÑÈÄ†ËøîÂõûÁªìÊûúÔºàÂà†Èô§Ë°åÊï∞Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">INTEGER</span><span class="p">,</span> <span class="n">size</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ÊéßÂà∂ËøîÂõûÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">called_</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Âà†Èô§0Ë°åÊó∂ËøîÂõû‰∏ÄÊ¨°true
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">called_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">called_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">size</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// Âà†Èô§Ë°åÊï∞&gt;0Êó∂ËøîÂõûtrue‰∏ÄÊ¨°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>5 Indexscan</strong>
<strong>5.1 ÊÄùË∑Ø</strong>
Ë¶ÅÊ±ÇÔºö ‰ΩøÁî®ÂìàÂ∏åÁ¥¢ÂºïÊâßË°åÁÇπÊü•Êâæ‰ª•Ê£ÄÁ¥¢ÂÖÉÁªÑÁöÑRID„ÄÇÁÑ∂ÂêéÈÄê‰∏™ÂèëÂá∫Ëøô‰∫õÂÖÉÁªÑ„ÄÇ
ÊÄùË∑ØÔºö ÊääÁ¥¢ÂºïÂæóÂà∞ÁöÑÂÄºÊîæÂà∞result_ridsÈáåÔºåÁÑ∂ÂêéÂà§Êñ≠result_rids ÊòØ‰∏çÊòØÁ©∫ÔºåÂà†Èô§Ê†áÂøóÔºåÈÉΩ‰∏çÊòØÂ∞±ÊääÊï∞ÊçÆÂíåRIDÂàÜÂà´ËµãÂÄºÁªô‰º†ÂÖ•ÁöÑ tuple Âíå rid ÊåáÈíàÊâÄÊåáÂêëÁöÑÂèòÈáè</p>
<p><strong>5.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** The index scan plan node to be executed. */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Ë¶ÅÊâßË°åÁöÑÁ¥¢ÂºïÊâ´ÊèèËÆ°ÂàíËäÇÁÇπ„ÄÇ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">IndexScanPlanNode</span> <span class="o">*</span><span class="n">plan_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RID</span><span class="o">&gt;</span> <span class="n">rids_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">RID</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">rids_iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">////////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// ÂàùÂßãÂåñÁ¥¢ÂºïÊâ´ÊèèÊâßË°åÂô®„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ÂèÇÊï∞Ôºö
</span></span></span><span class="line"><span class="cl"><span class="c1">// exec_ctxÔºöÊâßË°å‰∏ä‰∏ãÊñáÔºàÂåÖÂê´‰∫ãÂä°„ÄÅÈîÅÁÆ°ÁêÜÂô®Á≠âÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// planÔºöÁ¥¢ÂºïÊâ´ÊèèÁöÑÊâßË°åËÆ°ÂàíÔºà‰æãÂ¶Ç‰ΩøÁî®Âì™‰∏™Á¥¢Âºï„ÄÅËøáÊª§Êù°‰ª∂Á≠âÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">IndexScanExecutor</span><span class="o">::</span><span class="n">IndexScanExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">IndexScanPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">),</span> <span class="n">plan_</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>  <span class="p">{}</span><span class="c1">// , plan_(plan) 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñÁ¥¢Âºï‰ø°ÊÅØ‰∏îËΩ¨Êç¢‰∏∫ÂìàÂ∏åÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â¶ÇÊûúÊúâËøáÊª§Êù°‰ª∂Ôºà‰æãÂ¶Ç WHERE id = 1001Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÊèêÂèñËøáÊª§Êù°‰ª∂ÁöÑÂ∏∏ÈáèÂÄºÔºà‰æãÂ¶Ç1001Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		‰ΩøÁî®Á¥¢ÂºïÊü•ÊâæÂåπÈÖçÁöÑRIDÔºà‰æãÂ¶ÇÊâæÂà∞ÊâÄÊúâid=1001ÁöÑË°å‰ΩçÁΩÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñËø≠‰ª£Âô®ÔºåÂáÜÂ§áÈÅçÂéÜRIDÂàóË°®
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">IndexScanExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> <span class="c1">//{ throw NotImplementedException(&#34;IndexScanExecutor is not implemented&#34;); }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">///////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Ëé∑ÂèñÁ¥¢Âºï‰ø°ÊÅØÔºà‰æãÂ¶ÇÁ¥¢ÂºïÁ±ªÂûã„ÄÅÂÖ≥ËÅîÁöÑË°®Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IndexInfo</span> <span class="o">*</span><span class="n">index_info</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetIndex</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">index_oid_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Â∞ÜÁ¥¢ÂºïËΩ¨Êç¢‰∏∫ÂìàÂ∏åÁ¥¢ÂºïÔºàÂÅáËÆæÁ¥¢ÂºïÁ±ªÂûãÊòØÂìàÂ∏åÁ¥¢ÂºïÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">*</span><span class="n">hash_index</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">HashTableIndexForTwoIntegerColumn</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">rids_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span><span class="c1">// Ê∏ÖÁ©∫Â≠òÂÇ®Ë°åÊ†áËØÜÁ¨¶ÔºàRIDÔºâÁöÑÂàóË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Â¶ÇÊûúÊúâËøáÊª§Êù°‰ª∂Ôºà‰æãÂ¶Ç WHERE id = 1001Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">filter_predicate_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊèêÂèñËøáÊª§Êù°‰ª∂ÁöÑÂ∏∏ÈáèÂÄºÔºà‰æãÂ¶Ç1001Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">const</span> <span class="k">auto</span> <span class="n">right_exptr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ConstantValueExpression</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">filter_predicate_</span><span class="o">-&gt;</span><span class="n">children_</span><span class="p">[</span><span class="mi">1</span><span class="p">].</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">Value</span> <span class="n">v</span> <span class="o">=</span> <span class="n">right_exptr</span><span class="o">-&gt;</span><span class="n">val_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ‰ΩøÁî®Á¥¢ÂºïÊü•ÊâæÂåπÈÖçÁöÑRIDÔºà‰æãÂ¶ÇÊâæÂà∞ÊâÄÊúâid=1001ÁöÑË°å‰ΩçÁΩÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">hash_index</span><span class="o">-&gt;</span><span class="n">ScanKey</span><span class="p">(</span><span class="n">Tuple</span><span class="p">{{</span><span class="n">v</span><span class="p">},</span> <span class="n">index_info</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">GetKeySchema</span><span class="p">()},</span> <span class="o">&amp;</span><span class="n">rids_</span><span class="p">,</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTransaction</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàùÂßãÂåñËø≠‰ª£Âô®ÔºåÂáÜÂ§áÈÅçÂéÜRIDÂàóË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">rids_iter_</span> <span class="o">=</span> <span class="n">rids_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">///////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñÁ¥¢ÂºïÂíåË°®‰ø°ÊÅØ„Äêindex_info„ÄÅtable_info„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËøõÂÖ•Âæ™ÁéØ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúRIDÂàóË°®ÈÅçÂéÜÂÆåÊàêÔºåËøîÂõûfalse
</span></span></span><span class="line"><span class="cl"><span class="cm">		Ëé∑ÂèñÂΩìÂâçRIDÔºàË°å‰ΩçÁΩÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Ëé∑ÂèñËØ•Ë°åÁöÑÂÖÉÊï∞ÊçÆÔºà‰æãÂ¶ÇÊòØÂê¶Ë¢´Âà†Èô§Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">		‰ªéË°®‰∏≠ËØªÂèñËØ•Ë°åÁöÑÂÆûÈôÖÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Ëø≠‰ª£Âô®ÊåáÂêë‰∏ã‰∏Ä‰∏™RID
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÈÅáÂà∞Â∑≤Âà†Èô§ÁöÑË°åÊó∂ÔºåÁªßÁª≠Âæ™ÁéØÔºåÂê¶ÂàôË∑≥Âá∫Âæ™ÁéØ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËøîÂõû ture
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">IndexScanExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">///////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Ëé∑ÂèñÁ¥¢ÂºïÂíåË°®‰ø°ÊÅØÔºà‰æãÂ¶ÇË°®Âêç„ÄÅË°®ÁªìÊûÑÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">IndexInfo</span> <span class="o">*</span><span class="n">index_info</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetIndex</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetIndexOid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">TableInfo</span> <span class="o">*</span><span class="n">table_info</span> <span class="o">=</span> <span class="n">GetExecutorContext</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetCatalog</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">GetTable</span><span class="p">(</span><span class="n">index_info</span><span class="o">-&gt;</span><span class="n">table_name_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">TupleMeta</span> <span class="n">meta</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="k">do</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// Â¶ÇÊûúRIDÂàóË°®ÈÅçÂéÜÂÆåÊàêÔºåËøîÂõûfalse
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">rids_iter_</span> <span class="o">==</span> <span class="n">rids_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ëé∑ÂèñÂΩìÂâçRIDÔºàË°å‰ΩçÁΩÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">*</span><span class="n">rid</span> <span class="o">=</span> <span class="o">*</span><span class="n">rids_iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ëé∑ÂèñËØ•Ë°åÁöÑÂÖÉÊï∞ÊçÆÔºà‰æãÂ¶ÇÊòØÂê¶Ë¢´Âà†Èô§Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">meta</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">-&gt;</span><span class="n">table_</span><span class="o">-&gt;</span><span class="n">GetTupleMeta</span><span class="p">(</span><span class="o">*</span><span class="n">rid</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ‰ªéË°®‰∏≠ËØªÂèñËØ•Ë°åÁöÑÂÆûÈôÖÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">table_info</span><span class="o">-&gt;</span><span class="n">table_</span><span class="o">-&gt;</span><span class="n">GetTuple</span><span class="p">(</span><span class="o">*</span><span class="n">rid</span><span class="p">).</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ëø≠‰ª£Âô®ÊåáÂêë‰∏ã‰∏Ä‰∏™RID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">rids_iter_</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">while</span> <span class="p">(</span><span class="n">meta</span><span class="p">.</span><span class="n">is_deleted_</span><span class="p">);</span><span class="c1">// Ë∑≥ËøáÂ∑≤Âà†Èô§ÁöÑË°å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">///////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>task1 ÂÆåÊàêÂêéÔºåsqlËØ≠Âè•ÁöÑ1-6Â∞±ÈÉΩÂèØ‰ª•ÊµãËØï‰∫Ü</p>
<p><strong>6 ‰ºòÂåñ</strong>
<strong>6.1 ÊÄùË∑Ø</strong>
Ë¶ÅÊ±ÇÔºö ÂÆûÁé∞Â∞ÜSeqScanPlanNode‰ºòÂåñ‰∏∫IndexScanPlanNodeÁöÑ‰ºòÂåñÂô®ËßÑÂàô
ÊÄùË∑ØÔºö
Âè™Êúâ‰∏ÄÁßçÊÉÖÂÜµÂèØ‰ª•ÊääÈ°∫Â∫èÁöÑÂèòÊàêÁ¥¢ÂºïÁöÑÔºåÂç≥‰ª•‰∏ãÊù°‰ª∂ÂêåÊó∂Êª°Ë∂≥
1„ÄÅË∞ìËØçÔºàÂç≥where‰πãÂêéÁöÑËØ≠Âè•Ôºâ‰∏ç‰∏∫Á©∫
2„ÄÅË°®ÊîØÊåÅÁ¥¢ÂºïÊâ´Êèè
3„ÄÅÂè™Êúâ‰∏Ä‰∏™Ë∞ìËØçÊù°‰ª∂ÔºàÂ¶ÇSELECT * FROM t1 WHERE v1 = 1 AND v2 = 2Â∞±‰∏çË°åÔºâ
4„ÄÅË∞ìËØçÊòØÁ≠âÂÄºÊù°‰ª∂ÔºàÂç≥WHERE v1 = 1Ôºâ
ÊâÄ‰ª•Ë¶ÅÊääÊâÄÊúâÊù°‰ª∂ÈÉΩÂà§Êñ≠‰∏ÄÈÅçÔºåÊâçËÉΩÁî®Á¥¢ÂºïÊâ´Êèè</p>
<p><strong>6.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈÅçÂéÜÂ≠êËÆ°ÂàíÔºåÈÄíÂΩí‰ºòÂåñ„Äêchildren.emplace_back(OptimizeSeqScanAsIndexScan(child));„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂÖãÈöÜËÆ°ÂàíÔºåÁî®‰ºòÂåñÂêéÁöÑÂ≠êËÆ°ÂàíÊõøÊç¢ÂéüÊúâÁöÑÂ≠êËÆ°Âàí
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â§çÂà∂‰∏Ä‰ªΩËÆ°Âàí„Äêoptimized_plan = plan-&gt;CloneWithChildren(std::move(children));„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúËÆ°ÂàíÁ±ªÂûã‰∏∫Â∫èÂàóÊâ´Êèè
</span></span></span><span class="line"><span class="cl"><span class="cm">			Âä®ÊÄÅÁ±ªÂûãËΩ¨Êç¢‰∏∫Â∫èÂàóÊâ´ÊèèËÆ°ÂàíËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="cm">				 Âä®ÊÄÅÁ±ªÂûãËΩ¨Êç¢‰∏∫ÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="cm">				 	ËøáÊª§Êù°‰ª∂ÂøÖÈ°ªÊòØÁ≠âÂÄºÊØîËæÉ‚ÄãÔºàÂ¶Ç =ÔºâÔºåÊâçËÉΩ‰ΩøÁî®Á¥¢ÂºïÂä†ÈÄü„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">				 		Ëé∑ÂèñË°®Ê†º‰ø°ÊÅØ„ÄÅÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="cm">				 		Âä®ÊÄÅÁ±ªÂûãËΩ¨Êç¢‰∏∫ÂàóÂÄºË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="cm">				 		ÈÅçÂéÜÊâÄÊúâÁ¥¢ÂºïÔºå ÂåπÈÖçÁ¥¢ÂºïÂàó
</span></span></span><span class="line"><span class="cl"><span class="cm">				 		ËøîÂõûÁ¥¢ÂºïÊâ´ÊèèËÆ°ÂàíËäÇÁÇπÔºåÁîüÊàêÁ¥¢ÂºïÊâ´ÊèèËÆ°Âàí
</span></span></span><span class="line"><span class="cl"><span class="cm">				 		ÁªìÊùü
</span></span></span><span class="line"><span class="cl"><span class="cm">		ËøîÂõû‰ºòÂåñÂêéÁöÑËÆ°Âàí„ÄêËøôÈáåÁöÑÊÉÖÂÜµÊòØ‰∏çÁ¨¶Âêà‰ºòÂåñÊù°‰ª∂„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// ‰ºòÂåñÂô®ÂáΩÊï∞ÔºöÂ∞ÜÂ∫èÂàóÊâ´ÊèèËÆ°Âàí‰ºòÂåñ‰∏∫Á¥¢ÂºïÊâ´ÊèèËÆ°Âàí
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">Optimizer</span><span class="o">::</span><span class="n">OptimizeSeqScanAsIndexScan</span><span class="p">(</span><span class="k">const</span> <span class="n">bustub</span><span class="o">::</span><span class="n">AbstractPlanNodeRef</span> <span class="o">&amp;</span><span class="n">plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractPlanNodeRef</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">///////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// TODO(student): implement seq scan with predicate -&gt; index scan optimizer rule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// The Filter Predicate Pushdown has been enabled for you in optimizer.cpp when forcing starter rule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÈÅçÂéÜÂ≠êËÆ°ÂàíÔºåÈÄíÂΩí‰ºòÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ‰ΩúÁî®ÔºöÊ∑±Â∫¶‰ºòÂÖàÈÅçÂéÜÊü•ËØ¢ËÆ°ÂàíÊ†ëÔºåÁ°Æ‰øùÊâÄÊúâÂ≠êËäÇÁÇπÈÉΩÁªèËøá‰ºòÂåñ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ‚ÄãÁ±ªÊØîÔºöÁ±ª‰ººÂÖàÊï¥ÁêÜ‰π¶Êû∂ÊØè‰∏ÄÂ±ÇÔºåÂÜçÂ§ÑÁêÜÊï¥‰∏™‰π¶Êû∂„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AbstractPlanNodeRef</span><span class="o">&gt;</span> <span class="n">children</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">child</span> <span class="p">:</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetChildren</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">children</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">OptimizeSeqScanAsIndexScan</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂÖãÈöÜËÆ°ÂàíÔºåÁî®‰ºòÂåñÂêéÁöÑÂ≠êËÆ°ÂàíÊõøÊç¢ÂéüÊúâÁöÑÂ≠êËÆ°Âàí
</span></span></span><span class="line"><span class="cl"><span class="c1">//     ‰ΩúÁî®ÔºöÁîüÊàê‰∏Ä‰∏™‰∏éÂéüËÆ°ÂàíÁªìÊûÑÁõ∏ÂêåÁöÑÊñ∞ËÆ°ÂàíÔºå‰ΩÜÊõøÊç¢‰∫Ü‰ºòÂåñÂêéÁöÑÂ≠êËäÇÁÇπ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÊÑè‰πâÔºöÈÅøÂÖçÁõ¥Êé•‰øÆÊîπÂéüËÆ°ÂàíÔºå‰øùËØÅ‰ºòÂåñËøáÁ®ãÁöÑÁã¨Á´ãÊÄß„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">optimized_plan</span> <span class="o">=</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">CloneWithChildren</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">children</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="c1">// Â¶ÇÊûúËÆ°ÂàíÁ±ªÂûã‰∏∫Â∫èÂàóÊâ´Êèè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">GetType</span><span class="p">()</span> <span class="o">==</span> <span class="n">PlanType</span><span class="o">::</span><span class="n">SeqScan</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Âä®ÊÄÅÁ±ªÂûãËΩ¨Êç¢‰∏∫Â∫èÂàóÊâ´ÊèèËÆ°ÂàíËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">seq_scan</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SeqScanPlanNode</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">optimized_plan</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">seq_scan</span><span class="p">.</span><span class="n">filter_predicate_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Â¶ÇÊûúËøáÊª§Ë∞ìËØç‰∏ç‰∏∫Á©∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// Âä®ÊÄÅÁ±ªÂûãËΩ¨Êç¢‰∏∫ÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">*</span><span class="n">cmp_expr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">ComparisonExpression</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">seq_scan</span><span class="p">.</span><span class="n">filter_predicate_</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="c1">//         ËøáÊª§Êù°‰ª∂ÂøÖÈ°ªÊòØÁ≠âÂÄºÊØîËæÉ‚ÄãÔºàÂ¶Ç =ÔºâÔºåÊâçËÉΩ‰ΩøÁî®Á¥¢ÂºïÂä†ÈÄü„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‰æãÂ¶ÇÔºöWHERE id = 1001 ÈÄÇÂêàÁ¥¢ÂºïÊâ´ÊèèÔºåËÄå WHERE id &gt; 1001 ÂèØËÉΩ‰∏çÈÄÇÂêà„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">cmp_expr</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">cmp_expr</span><span class="o">-&gt;</span><span class="n">comp_type_</span> <span class="o">==</span> <span class="n">ComparisonType</span><span class="o">::</span><span class="n">Equal</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Â¶ÇÊûúÊòØÁõ∏Á≠âÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="c1">// Ëé∑ÂèñË°®Ê†º‰ø°ÊÅØ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">const</span> <span class="k">auto</span> <span class="o">*</span><span class="n">table_info</span> <span class="o">=</span> <span class="n">catalog_</span><span class="p">.</span><span class="n">GetTable</span><span class="p">(</span><span class="n">seq_scan</span><span class="p">.</span><span class="n">GetTableOid</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Ëé∑ÂèñË°®Ê†ºÁöÑÊâÄÊúâÁ¥¢Âºï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">const</span> <span class="k">auto</span> <span class="n">indices</span> <span class="o">=</span> <span class="n">catalog_</span><span class="p">.</span><span class="n">GetTableIndexes</span><span class="p">(</span><span class="n">table_info</span><span class="o">-&gt;</span><span class="n">name_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// Âä®ÊÄÅÁ±ªÂûãËΩ¨Êç¢‰∏∫ÂàóÂÄºË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">const</span> <span class="k">auto</span> <span class="o">*</span><span class="n">column_value_expr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ColumnValueExpression</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">cmp_expr</span><span class="o">-&gt;</span><span class="n">children_</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">          <span class="c1">// ÈÅçÂéÜÊâÄÊúâÁ¥¢ÂºïÔºå ÂåπÈÖçÁ¥¢ÂºïÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1">//           ‚ÄãÂàóÂåπÈÖçÔºöËøáÊª§Êù°‰ª∂‰∏≠ÁöÑÂàóÔºàÂ¶Ç idÔºâÂøÖÈ°ª‰∏éÁ¥¢ÂºïÁöÑÂàóÂÆåÂÖ®‰∏ÄËá¥„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// Á§∫‰æãÔºöËã•Á¥¢ÂºïÊòØ (id)ÔºåËøáÊª§Êù°‰ª∂‰∏∫ id = 1001ÔºåÂàôÂåπÈÖçÊàêÂäü„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‰∏çÂåπÈÖçÁöÑÊÉÖÂÜµÔºöÁ¥¢ÂºïÊòØ (name)ÔºåËøáÊª§Êù°‰ª∂ÊòØ id = 1001ÔºåÂàôË∑≥Ëøá„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>          <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">*</span><span class="nl">index</span> <span class="p">:</span> <span class="n">indices</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Ëé∑ÂèñÁ¥¢ÂºïÁöÑÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">columns</span> <span class="o">=</span> <span class="n">index</span><span class="o">-&gt;</span><span class="n">index_</span><span class="o">-&gt;</span><span class="n">GetKeyAttrs</span><span class="p">();</span><span class="c1">// Á¥¢ÂºïÁöÑÂàóIDÂàóË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="c1">// Ëé∑ÂèñËøáÊª§ÂàóÁöÑID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span> <span class="n">filter_column_ids</span> <span class="o">=</span> <span class="p">{</span><span class="n">column_value_expr</span><span class="o">-&gt;</span><span class="n">GetColIdx</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">            <span class="c1">// Â¶ÇÊûúËøáÊª§ÂàóID‰∏éÁ¥¢ÂºïÂàóÁõ∏ÂåπÈÖç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>            <span class="k">if</span> <span class="p">(</span><span class="n">filter_column_ids</span> <span class="o">==</span> <span class="n">columns</span><span class="p">)</span> <span class="p">{</span> <span class="c1">// ÊòØÂê¶ÂåπÈÖçÁ¥¢ÂºïÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="c1">// ËøîÂõûÁ¥¢ÂºïÊâ´ÊèèËÆ°ÂàíËäÇÁÇπÔºåÁîüÊàêÁ¥¢ÂºïÊâ´ÊèèËÆ°Âàí
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>              <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">IndexScanPlanNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">output_schema_</span><span class="p">,</span> <span class="n">table_info</span><span class="o">-&gt;</span><span class="n">oid_</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                         <span class="n">index</span><span class="o">-&gt;</span><span class="n">index_oid_</span><span class="p">,</span> <span class="n">seq_scan</span><span class="p">.</span><span class="n">filter_predicate_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">            <span class="p">}</span>
</span></span><span class="line"><span class="cl">          <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËøîÂõû‰ºòÂåñÂêéÁöÑËÆ°Âàí
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">optimized_plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="c1">///////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//return plan;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="‰ªªÂä°-2---ËÅöÂêàÂíåËÅîÊé•ÊâßË°åËÄÖ">‰ªªÂä° #2 - ËÅöÂêàÂíåËÅîÊé•ÊâßË°åËÄÖ
</h2><p>ÊÇ®Â∞ÜÂú®‰ª•‰∏ãÊñá‰ª∂‰∏≠ÂÆåÊàêÂÆûÊñΩÔºö</p>
<ul>
<li><code>src/include/execution/aggregation_executor.h</code></li>
<li><code>src/execution/aggregation_executor.cpp</code></li>
<li><code>src/include/execution/nested_loop_join_executor.h</code></li>
<li><code>src/execution/nested_loop_join_executor.cpp</code></li>
</ul>
<p><strong>1 Aggregation</strong>
<strong>1.1 ÊÄùË∑Ø</strong>
Ê≥®ÊÑèÔºöËÅöÂêàÂú®Êü•ËØ¢ËÆ°Âàí‰∏≠ÊòØÁÆ°ÈÅì‰∏≠Êñ≠ËÄÖÔºåËÅöÂêàÊìç‰Ωú‰∏çËÉΩÁÆÄÂçïÂú∞ÊåâË°åÔºàtuple-by-tupleÔºâ‰ªéÂÖ∂Â≠êËäÇÁÇπÔºàÊàñÊï∞ÊçÆÊ∫êÔºâÊé•Êî∂Êï∞ÊçÆÔºåÁÑ∂ÂêéÈÄêË°åËæìÂá∫ÁªìÊûú„ÄÇ
Áõ∏ÂèçÔºåËÅöÂêàÊìç‰ΩúÈúÄË¶ÅÂÖà‰ªéÂÖ∂Â≠êËäÇÁÇπËé∑ÂèñÊâÄÊúâÁõ∏ÂÖ≥ÁöÑÊï∞ÊçÆÔºåÂÆåÊàêÊï¥‰∏™ËÅöÂêàËÆ°ÁÆóËøáÁ®ãÔºà‰æãÂ¶ÇËÆ°ÁÆóÊÄªÂíå„ÄÅÂπ≥ÂùáÂÄº„ÄÅÊúÄÂ∞è/ÊúÄÂ§ßÂÄºÁ≠âÔºâÔºåÁÑ∂ÂêéÊâçËÉΩ‰∫ßÁîüËæìÂá∫ÁªìÊûú
AggregationExecutor ÈúÄË¶ÅÂÖà‰ªéÂ≠êÊâßË°åÂô®‰∏≠Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆÔºåÁÑ∂ÂêéÂØπËøô‰∫õÊï∞ÊçÆËøõË°åÂàÜÁªÑÂíåËÅöÂêàÊìç‰ΩúÔºå
ÊúÄÂêéÂ∞ÜÁªìÊûúËæìÂá∫ÔºåËÄåËøô‰∏™ËøáÁ®ãÂøÖÈ°ªÂú®initÂáΩÊï∞‰∏≠ÂÆåÊàê</p>
<p>ËøôÈáåÊàëÊé®ËçêÁúã.hÊñá‰ª∂ÔºåÊõ¥ÂÆπÊòìÁúãÊáÇ„ÄÇ</p>
<p><strong>ÊÄùË∑ØÔºö</strong></p>
<p><strong>Êàë‰ª¨‰ª•ÂàÜÁªÑËÅöÂêàÊü•ËØ¢ËØ≠Âè• select count(name) from table group by camp; ‰∏∫‰æãÁÆÄË¶ÅËØ¥Êòé‰∏Ä‰∏ãËÅöÂêàÊâßË°åÂô®ÁöÑÊâßË°åÊµÅÁ®ãÔºö</strong>
Init() ÂáΩÊï∞È¶ñÂÖà‰ªéÂ≠êÊâßË°åÂô®‰∏≠ÈÄêË°åËé∑ÂèñÊï∞ÊçÆÔºåÂπ∂Ê†πÊçÆÊØèË°åÊï∞ÊçÆÊûÑÂª∫ËÅöÂêàÈîÆÂíåËÅöÂêàÂÄº„ÄÇÂÖ∂‰∏≠ËÅöÂêàÈîÆÁî®‰∫éÊ†áËØÜËØ•Ë°åÊï∞ÊçÆÂ±û‰∫éÂì™‰∏Ä‰∏™ËÅöÂêàÁªÑÔºåËøôÈáåÊòØÊåâÁÖßÈòµËê• camp ÂàÜÁªÑÔºåÂõ†Ê≠§ËÅöÂêàÈîÆ‰ºöÊúâ Piltover„ÄÅIonia Âíå Shadow Isles ‰∏âÁßçÂèñÂÄºÔºåËøôÊ†∑ÊâÄÊúâÊï∞ÊçÆË¢´ÂàÜÊàê‰∏â‰∏™ËÅöÂêàÁªÑ„ÄÇËÄåËÅöÂêàÂÄºÂ∞±ÊòØÂæÖËÅöÂêàÁöÑÂàóÁöÑÂÄºÔºåËøôÈáåÁöÑËÅöÂêàÂàóÊòØ nameÔºåÂõ†Ê≠§Ëøô‰∫î‰∏™ Tuple ‰∏≠ÁîüÊàêÁöÑËÅöÂêàÂÄºÂç≥‰∏∫ÂØπÂ∫îÁöÑ name Â±ûÊÄßÁöÑÂÄº„ÄÇ
ÂØπ‰∫éÊØè‰∏™ÊèêÂèñÁöÑÊï∞ÊçÆË°åÔºåInit() ÂáΩÊï∞Ëøò‰ºöÈÄöËøá InsertCombine()Ôºå Â∞ÜÁõ∏Â∫îÁöÑËÅöÂêàÂÄºËÅöÂêàÂà∞Âà∞Áõ∏Â∫îÁöÑËÅöÂêàÁªÑ‰∏≠„ÄÇÂú®InsertCombine()‰∏≠Ë∞ÉÁî®CombineAggregateValues() ÂáΩÊï∞Êù•ÂÆûÁé∞ÂÖ∑‰ΩìÁöÑËÅöÂêàËßÑÂàô„ÄÇ
ÁªèËøá Init() ÂáΩÊï∞ÁöÑÂ§ÑÁêÜÔºå‰ª•‰∏äÂÖ≠Êù°Êï∞ÊçÆ‰ºöË¢´Êï¥ÁêÜ‰∏∫ [{‚ÄúPiltover‚Äù: 3}, {‚ÄúIonia‚Äù: 2}, {‚ÄúShadow Isles‚Äù: 1}] ‰∏â‰∏™ËÅöÂêàÁªÑÔºàÂØπÂ∫î‰∫éËÅöÂêàÂìàÂ∏åË°®‰∏≠ÁöÑ‰∏â‰∏™ÈîÆÂÄºÂØπÔºâ„ÄÇÂÖ∂‰∏≠groupbyÁöÑÂÄºÂàÜÂà´‰∏∫Piltover„ÄÅIonia„ÄÅShadow IslesÔºõaggregateÁöÑÂÄºÂàÜÂà´‰∏∫3„ÄÅ2„ÄÅ1„ÄÇ
ÊúÄÂêéÔºåNext() ÂáΩÊï∞‰ºöÈÄöËøáÂìàÂ∏åËø≠‰ª£Âô®‰æùÊ¨°Ëé∑ÂèñÊØè‰∏™ËÅöÂêàÁªÑÁöÑÈîÆ‰∏éÂÄºÔºåËøîÂõûÁªôÁà∂ÊâßË°åÂô®„ÄÇÂ¶ÇÊûúÊ≤° group by Â≠êÂè•ÔºåÈÇ£‰πàÊâÄÊúâÊï∞ÊçÆÈÉΩ‰ºöË¢´ÂàÜÂà∞Âêå‰∏Ä‰∏™ËÅöÂêàÁªÑ‰∏≠Âπ∂ËøîÂõû„ÄÇ</p>
<p><strong>1.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">///////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// ËøîÂõûË°®ÁöÑÂ§ßÂ∞è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="nf">Size</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">size_t</span> <span class="p">{</span> <span class="k">return</span> <span class="n">ht_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="cm">/** ÁÆÄÂçïËÅöÂêàÂìàÂ∏åË°® */</span>
</span></span><span class="line"><span class="cl"><span class="c1">//     Â≠òÂÇ®ÊâÄÊúâÂàÜÁªÑÁöÑ‰∏≠Èó¥ËÅöÂêàÁªìÊûú„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÁªìÊûÑÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÈîÆÔºàKeyÔºâ‚ÄãÔºöÂàÜÁªÑÈîÆÔºàÂ¶Ç[&#34;HR&#34;]Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÂÄºÔºàValueÔºâ‚ÄãÔºöÂΩìÂâçÂàÜÁªÑÁöÑËÅöÂêàÂÄºÔºàÂ¶Ç[ÊÄªÈîÄÂîÆÈ¢ù, ÊúÄÂ∞èÂπ¥ÈæÑ]Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÊìç‰ΩúÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÊèíÂÖ•Êñ∞ÂàÜÁªÑÔºöÂΩìÈÅáÂà∞Êñ∞ÁöÑÂàÜÁªÑÈîÆÊó∂ÔºåÂàõÂª∫ÂàùÂßãÂÄºÔºàÂ¶ÇCOUNT(*)ÂàùÂßã‰∏∫0Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÊõ¥Êñ∞Áé∞ÊúâÂàÜÁªÑÔºöÂΩìÂàÜÁªÑÂ∑≤Â≠òÂú®Êó∂ÔºåÂêàÂπ∂Êñ∞ÂÄºÔºàÂ¶ÇÁ¥ØÂä†ÈîÄÂîÆÈ¢ùÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SimpleAggregationHashTable</span> <span class="n">aht_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="cm">/** ÁÆÄÂçïËÅöÂêàÂìàÂ∏åË°®Ëø≠‰ª£Âô® */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ‚Äã‰ΩúÁî®ÔºöÈÅçÂéÜËÅöÂêàÂìàÂ∏åË°®ÔºåÈÄê‰∏™ËæìÂá∫ÂàÜÁªÑÁªìÊûú„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚Äã‰ΩøÁî®Âú∫ÊôØÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1">// ÊâÄÊúâÊï∞ÊçÆÂ§ÑÁêÜÂÆåÊØïÂêéÔºåÈÄöËøáËø≠‰ª£Âô®ÈÅçÂéÜÂìàÂ∏åË°®ÔºåÁîüÊàêÊúÄÁªàÁªìÊûú„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ÊØèÊ¨°Ë∞ÉÁî®Next()Êó∂ÔºåËø≠‰ª£Âô®ÁßªÂä®Âà∞‰∏ã‰∏Ä‰∏™ÂàÜÁªÑÔºåËæìÂá∫ÂÖ∂ÈîÆÂíåÂÄº„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">SimpleAggregationHashTable</span><span class="o">::</span><span class="n">Iterator</span> <span class="n">aht_iterator_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">AggregationExecutor</span><span class="o">::</span><span class="n">AggregationExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">AggregationPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                         <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">child_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">plan_</span><span class="p">(</span><span class="n">plan</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">child_executor_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">child_executor</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// GetAggregates()ËøîÂõûÁöÑÊòØagg_exprs_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ËÄåGetAggregateTypes()ËøîÂõûÁöÑÊòØagg_types_„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">aht_</span><span class="p">(</span><span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetAggregates</span><span class="p">(),</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetAggregateTypes</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="n">aht_iterator_</span><span class="p">(</span><span class="n">aht_</span><span class="p">.</span><span class="n">Begin</span><span class="p">())</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂêØÂä®Êï∞ÊçÆËØªÂèñÂô®ÔºàÂ¶Ç‰ªéÂëòÂ∑•Ë°®ËØªÊï∞ÊçÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ê∏ÖÁ©∫ÊäΩÂ±âÊüúÔºàÈò≤Ê≠¢ÊóßÊï∞ÊçÆÂπ≤Êâ∞Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈÄêË°åÂ§ÑÁêÜÊï∞ÊçÆ„ÄêËøôÈáåÊòØËé∑ÂèñkeyÂíåvalueÔºåÂÖ∂‰∏≠value‰ª£Ë°®ÁùÄÊòØËøô‰∏™ÂÖÉÁªÑÁöÑË¢´ËÅöÂêàÁöÑÂàóÁöÑÊï∞ÊçÆ„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â§ÑÁêÜÁâπÊÆäÊÉÖÂÜµÔºöÊ≤°ÊúâGROUP BY‰∏îÊó†Êï∞ÊçÆÊó∂‰øùËØÅËæìÂá∫
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËÆæÁΩÆaht_iterator_ÊåáÂêëahtÁöÑÂºÄÂ§¥
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">AggregationExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> <span class="c1">//{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span><span class="c1">// ÂêØÂä®Êï∞ÊçÆËØªÂèñÂô®ÔºàÂ¶Ç‰ªéÂëòÂ∑•Ë°®ËØªÊï∞ÊçÆÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">aht_</span><span class="p">.</span><span class="n">Clear</span><span class="p">();</span><span class="c1">// Ê∏ÖÁ©∫ÊäΩÂ±âÊüúÔºàÈò≤Ê≠¢ÊóßÊï∞ÊçÆÂπ≤Êâ∞Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Tuple</span> <span class="n">child_tuple</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">RID</span> <span class="n">rid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// ÈÄêË°åÂ§ÑÁêÜÊï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_tuple</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ÁîüÊàêkeuÂíåÂØπÂ∫îÁöÑvalue
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Â∞ÜÊï∞ÊçÆÂêàÂπ∂Âà∞ÂØπÂ∫îÂàÜÁªÑÁöÑÊäΩÂ±âÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Â¶ÇÊûúÊòØÊñ∞ÈÉ®Èó®ÔºàÊäΩÂ±â‰∏çÂ≠òÂú®Ôºâ‚Üí ÂàõÂª∫ÂàùÂßãÂÄºÔºàÂ¶ÇSUM=0ÔºåCOUNT=0Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Â∑≤ÊúâÈÉ®Èó® ‚Üí Êõ¥Êñ∞ÁªüËÆ°ÂÄºÔºàÂ¶ÇSUMÁ¥ØÂä†ÔºåCOUNT+1Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      
</span></span><span class="line"><span class="cl">      <span class="n">aht_</span><span class="p">.</span><span class="n">InsertCombine</span><span class="p">(</span><span class="n">MakeAggregateKey</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_tuple</span><span class="p">),</span> <span class="n">MakeAggregateValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">child_tuple</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊàëÁåúÊµãÔºåkey‰∏∫Á©∫Ôºå‰ΩÜÊï∞ÊçÆ‰∏ç‰∏∫Á©∫ÁöÑÊó∂ÂÄôËøôÈáå‰πüÊòØËÉΩËµ∞ÁöÑÔºåÂè™ÊúâÔºüÔºüÔºüÔºüÔºüÔºüÔºüÔºüÔºüÔºüÔºü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Â§ÑÁêÜÁâπÊÆäÊÉÖÂÜµÔºöÊ≤°ÊúâGROUP BY‰∏îÊó†Êï∞ÊçÆÊó∂‰øùËØÅËæìÂá∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">aht_</span><span class="p">.</span><span class="n">Size</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">()</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">aht_</span><span class="p">.</span><span class="n">InsertEmptyCombine</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="n">aht_iterator_</span> <span class="o">=</span> <span class="n">aht_</span><span class="p">.</span><span class="n">Begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÊâÄÊúâÊäΩÂ±âÂ∑≤ÈÅçÂéÜÔºåÂàôËøîÂõûfalse
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÁªÑË£ÖËæìÂá∫ÁªìÊûú„Äêvalues = ÂàÜÁªÑÊ†áÁ≠æ + ÁªüËÆ°ÁªìÊûú; Â¶Ç[&#34;HR&#34;, 5, 5500]„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	*tuple = ÊâìÂåÖÊàêÊï∞ÊçÆÂ∫ìË°®Ê†ºÁöÑ‰∏ÄË°å;
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">AggregationExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">aht_iterator_</span> <span class="o">==</span> <span class="n">aht_</span><span class="p">.</span><span class="n">End</span><span class="p">())</span> <span class="p">{</span><span class="c1">// ÊâÄÊúâÊäΩÂ±âÂ∑≤ÈÅçÂéÜ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ÁªÑË£ÖËæìÂá∫ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// values = ÂàÜÁªÑÊ†áÁ≠æ + ÁªüËÆ°ÁªìÊûú; Â¶Ç[&#34;HR&#34;, 5, 5500]
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      
</span></span><span class="line"><span class="cl">      <span class="n">values</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">aht_iterator_</span><span class="p">.</span><span class="n">Key</span><span class="p">().</span><span class="n">group_bys_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">aht_iterator_</span><span class="p">.</span><span class="n">Key</span><span class="p">().</span><span class="n">group_bys_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">values</span><span class="p">.</span><span class="n">insert</span><span class="p">(</span><span class="n">values</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">aht_iterator_</span><span class="p">.</span><span class="n">Val</span><span class="p">().</span><span class="n">aggregates_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">aht_iterator_</span><span class="p">.</span><span class="n">Val</span><span class="p">().</span><span class="n">aggregates_</span><span class="p">.</span><span class="n">end</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// *tuple = ÊâìÂåÖÊàêÊï∞ÊçÆÂ∫ìË°®Ê†ºÁöÑ‰∏ÄË°å;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">rid</span> <span class="o">=</span> <span class="n">tuple</span><span class="o">-&gt;</span><span class="n">GetRid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="o">++</span><span class="n">aht_iterator_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">AggregationExecutor</span><span class="o">::</span><span class="n">GetChildExecutor</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="k">const</span> <span class="n">AbstractExecutor</span> <span class="o">*</span> <span class="p">{</span> <span class="k">return</span> <span class="n">child_executor_</span><span class="p">.</span><span class="n">get</span><span class="p">();</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2 NestedLoopJoin</strong>
<strong>2.1 ÊÄùË∑Ø</strong>
ÂÆûÁé∞ÂÜÖËøûÊé•ÂíåÂ∑¶Â§ñËøûÊé•
Â∑¶Â§ñËøûÊé•ÔºöÂ∑¶ËæπÁ°ÆÂÆöÊâæÂè≥ËæπÔºåÂàÜ‰∏§ÁßçÊÉÖÂÜµÔºö1„ÄÅÊâæÂæóÂà∞ÔºöÊää‰∏§‰∏™‰∏ÄÊ†∑ÁöÑÊîæ‰∏ÄÂùó„ÄÇ2„ÄÅÊâæ‰∏çÂà∞ÔºöÂ∑¶ËæπÂÜôÂ•ΩÂè≥ËæπÊîænull„ÄÇ
ÂÜÖËøûÊé•Ôºö‰πüÊòØÂ∑¶ËæπÁ°ÆÂÆöÊâæÂè≥ËæπÔºåÊâæÂà∞Â∞±ÊîævalueÈáåÔºåÊâæ‰∏çÂà∞Â∞±‰∏çÊîæ„ÄÇ</p>
<p><strong>2.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Ë¶ÅÊâßË°åÁöÑNestedLoopJoinËÆ°ÂàíËäÇÁÇπ„ÄÇ */</span>
</span></span><span class="line"><span class="cl">  <span class="k">const</span> <span class="n">NestedLoopJoinPlanNode</span> <span class="o">*</span><span class="n">plan_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">left_executor_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** The right child executor */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">right_executor_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Â∑¶Â≠©Â≠êÁöÑ Next() ÁªìÊûú */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">left_ret_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** ‰ªéÂ∑¶Â≠©Â≠êËé∑ÂèñÂÖÉÁªÑ */</span>
</span></span><span class="line"><span class="cl">  <span class="n">Tuple</span> <span class="n">left_tuple_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** ËØ•Â∑¶ÂÖÉÁªÑÊòØÂê¶Â∑≤‰∏é‰ªª‰ΩïÂè≥ÂÖÉÁªÑÂåπÈÖç */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">bool</span> <span class="n">left_done_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">///////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">NestedLoopJoinExecutor</span><span class="o">::</span><span class="n">NestedLoopJoinExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">NestedLoopJoinPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">left_executor</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                               <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">right_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">plan_</span><span class="p">(</span><span class="n">plan</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="n">left_executor_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">left_executor</span><span class="p">)),</span>
</span></span><span class="line"><span class="cl">    <span class="n">right_executor_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">right_executor</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">//       Ê£ÄÊü•ËøûÊé•Á±ªÂûãÔºåÁõÆÂâç‰ªÖÊîØÊåÅ‰∏§ÁßçÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÂÜÖËøûÊé•ÔºàINNER JOINÔºâ‚ÄãÔºöÂè™‰øùÁïôÂåπÈÖçÁöÑË°åÔºàÂ¶ÇÂëòÂ∑•AÊúâËÆ¢ÂçïÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÂ∑¶ËøûÊé•ÔºàLEFT JOINÔºâ‚ÄãÔºö‰øùÁïôÂ∑¶Ë°®ÊâÄÊúâË°åÔºåÂè≥Ë°®Êó†ÂåπÈÖçÊó∂Â°´ÂÖÖNULLÔºàÂ¶ÇÂëòÂ∑•BÊó†ËÆ¢ÂçïÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()</span> <span class="o">==</span> <span class="n">JoinType</span><span class="o">::</span><span class="n">LEFT</span> <span class="o">||</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()</span> <span class="o">==</span> <span class="n">JoinType</span><span class="o">::</span><span class="n">INNER</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Note for 2023 Fall: You ONLY need to implement left join and inner join.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">throw</span> <span class="n">bustub</span><span class="o">::</span><span class="n">NotImplementedException</span><span class="p">(</span><span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;join type {} not supported&#34;</span><span class="p">,</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ËæìÂá∫Ê®°ÂºèÔºàOutput SchemaÔºâ‚ÄãÔºöÂÆö‰πâÊúÄÁªàÁªìÊûúÁöÑÂàóÈ°∫Â∫èÂíåÁ±ªÂûã„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">NestedLoopJoinExecutor</span><span class="o">::</span><span class="n">LeftAntiJoinTuple</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">left_tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span> <span class="p">{</span>  <span class="c1">//Â∑¶ËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">{};</span><span class="c1">// Â≠òÂÇ®ÂêàÂπ∂ÂêéÁöÑÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// reserve(100)ÂêéÔºåsizeËøòÊòØÂéüÊù•ÁöÑÔºå‰ΩÜcapacityËá≥Â∞ë‰∏∫100„ÄÇËÄåresize(100)ÂàôÂèØËÉΩÂ¢ûÂä†ÂÖÉÁ¥†ÔºåsizeÂèò‰∏∫100„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// reserveÂè™ÊòØÈ¢ÑÁïôÁ©∫Èó¥Ôºå‰∏çÂàõÂª∫ÂØπË±°ÔºåËÄåresize‰ºöÂàõÂª∫ÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">values</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 1. ÈÅçÂéÜÂ∑¶Ë°®ÁöÑÊâÄÊúâÂàóÔºåÊ∑ªÂä†Âà∞ÁªìÊûú‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">left_tuple</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">idx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// 2. ÈÅçÂéÜÂè≥Ë°®ÁöÑÊâÄÊúâÂàóÔºåÂ°´ÂÖÖ NULL ÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//ÂØπ‰∫éÂ∑¶ËøûÊé•‰∏≠‰∏çÂ≠òÂú®ÁöÑÂàóÔºåÊ∑ªÂä† NULL ÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">right_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÂè≥Ë°®ÂÖÉÁªÑ‰∏≠ÁöÑÂÄºÔºå‰ΩÜÁî±‰∫éÂ∑¶ËøûÊé•‰∏≠‰∏çÂ≠òÂú®Âè≥Ë°®ÁöÑÂÖÉÁªÑÔºåÂõ†Ê≠§Ê∑ªÂä† NULL ÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">ValueFactory</span><span class="o">::</span><span class="n">GetNullValueByType</span><span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetRightPlan</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">OutputSchema</span><span class="p">().</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">idx</span><span class="p">).</span><span class="n">GetType</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">NestedLoopJoinExecutor</span><span class="o">::</span><span class="n">InnerJoinTuple</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">left_tuple</span><span class="p">,</span> <span class="n">Tuple</span> <span class="o">*</span><span class="n">right_tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span> <span class="p">{</span>  <span class="c1">//ÂÜÖËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">  <span class="n">values</span><span class="p">.</span><span class="n">reserve</span><span class="p">(</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="c1">// 1. ÈÅçÂéÜÂ∑¶Ë°®ÁöÑÊâÄÊúâÂàóÔºåÊ∑ªÂä†Âà∞ÁªìÊûú‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">left_tuple</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">idx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 2. ÈÅçÂéÜÂè≥Ë°®ÁöÑÊâÄÊúâÂàóÔºåÊ∑ªÂä†Âà∞ÁªìÊûú‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">idx</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">idx</span> <span class="o">&lt;</span> <span class="n">right_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">idx</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ÔºàidxË°®Á§∫Á¨¨Âá†ÂàóÔºâÔºåÊâÄ‰ª•‰∏ãÈù¢Ëøô‰∏™ÂáΩÊï∞ÁöÑÊÑèÊÄùÊòØËé∑ÂèñËØ•ÂÖÉÁªÑÁ¨¨idxÂàóÁöÑÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">values</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">right_tuple</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">right_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">idx</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂêØÂä®Â∑¶Ë°®Êâ´ÊèèÔºàÂ¶ÇÂëòÂ∑•Ë°®Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂêØÂä®Âè≥Ë°®Êâ´ÊèèÔºàÂ¶ÇËÆ¢ÂçïË°®Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËØªÂèñÂ∑¶Ë°®Á¨¨‰∏ÄË°åÔºåÊ†áËÆ∞Â∑¶Ë°®ÂΩìÂâçË°åÊòØÂê¶Â§ÑÁêÜÂÆåÊØï
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="c1">//////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">NestedLoopJoinExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span><span class="c1">// { throw NotImplementedException(&#34;NestedLoopJoinExecutor is not implemented&#34;); }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span><span class="c1">// ÂêØÂä®Â∑¶Ë°®Êâ´ÊèèÔºàÂ¶ÇÂëòÂ∑•Ë°®Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">right_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span><span class="c1">// ÂêØÂä®Âè≥Ë°®Êâ´ÊèèÔºàÂ¶ÇËÆ¢ÂçïË°®Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">RID</span> <span class="n">left_rid</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">left_ret_</span> <span class="o">=</span> <span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left_rid</span><span class="p">);</span><span class="c1">// ËØªÂèñÂ∑¶Ë°®Á¨¨‰∏ÄË°å
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">left_done_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">// Ê†áËÆ∞Â∑¶Ë°®ÂΩìÂâçË°åÊòØÂê¶Â§ÑÁêÜÂÆåÊØï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="c1">//////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËøõÂÖ•Âæ™ÁéØÔºåÁõ¥Âà∞ËøîÂõûÁªìÊûúÊàñËÄÖÈÅçÂéÜÁªìÊùü
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúÂ∑¶Ë°®‰∏≠ÁöÑÂÖÉÁªÑÂ∑≤ÁªèÈÅçÂéÜÂÆåÊØïÔºåËøîÂõû falseÔºåË°®Á§∫Ê≤°ÊúâÊõ¥Â§öÁöÑÁªìÊûú‰∫Ü
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúÂè≥Ë°®‰∏≠ÁöÑÂÖÉÁªÑÂ∑≤ÁªèÈÅçÂéÜÂÆåÊØï
</span></span></span><span class="line"><span class="cl"><span class="cm">			Â¶ÇÊûúÊòØÂ∑¶ËøûÊé•‰∏îÂ∑¶Ë°®‰∏≠ÁöÑÂΩìÂâçÂÖÉÁªÑËøòÊ≤°ÊúâÂåπÈÖçÂà∞Âè≥Ë°®ÁöÑ‰ªª‰ΩïÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">				ÁîüÊàêÂ∑¶ËøûÊé•ÁªìÊûú‰∏≠‰∏çÂ≠òÂú®Âè≥Ë°®ÂÖÉÁªÑÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">				Ëé∑ÂèñÂÖÉÁªÑÁöÑ RID
</span></span></span><span class="line"><span class="cl"><span class="cm">				Ê†áËÆ∞Â∑¶Ë°®‰∏≠ÁöÑÂΩìÂâçÂÖÉÁªÑÂ∑≤ÁªèÂ§ÑÁêÜËøá
</span></span></span><span class="line"><span class="cl"><span class="cm">				ËøîÂõû trueÔºåË°®Á§∫ÊâæÂà∞‰∫Ü‰∏Ä‰∏™ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="cm">			ÈáçÊñ∞ÂàùÂßãÂåñÂè≥Ë°®ÁöÑÊâ´ÊèèÔºå‰ª•‰æøÈáçÊñ∞ÂºÄÂßãÊâ´ÊèèÂè≥Ë°®
</span></span></span><span class="line"><span class="cl"><span class="cm">			Ëé∑Âèñ‰∏ã‰∏Ä‰∏™Â∑¶Ë°®‰∏≠ÁöÑÂÖÉÁªÑÔºåÈáçÁΩÆ left_done_ Ê†áÂøó
</span></span></span><span class="line"><span class="cl"><span class="cm">			ÁªßÁª≠Âæ™ÁéØÔºåÂ∞ùËØï‰∏ã‰∏Ä‰∏™Â∑¶Ë°®‰∏≠ÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">		Âà©Áî® JOIN Êù°‰ª∂Âà§Êñ≠Â∑¶Âè≥Ë°®‰∏≠ÁöÑÂÖÉÁªÑÊòØÂê¶Êª°Ë∂≥Êù°‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúÂ∑¶Âè≥Ë°®‰∏≠ÁöÑÂÖÉÁªÑÊª°Ë∂≥ JOIN Êù°‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="cm">			ÁîüÊàêÂÜÖËøûÊé•ÁªìÊûúÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">			Ëé∑ÂèñÂÖÉÁªÑÁöÑ RID
</span></span></span><span class="line"><span class="cl"><span class="cm">			Ê†áËÆ∞Â∑¶Ë°®‰∏≠ÁöÑÂΩìÂâçÂÖÉÁªÑÂ∑≤ÁªèÂ§ÑÁêÜËøá
</span></span></span><span class="line"><span class="cl"><span class="cm">			ËøîÂõû trueÔºåË°®Á§∫ÊâæÂà∞‰∫Ü‰∏Ä‰∏™ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">NestedLoopJoinExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Tuple</span> <span class="n">right_tuple</span><span class="p">{};</span>  <span class="c1">// Áî®‰∫éÂ≠òÂÇ®Âè≥Ë°®‰∏≠ÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">RID</span> <span class="n">left_rid</span><span class="p">;</span>         <span class="c1">// Â∑¶Ë°®‰∏≠ÂΩìÂâçÂÖÉÁªÑÁöÑ RID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">RID</span> <span class="n">right_rid</span><span class="p">;</span>        <span class="c1">// Âè≥Ë°®‰∏≠ÂΩìÂâçÂÖÉÁªÑÁöÑ RID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">  <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>       <span class="c1">// ËøõÂÖ•Âæ™ÁéØÔºåÁõ¥Âà∞ËøîÂõûÁªìÊûúÊàñËÄÖÈÅçÂéÜÁªìÊùü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left_ret_</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Â¶ÇÊûúÂ∑¶Ë°®‰∏≠ÁöÑÂÖÉÁªÑÂ∑≤ÁªèÈÅçÂéÜÂÆåÊØï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>    <span class="c1">// ËøîÂõû falseÔºåË°®Á§∫Ê≤°ÊúâÊõ¥Â§öÁöÑÁªìÊûú‰∫Ü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">right_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">right_tuple</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right_rid</span><span class="p">))</span> <span class="p">{</span>  <span class="c1">// Â¶ÇÊûúÂè≥Ë°®‰∏≠ÁöÑÂÖÉÁªÑÂ∑≤ÁªèÈÅçÂéÜÂÆåÊØï
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()</span> <span class="o">==</span> <span class="n">JoinType</span><span class="o">::</span><span class="n">LEFT</span> <span class="o">&amp;&amp;</span>
</span></span><span class="line"><span class="cl">          <span class="o">!</span><span class="n">left_done_</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">// Â¶ÇÊûúÊòØÂ∑¶ËøûÊé•‰∏îÂ∑¶Ë°®‰∏≠ÁöÑÂΩìÂâçÂÖÉÁªÑËøòÊ≤°ÊúâÂåπÈÖçÂà∞Âè≥Ë°®ÁöÑ‰ªª‰ΩïÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">LeftAntiJoinTuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">);</span>  <span class="c1">// ÁîüÊàêÂ∑¶ËøûÊé•ÁªìÊûú‰∏≠‰∏çÂ≠òÂú®Âè≥Ë°®ÂÖÉÁªÑÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="o">*</span><span class="n">rid</span> <span class="o">=</span> <span class="n">tuple</span><span class="o">-&gt;</span><span class="n">GetRid</span><span class="p">();</span>                    <span class="c1">// Ëé∑ÂèñÂÖÉÁªÑÁöÑ RID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">        <span class="n">left_done_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>  <span class="c1">// Ê†áËÆ∞Â∑¶Ë°®‰∏≠ÁöÑÂΩìÂâçÂÖÉÁªÑÂ∑≤ÁªèÂ§ÑÁêÜËøá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>        <span class="c1">// ËøîÂõû trueÔºåË°®Á§∫ÊâæÂà∞‰∫Ü‰∏Ä‰∏™ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">      <span class="n">right_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>  <span class="c1">// ÈáçÊñ∞ÂàùÂßãÂåñÂè≥Ë°®ÁöÑÊâ´ÊèèÔºå‰ª•‰æøÈáçÊñ∞ÂºÄÂßãÊâ´ÊèèÂè≥Ë°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">left_ret_</span> <span class="o">=</span> <span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left_rid</span><span class="p">);</span>  <span class="c1">// Ëé∑Âèñ‰∏ã‰∏Ä‰∏™Â∑¶Ë°®‰∏≠ÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">left_done_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>                                         <span class="c1">// ÈáçÁΩÆ left_done_ Ê†áÂøó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">continue</span><span class="p">;</span>                                                   <span class="c1">// ÁªßÁª≠Âæ™ÁéØÔºåÂ∞ùËØï‰∏ã‰∏Ä‰∏™Â∑¶Ë°®‰∏≠ÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Âà©Áî® JOIN Êù°‰ª∂Âà§Êñ≠Â∑¶Âè≥Ë°®‰∏≠ÁöÑÂÖÉÁªÑÊòØÂê¶Êª°Ë∂≥Êù°‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">ret</span> <span class="o">=</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">Predicate</span><span class="p">()</span><span class="o">-&gt;</span><span class="n">EvaluateJoin</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">,</span> <span class="n">left_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">right_tuple</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="n">right_executor_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">());</span>   
</span></span><span class="line"><span class="cl">  <span class="c1">// Â¶ÇÊûúÂ∑¶Âè≥Ë°®‰∏≠ÁöÑÂÖÉÁªÑÊª°Ë∂≥ JOIN Êù°‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">ret</span><span class="p">.</span><span class="n">IsNull</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">ret</span><span class="p">.</span><span class="n">GetAs</span><span class="o">&lt;</span><span class="kt">bool</span><span class="o">&gt;</span><span class="p">())</span> <span class="p">{</span>  
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">InnerJoinTuple</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right_tuple</span><span class="p">);</span>  <span class="c1">// ÁîüÊàêÂÜÖËøûÊé•ÁªìÊûúÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="o">*</span><span class="n">rid</span> <span class="o">=</span> <span class="n">tuple</span><span class="o">-&gt;</span><span class="n">GetRid</span><span class="p">();</span>                               <span class="c1">// Ëé∑ÂèñÂÖÉÁªÑÁöÑ RID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">      <span class="n">left_done_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>  <span class="c1">// Ê†áËÆ∞Â∑¶Ë°®‰∏≠ÁöÑÂΩìÂâçÂÖÉÁªÑÂ∑≤ÁªèÂ§ÑÁêÜËøá
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>        <span class="c1">// ËøîÂõû trueÔºåË°®Á§∫ÊâæÂà∞‰∫Ü‰∏Ä‰∏™ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>task2 ÂÆåÊàêÂêéÔºåsqlËØ≠Âè•ÁöÑ7-12Â∞±ÈÉΩÂèØ‰ª•ÊµãËØï‰∫Ü</p>
<h2 id="‰ªªÂä°-3---hashjoin-ÊâßË°åÁ®ãÂ∫èÂíå‰ºòÂåñ">‰ªªÂä° #3 - HashJoin ÊâßË°åÁ®ãÂ∫èÂíå‰ºòÂåñ
</h2><p>ÊÇ®Â∞ÜÂú®‰ª•‰∏ãÊñá‰ª∂‰∏≠ÂÆåÊàêÂÆûÊñΩÔºö</p>
<ul>
<li><code>src/include/execution/hash_join_executor.h</code></li>
<li><code>src/execution/hash_join_executor.cpp</code></li>
<li><code>src/optimizer/nlj_as_hash_join.cpp</code></li>
</ul>
<p><strong>1„ÄÅHashJoin</strong>
<strong>1.1 ÊÄùË∑Ø</strong>
ÂìàÂ∏åËøûÊé•ÂåÖÊã¨‰∏§‰∏™Èò∂ÊÆµÔºöÊûÑÂª∫ÔºàbuildÔºâÈò∂ÊÆµÂíåÊé¢ÊµãÔºàprobeÔºâÈò∂ÊÆµ„ÄÇ</p>
<p>ÊûÑÂª∫Èò∂ÊÆµÔºöÈÅçÂéÜÂè≥Ë°®ÔºåÂ∞ÜÊØè‰∏™ÂÖÉÁªÑÁöÑËøûÊé•ÈîÆÂìàÂ∏åÂπ∂Â≠òÂÇ®Âú®ÂìàÂ∏åË°®‰∏≠„ÄÇ
Êé¢ÊµãÈò∂ÊÆµÔºöÈÅçÂéÜÂ∑¶Ë°®ÔºåÂØπË°®‰∏≠ÁöÑÊØè‰∏™ÂÖÉÁªÑËøõË°åÂìàÂ∏åÔºåÂπ∂Âú®ÂìàÂ∏åË°®‰∏≠Êü•ÊâæÂÖ∑ÊúâÁõ∏ÂêåÂìàÂ∏åÂÄºÁöÑÊù°ÁõÆ„ÄÇÁî±‰∫éÂè≥Ë°®ÂèØËÉΩÊúâÂ•ΩÂá†‰∏™ÂíåÂ∑¶Ë°®ÂåπÈÖçÁöÑÈÄâÈ°πÔºåÊâÄ‰ª•ËøòÈúÄË¶Å‰∏Ä‰∏™Ëø≠‰ª£Âô®</p>
<p>ÂÖ∂‰∏≠ÈúÄË¶ÅÊ≥®ÊÑèÔºåÂ¶ÇÊûúÊòØÂ∑¶ËøûÊé•ÔºåÊ≤°ÊâæÂà∞ÂØπÂ∫îÂìàÂ∏åÂÄºË¶ÅÊääÂ∑¶ËæπÂØπÂ∫îÁöÑÂè≥ËæπÂÜônull„ÄÇÂ¶ÇÊûúÊòØÂÜÖËøûÊé•ÔºåË∑≥Ëøá‰∏ã‰∏Ä‰∏™„ÄÇ</p>
<p><strong>1.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">///////////////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/** HashJoinKeyrepresents a key in an join operation */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Âø´ÈÄíÂçïÂè∑ÔºàÁî®‰∫éÂåπÈÖçÂåÖË£πÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">HashJoinKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">hash_keys_</span><span class="p">;</span><span class="c1">// Â≠òÂÇ®ËøûÊé•Â≠óÊÆµÁöÑÂÄºÔºàÂ¶ÇËÆ¢ÂçïIDÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Compares two hash joi keys for equality
</span></span></span><span class="line"><span class="cl"><span class="cm">   * @param other the other hash join key to be compared with
</span></span></span><span class="line"><span class="cl"><span class="cm">   * @return `true` if both hash join key have equivalent values
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="k">operator</span><span class="o">==</span><span class="p">(</span><span class="k">const</span> <span class="n">HashJoinKey</span> <span class="o">&amp;</span><span class="n">other</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊØîËæÉ‰∏§‰∏™ÂØπË±°ÁöÑhash_keys_ÊàêÂëò‰∏≠ÁöÑÊØè‰∏™ValueÂØπË±°ÊòØÂê¶Áõ∏Á≠â
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">other</span><span class="p">.</span><span class="n">hash_keys_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">hash_keys_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">CompareEquals</span><span class="p">(</span><span class="n">other</span><span class="p">.</span><span class="n">hash_keys_</span><span class="p">[</span><span class="n">i</span><span class="p">])</span> <span class="o">!=</span> <span class="n">CmpBool</span><span class="o">::</span><span class="n">CmpTrue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>  <span class="c1">// namespace bustub
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">std</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/** Implements std::hash on AggregateKey */</span>
</span></span><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;&gt;</span>
</span></span><span class="line"><span class="cl"><span class="c1">//  Ê†πÊçÆÈîÆÊûÑÂª∫ËÆ°ÁÆóÂìàÂ∏åË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">struct</span> <span class="nc">hash</span><span class="o">&lt;</span><span class="n">bustub</span><span class="o">::</span><span class="n">HashJoinKey</span><span class="o">&gt;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">bustub</span><span class="o">::</span><span class="n">HashJoinKey</span> <span class="o">&amp;</span><span class="n">join_key</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">size_t</span> <span class="n">curr_hash</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">key</span> <span class="p">:</span> <span class="n">join_key</span><span class="p">.</span><span class="n">hash_keys_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">key</span><span class="p">.</span><span class="n">IsNull</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ÂØπÊØè‰∏Ä‰∏™ÈùûÁ©∫ÁöÑvalueÂØπË±°ÔºåËÆ°ÁÆóÂá∫ÂÆÉÁöÑÂìàÂ∏åÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">curr_hash</span> <span class="o">=</span> <span class="n">bustub</span><span class="o">::</span><span class="n">HashUtil</span><span class="o">::</span><span class="n">CombineHashes</span><span class="p">(</span><span class="n">curr_hash</span><span class="p">,</span> <span class="n">bustub</span><span class="o">::</span><span class="n">HashUtil</span><span class="o">::</span><span class="n">HashValue</span><span class="p">(</span><span class="o">&amp;</span><span class="n">key</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">curr_hash</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="p">}</span>  <span class="c1">// namespace std
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="k">namespace</span> <span class="n">bustub</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm"> * A simplified hash table that has all the necessary functionality for join.
</span></span></span><span class="line"><span class="cl"><span class="cm"> */</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ÂàÜÊã£Ë¥ßÊû∂ÔºàÊåâÂçïÂè∑ÂàÜÂå∫ÂüüÂ≠òÊîæÂåÖË£πÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">SimpleHashJoinHashTable</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** ÊèíÂÖ•join keyÂíåtupleÊûÑÂª∫hashË°® */</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/* ÂåÖË£πÂÖ•Â∫ì */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">InsertKey</span><span class="p">(</span><span class="k">const</span> <span class="n">HashJoinKey</span> <span class="o">&amp;</span><span class="n">join_key</span><span class="p">,</span> <span class="k">const</span> <span class="n">Tuple</span> <span class="o">&amp;</span><span class="n">tuple</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê≤°ÊúâËøô‰∏™ÈîÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">ht_</span><span class="p">.</span><span class="n">count</span><span class="p">(</span><span class="n">join_key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="n">tuple_vector</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">tuple_vector</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ê∑ªÂä†ÈîÆÂíåÂØπÂ∫îÁöÑÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ht_</span><span class="p">.</span><span class="n">insert</span><span class="p">({</span><span class="n">join_key</span><span class="p">,</span> <span class="n">tuple_vector</span><span class="p">});</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ÊúâËøô‰∏™ÈîÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">ht_</span><span class="p">.</span><span class="n">at</span><span class="p">(</span><span class="n">join_key</span><span class="p">).</span><span class="n">push_back</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** Ëé∑ÂèñËØ•join keyÂØπÂ∫îÁöÑtuple */</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="nf">GetValue</span><span class="p">(</span><span class="k">const</span> <span class="n">HashJoinKey</span> <span class="o">&amp;</span><span class="n">join_key</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="o">*</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">ht_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">join_key</span><span class="p">)</span> <span class="o">==</span> <span class="n">ht_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span><span class="c1">// Ê≤°ÊúâËøô‰∏™ÈîÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ËøîÂõûÈîÆÂØπÂ∫îÁöÑÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="o">&amp;</span><span class="p">(</span><span class="n">ht_</span><span class="p">.</span><span class="n">find</span><span class="p">(</span><span class="n">join_key</span><span class="p">)</span><span class="o">-&gt;</span><span class="n">second</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="cm">/**
</span></span></span><span class="line"><span class="cl"><span class="cm">   * Clear the hash table
</span></span></span><span class="line"><span class="cl"><span class="cm">   */</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="nf">Clear</span><span class="p">()</span> <span class="p">{</span> <span class="n">ht_</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"> <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">  <span class="cm">/** The hash table is just a map from aggregate keys to aggregate values */</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">unordered_map</span><span class="o">&lt;</span><span class="n">HashJoinKey</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;&gt;</span> <span class="n">ht_</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl"><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="c1">///////////////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="k">auto</span> <span class="nf">GetLeftJoinKey</span><span class="p">(</span><span class="k">const</span> <span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HashJoinKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Ëé∑ÂèñÂ∑¶Ë°®ÁöÑÈîÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">expr</span> <span class="p">:</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">LeftJoinKeyExpressions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">expr</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span><span class="n">values</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="nf">GetRightJoinKey</span><span class="p">(</span><span class="k">const</span> <span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">HashJoinKey</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Ëé∑ÂèñÂè≥Ë°®ÁöÑÈîÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">expr</span> <span class="p">:</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">RightJoinKeyExpressions</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">expr</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="n">tuple</span><span class="p">,</span> <span class="n">right_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span><span class="n">values</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÈÅçÂéÜÂìàÂ∏åË°®ÁöÑËø≠‰ª£Âô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">jht_iterator_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂìàÂ∏åË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">SimpleHashJoinHashTable</span><span class="o">&gt;</span> <span class="n">jht_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊåáÂêëÂ∑¶Ë°®ÁöÑÊâßË°åÂô®ÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">left_child_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊåáÂêëÂè≥Ë°®ÁöÑÊâßË°åÂô®ÂØπË±°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">right_child_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tuple</span> <span class="n">left_tuple_</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">RID</span> <span class="n">left_rid_</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">right_tuple_</span><span class="p">{</span><span class="k">nullptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">    <span class="kt">bool</span> <span class="n">has_done_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Áî®Êù•Âà§Êñ≠Â∑¶ËæπËøòÊúâÊ≤°ÊúâÁ¨¶ÂêàË¶ÅÊ±ÇÁöÑÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">left_bool_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">HashJoinExecutor</span><span class="o">::</span><span class="n">HashJoinExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">HashJoinPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">left_child</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                   <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">right_child</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">this</span><span class="o">-&gt;</span><span class="n">plan_</span> <span class="o">=</span> <span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">-&gt;</span><span class="n">left_child_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">left_child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">-&gt;</span><span class="n">right_child_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">right_child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="p">(</span><span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()</span> <span class="o">==</span> <span class="n">JoinType</span><span class="o">::</span><span class="n">LEFT</span> <span class="o">||</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()</span> <span class="o">==</span> <span class="n">JoinType</span><span class="o">::</span><span class="n">INNER</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Note for 2023 Fall: You ONLY need to implement left join and inner join.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">throw</span> <span class="n">bustub</span><span class="o">::</span><span class="n">NotImplementedException</span><span class="p">(</span><span class="n">fmt</span><span class="o">::</span><span class="n">format</span><span class="p">(</span><span class="s">&#34;join type {} not supported&#34;</span><span class="p">,</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñÂ∑¶Âè≥planÁöÑÂ∑¶Âè≥Â≠©Â≠ê
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñÂ∑¶ÊâßË°åÂô®Á¨¶ÂêàÊù°‰ª∂ÁöÑÂÖÉÁªÑÔºåleft_bool_Áî®‰∫éÂà§Êñ≠Â∑¶ÊâßË°åÂô®ÊòØÂê¶ËøòÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑÂÖÉÁªÑ(Âç≥ÊòØÂê¶ÂèñÂÆåÂÖÉÁªÑ)
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÊûÑÂª∫ÂìàÂ∏åË°®„Äêjht_„ÄëÔºåÈÅçÂéÜÂ≠êÊâßË°åÂô®ÔºåÂ∞ÜÂè≥Â≠êÊâßË°åÂô®‰∏≠ÁöÑËé∑ÂèñÁöÑÊï∞ÊçÆÊèíÂÖ•Âà∞joinÂìàÂ∏åË°®‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñÂ∑¶‰æßÂÖÉÁªÑÁöÑhash keyÔºåÁÑ∂ÂêéÂú®ÂìàÂ∏åË°®‰∏≠Êü•Êâæ‰∏éÂ∑¶‰æßÂÖÉÁªÑÂåπÈÖçÁöÑÂè≥‰æßÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">	‰∏ç‰∏∫Á©∫ËØ¥ÊòéÊâæÂà∞‰∫ÜÂìàÂ∏åÂÄº‰∏ÄÊ†∑ÁöÑÔºåÊ†áËÆ∞‰∏∫trueÔºåÈò≤Ê≠¢nextÂáΩÊï∞‰∏≠ÈáçÂ§çËæìÂá∫
</span></span></span><span class="line"><span class="cl"><span class="cm">	Âê¶ÂàôÔºå Ê†áËÆ∞‰∏∫falseÔºå‰∏ªË¶ÅÁî®‰∫éÂ∑¶ËøûÊé•Ê≤°ÊúâÂåπÈÖçÁöÑÊÉÖÂÜµ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">HashJoinExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÂàùÂßãÂåñÂ∑¶Âè≥planÁöÑÂ∑¶Âè≥Â≠©Â≠ê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">right_child_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÂ∑¶ÊâßË°åÂô®Á¨¶ÂêàÊù°‰ª∂ÁöÑÂÖÉÁªÑÔºåleft_bool_Áî®‰∫éÂà§Êñ≠Â∑¶ÊâßË°åÂô®ÊòØÂê¶ËøòÊúâÁ¨¶ÂêàÊù°‰ª∂ÁöÑÂÖÉÁªÑ(Âç≥ÊòØÂê¶ÂèñÂÆåÂÖÉÁªÑ)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">left_bool_</span> <span class="o">=</span> <span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left_rid_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// NEXTÊñπÊ≥ïÁöÑËº∏Âá∫ÂèÉÊï∏ÔºåÁî®‰∫éÂ≠òÂÇ®Êü•ËØ¢ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Tuple</span> <span class="n">right_tuple</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">RID</span> <span class="n">right_rid</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÊûÑÂª∫ÂìàÂ∏åË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">jht_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">make_unique</span><span class="o">&lt;</span><span class="n">SimpleHashJoinHashTable</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈÅçÂéÜÂ≠êÊâßË°åÂô®ÔºåÂ∞ÜÂè≥Â≠êÊâßË°åÂô®‰∏≠ÁöÑËé∑ÂèñÁöÑÊï∞ÊçÆÊèíÂÖ•Âà∞joinÂìàÂ∏åË°®‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ‰∏çËÉΩÂú®HashJoinExecutorÊâßË°åÂô®ÁöÑnext‰∏≠ÂÆåÊàêÔºåÂõ†‰∏∫ÊâßË°åÂô®ÈúÄË¶ÅÂÖà‰ªéÂ≠êÊâßË°åÂô®‰∏≠Ëé∑ÂèñÊâÄÊúâÊï∞ÊçÆÔºåÁÑ∂ÂêéÂØπËøô‰∫õÊï∞ÊçÆËøõË°åjoinÔºåÊúÄÂêéÊâçËÉΩ‰∫ßÁîüËæìÂá∫ÁªìÊûú
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">right_child_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">right_tuple</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right_rid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">jht_</span><span class="o">-&gt;</span><span class="n">InsertKey</span><span class="p">(</span><span class="n">GetRightJoinKey</span><span class="p">(</span><span class="o">&amp;</span><span class="n">right_tuple</span><span class="p">),</span> <span class="n">right_tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÂ∑¶‰æßÂÖÉÁªÑÁöÑhash key
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">left_hash_key</span> <span class="o">=</span> <span class="n">GetLeftJoinKey</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Âú®ÂìàÂ∏åË°®‰∏≠Êü•Êâæ‰∏éÂ∑¶‰æßÂÖÉÁªÑÂåπÈÖçÁöÑÂè≥‰æßÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">right_tuple_</span> <span class="o">=</span> <span class="n">jht_</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">(</span><span class="n">left_hash_key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ËøôÈáåÂøÖÈ°ªÂà§Êñ≠right_tuple_ÊòØÂê¶‰∏∫Á©∫ÔºåÂê¶ÂàôÊåáÈíà‰ºöÊåáÂêëÁ©∫Âú∞ÂùÄÊä•Èîô
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ‰∏ç‰∏∫Á©∫ËØ¥ÊòéÊâæÂà∞‰∫ÜÂìàÂ∏åÂÄº‰∏ÄÊ†∑ÁöÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">right_tuple_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">jht_iterator_</span> <span class="o">=</span> <span class="n">right_tuple_</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ê†áËÆ∞‰∏∫trueÔºåÈò≤Ê≠¢nextÂáΩÊï∞‰∏≠ÈáçÂ§çËæìÂá∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">has_done_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ê†áËÆ∞‰∏∫falseÔºå‰∏ªË¶ÅÁî®‰∫éÂ∑¶ËøûÊé•Ê≤°ÊúâÂåπÈÖçÁöÑÊÉÖÂÜµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">has_done_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàõÂª∫‰∏Ä‰∏™whileÂæ™ÁéØ„ÄêÂ¶ÇÊûúÊòØÂÜÖËøûÊé•ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÁöÑÂÖÉÁªÑÔºåÂàôËØ•ËΩÆ‰∏çËæìÂá∫‰ªª‰ΩïÂÖÉÁªÑÔºå‰∏çÈúÄË¶ÅËøîÂõûÂÄºÔºåÁªßÁª≠ÂæÄ‰∏ãÊü•ÊâæÂÖ∂‰ªñÂ∑¶ÂÖÉÁªÑ„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúright_tuple_‰∏ç‰∏∫Á©∫„ÄêÂç≥Âú®init‰∏≠ÊâæÂà∞‰∫Ü„ÄëÔºå‰∏îjht_iterator_Êú™ÈÅçÂéÜÂÆå„ÄêÂç≥‰∏Ä‰∏™Â∑¶ËæπÂåπÈÖçÂ§ö‰∏™Âè≥Ëæπ„ÄëÔºåÂàôÈÅçÂéÜËæìÂá∫
</span></span></span><span class="line"><span class="cl"><span class="cm">			ÂÖàÊääÂ∑¶ËæπÁöÑÂÖÉÁªÑÊîæÂÖ•Âà∞values‰∏≠
</span></span></span><span class="line"><span class="cl"><span class="cm">			ÁÑ∂ÂêéÊääÂè≥ËæπÁöÑÂÖÉÁªÑÊîæÂÖ•Âà∞values‰∏≠„ÄêËøûÊé•Êìç‰ΩúÂè≥ËæπÂÖÉÁªÑÁöÑÂÄºÂùá‰∏ç‰∏∫nullÔºå‰∏î‰∏çÂåÖÂê´ÈáçÂ§çÁöÑÈÇ£Âàó„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â¶ÇÊûúright_tuple_‰∏∫Á©∫„ÄêÊ≤°ÊâæÂà∞„ÄëÔºåÊàñËÄÖjht_iterator_ÈÅçÂéÜÂÆåÔºå‰∏î‰∏∫Â∑¶ËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúhas_done_‰∏∫falseÔºåÂàôËØ¥ÊòéÂ∑¶ËøûÊé•Ê≤°ÊúâÂåπÈÖçÁöÑÂÖÉÁªÑÔºåÈúÄË¶ÅËæìÂá∫Âè≥ÂÖÉÁªÑ‰∏∫nullÁöÑÊÉÖÂÜµ
</span></span></span><span class="line"><span class="cl"><span class="cm">		ËøûÊé•Êìç‰ΩúÂè≥ËæπÂÖÉÁªÑÁöÑÂÄºÂùá‰∏∫null
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â¶ÇÊûú‰∏çÊòØÂ∑¶ËøûÊé•ÔºåÊàñËÄÖ‰∏∫Â∑¶ËøûÊé•Ôºå‰ΩÜÊúâÊúâÊïàËæìÂá∫ÔºåÂàôÁªßÁª≠ÈÅçÂéÜ‰∏ã‰∏Ä‰∏™Â∑¶ÂÖÉÁªÑËøõË°åÂåπÈÖç
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â∑¶ËæπÊâæ‰∏ã‰∏Ä‰∏™Êï∞ÊçÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">			‰ΩÜÂ¶ÇÊûúleft_bool_‰∏∫falseÔºåÂ∑¶ËæπÊâæÂÆå‰∫ÜÔºåËøîÂõûfalseÔºåÁªìÊùü
</span></span></span><span class="line"><span class="cl"><span class="cm">			Âèç‰πãÔºåÊõ¥Êñ∞Â∑¶ËæπÁöÑkeyÔºåÂú®ÂìàÂ∏åË°®‰∏≠Êü•Êâæ‰∏éÂ∑¶‰æßÂÖÉÁªÑÂåπÈÖçÁöÑÂè≥‰æßÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">HashJoinExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// Áî®whileÁöÑÂéüÂõ†ÔºöÂ¶ÇÊûúÊòØÂÜÖËøûÊé•ÔºåÂ¶ÇÊûúÊ≤°ÊúâÂåπÈÖçÁöÑÂÖÉÁªÑÔºåÂàôËØ•ËΩÆ‰∏çËæìÂá∫‰ªª‰ΩïÂÖÉÁªÑÔºå‰∏çÈúÄË¶ÅËøîÂõûÂÄºÔºåÁªßÁª≠ÂæÄ‰∏ãÊü•ÊâæÂÖ∂‰ªñÂ∑¶ÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="nb">true</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Â¶ÇÊûúright_tuple_‰∏ç‰∏∫Á©∫Ôºå‰∏îjht_iterator_Êú™ÈÅçÂéÜÂÆåÔºåÂàôÈÅçÂéÜËæìÂá∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// ‰∏Ä‰∏™Â∑¶ËæπÂèØËÉΩÂåπÈÖçÂ§ö‰∏™Âè≥Ëæπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">right_tuple_</span> <span class="o">!=</span> <span class="k">nullptr</span> <span class="o">&amp;&amp;</span> <span class="n">jht_iterator_</span> <span class="o">!=</span> <span class="n">right_tuple_</span><span class="o">-&gt;</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">right_tuple</span> <span class="o">=</span> <span class="o">*</span><span class="n">jht_iterator_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">left_tuple_</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËøûÊé•Êìç‰ΩúÂè≥ËæπÂÖÉÁªÑÁöÑÂÄºÂùá‰∏ç‰∏∫null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">right_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">right_tuple</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">right_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">        <span class="o">++</span><span class="n">jht_iterator_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Â¶ÇÊûúright_tuple_‰∏∫Á©∫ÔºåÊàñËÄÖjht_iterator_ÈÅçÂéÜÂÆåÔºå‰∏î‰∏∫Â∑¶ËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Â¶ÇÊûúhas_done_‰∏∫falseÔºåÂàôËØ¥ÊòéÂ∑¶ËøûÊé•Ê≤°ÊúâÂåπÈÖçÁöÑÂÖÉÁªÑÔºåÈúÄË¶ÅËæìÂá∫Âè≥ÂÖÉÁªÑ‰∏∫nullÁöÑÊÉÖÂÜµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetJoinType</span><span class="p">()</span> <span class="o">==</span> <span class="n">JoinType</span><span class="o">::</span><span class="n">LEFT</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">has_done_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Value</span><span class="o">&gt;</span> <span class="n">values</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">left_tuple_</span><span class="p">.</span><span class="n">GetValue</span><span class="p">(</span><span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">i</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ËøûÊé•Êìç‰ΩúÂè≥ËæπÂÖÉÁªÑÁöÑÂÄºÂùá‰∏∫null
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">right_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumnCount</span><span class="p">();</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">values</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="n">ValueFactory</span><span class="o">::</span><span class="n">GetNullValueByType</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">right_child_</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">().</span><span class="n">GetColumn</span><span class="p">(</span><span class="n">i</span><span class="p">).</span><span class="n">GetType</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">Tuple</span><span class="p">{</span><span class="n">values</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">GetOutputSchema</span><span class="p">()};</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_done_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Â¶ÇÊûú‰∏çÊòØÂ∑¶ËøûÊé•ÔºåÊàñËÄÖ‰∏∫Â∑¶ËøûÊé•Ôºå‰ΩÜÊúâÊúâÊïàËæìÂá∫ÔºåÂàôÁªßÁª≠ÈÅçÂéÜ‰∏ã‰∏Ä‰∏™Â∑¶ÂÖÉÁªÑËøõË°åÂåπÈÖç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// Â¶ÇÊûúleft_bool_‰∏∫falseÔºåÂ∑¶ËæπÊâæÂÆå‰∫Ü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">left_bool_</span> <span class="o">=</span> <span class="n">left_child_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">left_tuple_</span><span class="p">,</span> <span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">left_rid_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">left_bool_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ÈáçÁΩÆÂè≥ËæπÂåπÈÖçÁöÑÂÖÉÁªÑÔºå‰ª•ÂèäÊõ¥Êñ∞Ëø≠‰ª£Âô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">left_hash_key</span> <span class="o">=</span> <span class="n">GetLeftJoinKey</span><span class="p">(</span><span class="o">&amp;</span><span class="n">left_tuple_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Âú®ÂìàÂ∏åË°®‰∏≠Êü•Êâæ‰∏éÂ∑¶‰æßÂÖÉÁªÑÂåπÈÖçÁöÑÂè≥‰æßÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">right_tuple_</span> <span class="o">=</span> <span class="n">jht_</span><span class="o">-&gt;</span><span class="n">GetValue</span><span class="p">(</span><span class="n">left_hash_key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">right_tuple_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">jht_iterator_</span> <span class="o">=</span> <span class="n">right_tuple_</span><span class="o">-&gt;</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_done_</span> <span class="o">=</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">has_done_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2 NestedLoopJoin‰ºòÂåñ‰∏∫HashJoin</strong>
<strong>2.1 ÊÄùË∑Ø</strong>
Êü•ËØ¢ËÆ°ÂàíÊòØ‰ªé‰∏ãÂæÄ‰∏äÁöÑÊ†ëÂΩ¢ÁªìÊûÑÔºåÊâÄ‰ª•Ë¶ÅÁé∞Âú®ÂÅö‰∏ãÈù¢ÂÜçÊêû‰∏äÈù¢ÔºàÁî®ÈÄíÂΩíÂÆûÁé∞Ôºâ
Ê≥®ÊÑèÔºöË¶ÅÊ£ÄÊü•ÊØè‰∏™Á≠âÂÄºÊù°‰ª∂‰∏§‰æßÁöÑÂàóÂ±û‰∫éÂì™‰∏™Ë°®„ÄÇ
<strong>Ê≠•È™§Ôºö</strong>
1„ÄÅÊääÂ≠êËäÇÁÇπÁî®ÈÄíÂΩíÁöÑÊñπÂºèÊ∑ªÂä†Âà∞ optimized_children ÂàóË°®‰∏≠
2„ÄÅÁî® CloneWithChildren ÊñπÊ≥ïÂÖãÈöÜÂéüÂßãËÆ°ÂàíÔºåÂπ∂Áî®‰ºòÂåñÂêéÁöÑÂ≠êËäÇÁÇπÊõøÊç¢ÂéüÂßãÁöÑÂ≠êËäÇÁÇπ„ÄÇËøôÊ†∑Âç≥‰ΩøÂÆûÈôÖÊ≤°‰ºòÂåñÊàêÔºå‰πüËØ¥ÊòéÂ∞ùËØï‰ºòÂåñËøá‰∫Ü
3„ÄÅÁúã‰ºòÂåñ‰∏∫hashjoinÁöÑÊù°‰ª∂Êª°‰∏çÊª°Ë∂≥
4„ÄÅÊª°Ë∂≥ÂàôÊç¢Ôºå‰∏çÊª°Ë∂≥ËæìÂá∫ÂéüËÆ°Âàí</p>
<p><strong>2.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span><span class="lnt">66
</span><span class="lnt">67
</span><span class="lnt">68
</span><span class="lnt">69
</span><span class="lnt">70
</span><span class="lnt">71
</span><span class="lnt">72
</span><span class="lnt">73
</span><span class="lnt">74
</span><span class="lnt">75
</span><span class="lnt">76
</span><span class="lnt">77
</span><span class="lnt">78
</span><span class="lnt">79
</span><span class="lnt">80
</span><span class="lnt">81
</span><span class="lnt">82
</span><span class="lnt">83
</span><span class="lnt">84
</span><span class="lnt">85
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="c1">//////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">//ËøôÊÆµ‰ª£Á†ÅÁöÑ‰∏ªË¶ÅÂäüËÉΩÊòØËß£Êûê‰∏Ä‰∏™ÂåÖÂê´Â§ö‰∏™Êù°‰ª∂ÁöÑËøûÊé•Ë∞ìËØçÔºåÂπ∂ÊèêÂèñÂá∫Áî®‰∫éÂìàÂ∏åËøûÊé•ÁöÑÂ∑¶Âè≥ËøûÊé•ÈîÆË°®ËææÂºè„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">//ÂÆÉÈÄöËøáÈÄíÂΩíÂ§ÑÁêÜÈÄªËæëË°®ËææÂºèÔºàÂ¶Ç ANDÔºâÂíåËØÜÂà´ÊØîËæÉË°®ËææÂºèÔºàÂ¶Ç
</span></span></span><span class="line"><span class="cl"><span class="c1">//=ÔºâÊù•ÂÆûÁé∞Ëøô‰∏ÄÁÇπÔºå‰ªéËÄå‰∏∫‰ºòÂåñÂô®Êèê‰æõÂøÖË¶ÅÁöÑ‰ø°ÊÅØ‰ª•ËΩ¨Êç¢ÂµåÂ•óÂæ™ÁéØËøûÊé•‰∏∫ÂìàÂ∏åËøûÊé•„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// Ëß£Êûê‰∏Ä‰∏™ÈÄªËæëË°®ËææÂºèÔºåÂπ∂ÊèêÂèñÂá∫Â∑¶Âè≥‰∏§‰æßÁöÑÂÖ≥ÈîÆË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">ËøôÈáåÊòØË¶ÅÊääÊù°‰ª∂ËØ≠Âè•ÈáåÁöÑÊù°‰ª∂ËøõË°åÂàÜÁ±ª„ÄêA.id = B.id AND A.name = B.nameÊãÜÂàÜÊàê‰ø©‰∏™ÈõÜÂêàÔºåÊØè‰∏™ÈõÜÂêàÂ≠òÊîæÁùÄÂØπÂ∫îÁöÑÊù°‰ª∂„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â∞ùËØïÂ∞ÜË∞ìËØçËΩ¨Êç¢‰∏∫ÈÄªËæëË°®ËææÂºèÔºå‰∏éÊàñÈùûÔºàÁ±ª‰ººÊääandÂèòÊàê&amp;     ÔºüÔºüÔºüËøôÈáåÂèòÊç¢ÂêéÊòØ‰ªÄ‰πàÂΩ¢Âºè‰∏çÊ∏ÖÊ•öÔºå‰ΩÜÊòØÂπ∂‰∏çÂ§™ÈáçË¶ÅÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈÄíÂΩíÂàÜËß£ANDÊù°‰ª∂ÔºöÂ∞ÜA.id = B.id AND A.name = B.nameÊãÜÂàÜ‰∏∫‰∏§‰∏™Áã¨Á´ãÊù°‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â∞ùËØïÂ∞ÜË∞ìËØçËΩ¨Êç¢‰∏∫ÊØîËæÉË°®ËææÂºèÔºåËØÜÂà´Á≠âÂÄºÊØîËæÉÔºö‰ªÖÂ§ÑÁêÜ=Êìç‰ΩúÁ¨¶ÁöÑÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="cm">		Â¶ÇÊûúÊòØÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="cm">			Âå∫ÂàÜÂ∑¶Âè≥Ë°®ÂàóÔºöÈÄöËøáTupleIdxÂà§Êñ≠ÂàóÂ±û‰∫éÂ∑¶Ë°®Ôºà0ÔºâËøòÊòØÂè≥Ë°®Ôºà1Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">			Âå∫ÂàÜÊØè‰∏™Êï∞ÊçÆÂÖÉÁ¥†ÊòØ‰ªéÂ∑¶‰æßË°®ËøòÊòØÂè≥‰æßË°®ÊèêÂèñÁöÑÔºå‰æãÂ¶Ç A.id = B.idÊó∂ÔºåÁ≥ªÁªüÈúÄË¶ÅÁü•ÈÅì A.id Âíå B.id ÂàÜÂà´Â±û‰∫éÂì™‰∏™Êï∞ÊçÆÊ∫ê
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="nf">ParseAndExpression</span><span class="p">(</span><span class="k">const</span> <span class="n">AbstractExpressionRef</span> <span class="o">&amp;</span><span class="n">predicate</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AbstractExpressionRef</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">left_key_expressions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AbstractExpressionRef</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">right_key_expressions</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Â∞ùËØïÂ∞ÜË∞ìËØçËΩ¨Êç¢‰∏∫ÈÄªËæëË°®ËææÂºèÔºå‰∏éÊàñÈùûÔºàÁ±ª‰ººÊääandÂèòÊàê&amp;     ÔºüÔºüÔºüÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="o">*</span><span class="n">logic_expression_ptr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">LogicExpression</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">predicate</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="c1">// ÈÄíÂΩíÂ§ÑÁêÜÈÄªËæëÈÄªËæëË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1">// ÈÄíÂΩíÂàÜËß£ANDÊù°‰ª∂ÔºöÂ∞ÜA.id = B.id AND A.name = B.nameÊãÜÂàÜ‰∏∫‰∏§‰∏™Áã¨Á´ãÊù°‰ª∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">logic_expression_ptr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="c1">// left child
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ParseAndExpression</span><span class="p">(</span><span class="n">logic_expression_ptr</span><span class="o">-&gt;</span><span class="n">GetChildAt</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="n">left_key_expressions</span><span class="p">,</span> <span class="n">right_key_expressions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="c1">// right child
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ParseAndExpression</span><span class="p">(</span><span class="n">logic_expression_ptr</span><span class="o">-&gt;</span><span class="n">GetChildAt</span><span class="p">(</span><span class="mi">1</span><span class="p">),</span> <span class="n">left_key_expressions</span><span class="p">,</span> <span class="n">right_key_expressions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Â∞ùËØïÂ∞ÜË∞ìËØçËΩ¨Êç¢‰∏∫ÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1">// ËØÜÂà´Á≠âÂÄºÊØîËæÉÔºö‰ªÖÂ§ÑÁêÜ=Êìç‰ΩúÁ¨¶ÁöÑÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="o">*</span><span class="n">comparison_ptr</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="n">ComparisonExpression</span> <span class="o">*&gt;</span><span class="p">(</span><span class="n">predicate</span><span class="p">.</span><span class="n">get</span><span class="p">());</span>
</span></span><span class="line"><span class="cl"><span class="c1">// Â¶ÇÊûúÊòØÊØîËæÉË°®ËææÂºè
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">comparison_ptr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">column_value_1</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">ColumnValueExpression</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">comparison_ptr</span><span class="o">-&gt;</span><span class="n">GetChildAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// auto column_value_2 = dynamic_cast&lt;const ColumnValueExpression &amp;&gt;(*comparison_ptr-&gt;GetChildAt(1));
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãÂå∫ÂàÜÂ∑¶Âè≥Ë°®ÂàóÔºöÈÄöËøáTupleIdxÂà§Êñ≠ÂàóÂ±û‰∫éÂ∑¶Ë°®Ôºà0ÔºâËøòÊòØÂè≥Ë°®Ôºà1Ôºâ
</span></span></span><span class="line"><span class="cl"><span class="c1">// Âå∫ÂàÜÊØè‰∏™Êï∞ÊçÆÂÖÉÁ¥†ÊòØ‰ªéÂ∑¶‰æßË°®ËøòÊòØÂè≥‰æßË°®ÊèêÂèñÁöÑÔºå‰æãÂ¶Ç A.id = B.idÊó∂ÔºåÁ≥ªÁªüÈúÄË¶ÅÁü•ÈÅì A.id Âíå B.id ÂàÜÂà´Â±û‰∫éÂì™‰∏™Êï∞ÊçÆÊ∫ê
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">if</span> <span class="p">(</span><span class="n">column_value_1</span><span class="p">.</span><span class="n">GetTupleIdx</span><span class="p">()</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">left_key_expressions</span><span class="o">-&gt;</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">comparison_ptr</span><span class="o">-&gt;</span><span class="n">GetChildAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">right_key_expressions</span><span class="o">-&gt;</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">comparison_ptr</span><span class="o">-&gt;</span><span class="n">GetChildAt</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"><span class="n">left_key_expressions</span><span class="o">-&gt;</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">comparison_ptr</span><span class="o">-&gt;</span><span class="n">GetChildAt</span><span class="p">(</span><span class="mi">1</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">right_key_expressions</span><span class="o">-&gt;</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">comparison_ptr</span><span class="o">-&gt;</span><span class="n">GetChildAt</span><span class="p">(</span><span class="mi">0</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">Á¥¢Âºï‰ºòÂåñËøôÈÉ®ÂàÜÁöÑ‰ª£Á†ÅÂü∫Êú¨ÈÉΩÊòØ‰∏Ä‰∏™ÊÄùË∑ØÔºåÂè™Ë¶ÅÊääÈ°∫Â∫èÊü•ÊâæÈÇ£ËæπÁöÑ‰ºòÂåñÁúãÊòéÁôΩ‰∫ÜÔºåËøôÈáå‰πüÂ∞±ÂæàÁÆÄÂçï‰∫Ü„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈÄíÂΩí‰ºòÂåñÂ≠êËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëã•ÂΩìÂâçËäÇÁÇπÊòØÂµåÂ•óÂæ™ÁéØËøûÊé•ÔºåÂàôÊõøÊç¢‰∏∫ÂìàÂ∏åËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="cm">		Ëé∑ÂèñË∞ìËØçÔºåÊèêÂèñÁ≠âÂÄºËøûÊé•Êù°‰ª∂‰∏≠ÁöÑÂ∑¶Âè≥ÈîÆ
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÊèêÂèñÂ∑¶Âè≥‰∏§‰æßÂÖ≥ÈîÆË°®ËææÂºèÔºåÂàÜÂà´ÊîæÂà∞left_key_expressionsÂíåright_key_expressionsÈáå)
</span></span></span><span class="line"><span class="cl"><span class="cm">		ÂàõÂª∫ÂìàÂ∏åËøûÊé•ËÆ°ÂàíËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ËøîÂõûoptimized_plan„ÄêËøô‰∏™ÊÉÖÂÜµÊòØ‰∏ç‰∏∫ÂµåÂ•óÂæ™ÁéØËøûÊé•ÊàñËÄÖÊòØ‰ºòÂåñÂ§±Ë¥•„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">Optimizer</span><span class="o">::</span><span class="n">OptimizeNLJAsHashJoin</span><span class="p">(</span><span class="k">const</span> <span class="n">AbstractPlanNodeRef</span> <span class="o">&amp;</span><span class="n">plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractPlanNodeRef</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// TODO(student): implement NestedLoopJoin -&gt; HashJoin optimizer rule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// Note for 2023 Fall: You should support join keys of any number of conjunction of equi-condistions:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// E.g. &lt;column expr&gt; = &lt;column expr&gt; AND &lt;column expr&gt; = &lt;column expr&gt; AND ...
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//return plan;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AbstractPlanNodeRef</span><span class="o">&gt;</span> <span class="n">optimized_children</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">child</span> <span class="p">:</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetChildren</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈÄíÂΩí‰ºòÂåñÂ≠êËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">optimized_children</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">OptimizeNLJAsHashJoin</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">optimized_plan</span> <span class="o">=</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">CloneWithChildren</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">optimized_children</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// Ëã•ÂΩìÂâçËäÇÁÇπÊòØÂµåÂ•óÂæ™ÁéØËøûÊé•ÔºåÂàôÊõøÊç¢‰∏∫ÂìàÂ∏åËøûÊé•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">GetType</span><span class="p">()</span> <span class="o">==</span> <span class="n">PlanType</span><span class="o">::</span><span class="n">NestedLoopJoin</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">join_plan</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">NestedLoopJoinPlanNode</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">optimized_plan</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñË∞ìËØç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">predicate</span> <span class="o">=</span> <span class="n">join_plan</span><span class="p">.</span><span class="n">Predicate</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊèêÂèñÁ≠âÂÄºËøûÊé•Êù°‰ª∂‰∏≠ÁöÑÂ∑¶Âè≥ÈîÆ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AbstractExpressionRef</span><span class="o">&gt;</span> <span class="n">left_key_expressions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">AbstractExpressionRef</span><span class="o">&gt;</span> <span class="n">right_key_expressions</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊèêÂèñÂ∑¶Âè≥‰∏§‰æßÂÖ≥ÈîÆË°®ËææÂºèÔºåÂàÜÂà´ÊîæÂà∞left_key_expressionsÂíåright_key_expressionsÈáå)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">ParseAndExpression</span><span class="p">(</span><span class="n">predicate</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">left_key_expressions</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">right_key_expressions</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂàõÂª∫ÂìàÂ∏åËøûÊé•ËÆ°ÂàíËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">HashJoinPlanNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">join_plan</span><span class="p">.</span><span class="n">output_schema_</span><span class="p">,</span> <span class="n">join_plan</span><span class="p">.</span><span class="n">GetLeftPlan</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">                                              <span class="n">join_plan</span><span class="p">.</span><span class="n">GetRightPlan</span><span class="p">(),</span> <span class="n">left_key_expressions</span><span class="p">,</span> <span class="n">right_key_expressions</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                              <span class="n">join_plan</span><span class="p">.</span><span class="n">GetJoinType</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">optimized_plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Ëøô‰∏™ÂÆåÊàêÂêéÂèØ‰ª•ËøêË°åSQLLogicTests - #14 Âíå#15.</p>
<h2 id="‰ªªÂä°-4ÊéíÂ∫è--ÈôêÂà∂ÊâßË°åÁ®ãÂ∫è--Á™óÂè£ÂáΩÊï∞--top-n-‰ºòÂåñ">‰ªªÂä° #4ÔºöÊéíÂ∫è + ÈôêÂà∂ÊâßË°åÁ®ãÂ∫è + Á™óÂè£ÂáΩÊï∞ + Top-N ‰ºòÂåñ
</h2><p>ÊÇ®Â∞ÜÂú®‰ª•‰∏ãÊñá‰ª∂‰∏≠ÂÆåÊàêÂÆûÊñΩÔºö</p>
<ul>
<li><code>src/include/execution/sort_executor.h</code></li>
<li><code>src/execution/sort_executor.cpp</code></li>
<li><code>src/include/execution/limit_executor.h</code></li>
<li><code>src/execution/limit_executor.cpp</code></li>
<li><code>src/include/execution/topn_executor.h</code></li>
<li><code>src/execution/topn_executor.cpp</code></li>
<li><code>src/include/execution/window_function_executor.h</code></li>
<li><code>src/execution/window_function_executor.cpp</code></li>
<li><code>src/optimizer/sort_limit_as_topn.cpp</code></li>
</ul>
<p><strong>1„ÄÅSort</strong>
<strong>1.1 ÊÄùË∑Ø</strong>
Ë¶ÅÊ±ÇÔºöÈªòËÆ§ÂçáÂ∫è
InitÂáΩÊï∞ÊääÂÖÉÁªÑÈ°∫Â∫èÊéíÂ•Ω„ÄÇNextÂáΩÊï∞‰ªéÂºÄÂßã‰ΩçÁΩÆ‰∏Ä‰∏™‰∏™ËæìÂá∫</p>
<p><strong>1.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"> <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Áî®‰∫éÊéíÂ∫èÁöÑÊØîËæÉÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">Comparator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">Comparator</span><span class="p">()</span> <span class="p">{</span> <span class="n">schema_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">Comparator</span><span class="p">(</span><span class="k">const</span> <span class="n">Schema</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">OrderByType</span><span class="p">,</span> <span class="n">AbstractExpressionRef</span><span class="o">&gt;&gt;</span> <span class="n">order_bys</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="o">:</span> <span class="n">schema_</span><span class="p">(</span><span class="n">schema</span><span class="p">),</span> <span class="n">order_bys_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">order_bys</span><span class="p">))</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ÊØîËæÉ‰∏§‰∏™ÂÖÉÁªÑÁöÑÊéíÂ∫èËßÑÂàô
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">auto</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Tuple</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Tuple</span> <span class="o">&amp;</span><span class="n">t2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÈÅçÂéÜÊâÄÊúâÊéíÂ∫èÊù°‰ª∂ÔºàÂ¶ÇORDER BY age DESC, name ASCÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="k">const</span> <span class="o">&amp;</span><span class="nl">order_by</span> <span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">order_bys_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">const</span> <span class="k">auto</span> <span class="n">order_type</span> <span class="o">=</span> <span class="n">order_by</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// ‰ΩøÁî®EvaluateËé∑ÂèñÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">AbstractExpressionRef</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">order_by</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// ËÆ°ÁÆó‰∏§‰∏™ÂÖÉÁªÑÂú®ËØ•Â≠óÊÆµÁöÑÂÄºÔºàÂ¶ÇÂπ¥ÈæÑÂ≠óÊÆµÂÄºÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">Value</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">expr</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span> <span class="o">*</span><span class="n">schema_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">Value</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">expr</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span> <span class="o">*</span><span class="n">schema_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ÊØîËæÉÈÄªËæë
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// if (ÂÄºÁõ∏Á≠â) ÁªßÁª≠ÊØîËæÉ‰∏ã‰∏Ä‰∏™Â≠óÊÆµ;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// if (ÂçáÂ∫è) ËøîÂõûv1ÊòØÂê¶Â∞è‰∫év2;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// else ËøîÂõûv1ÊòØÂê¶Â§ß‰∫év2;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="k">if</span> <span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">CompareEquals</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="n">CmpBool</span><span class="o">::</span><span class="n">CmpTrue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// Â¶ÇÊûúÊòØÂçáÂ∫èÔºàASC Êàñ DEFAULTÔºâÔºåÊØîËæÉ v1 ÊòØÂê¶Â∞è‰∫é v2ÔºàCompareLessThanÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="k">if</span> <span class="p">(</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderByType</span><span class="o">::</span><span class="n">ASC</span> <span class="o">||</span> <span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderByType</span><span class="o">::</span><span class="n">DEFAULT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">v1</span><span class="p">.</span><span class="n">CompareLessThan</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="n">CmpBool</span><span class="o">::</span><span class="n">CmpTrue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// Â¶ÇÊûúÊòØÈôçÂ∫èÔºàDESCÔºâÔºåÊØîËæÉ v1 ÊòØÂê¶Â§ß‰∫é v2ÔºàCompareGreaterThanÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="k">return</span> <span class="n">v1</span><span class="p">.</span><span class="n">CompareGreaterThan</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="n">CmpBool</span><span class="o">::</span><span class="n">CmpTrue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// ‰∏§‰∏™ÂÖÉÁªÑÊâÄÊúâÈîÆÈÉΩÁõ∏Á≠â
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">   <span class="k">const</span> <span class="n">Schema</span> <span class="o">*</span><span class="n">schema_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ‰∏§‰∏™ÂèÇÊï∞ÔºöÂçáÂ∫èËøòÊòØÈôçÂ∫èÔºåÁî®ÈÇ£‰∏™ÈîÆÁöÑÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">OrderByType</span><span class="p">,</span> <span class="n">AbstractExpressionRef</span><span class="o">&gt;&gt;</span> <span class="n">order_bys_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">};</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="n">child_executor_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="n">tuples_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">   <span class="c1">// ‚ÄãÂõæ‰π¶È¶ÜÊï¥ÁêÜ‰π¶Á±ç ÁöÑÊØîÂñªÔºåÊù•ÁêÜËß£Ëøô‰∏™ÊéíÂ∫èÊâßË°åÂô®ÁöÑÂ∑•‰ΩúÂéüÁêÜ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÂÅáËÆæ‰Ω†ÊòØ‰∏Ä‰∏™Âõæ‰π¶ÁÆ°ÁêÜÂëòÔºåÁé∞Âú®ÈúÄË¶ÅÊää‰∏ÄÂ†Ü‰π±Â∫èÁöÑ‰π¶Á±çÊåâÁÖß„ÄåÂÖàÊåâ‰π¶ÂêçÂ≠óÊØçÈ°∫Â∫èÔºåÂÜçÊåâÂá∫ÁâàÂπ¥‰ªΩÂÄíÂ∫è„ÄçÁöÑËßÑÂàôÊï¥ÁêÜÂ•Ω
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">SortExecutor</span><span class="o">::</span><span class="n">SortExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">SortPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">child_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">)</span><span class="c1">// {}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">plan_</span> <span class="o">=</span> <span class="n">plan</span><span class="p">;</span><span class="c1">// ÊãøÂà∞Êï¥ÁêÜËØ¥Êòé‰π¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">child_executor_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">child_executor</span><span class="p">);</span><span class="c1">// Êé•Êî∂ÈÄÅ‰π¶Êú∫Âô®‰∫∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñÂ≠óÊâßË°åÂô®
</span></span></span><span class="line"><span class="cl"><span class="cm">	Â∞ÜË¶ÅÊéíÂ∫èÁöÑË°®ÈáåÁöÑÂÖÉÁªÑÈÉΩÊèêÂèñÂá∫Êù•
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñÊéíÂ∫èÂ≠óÊÆµ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Áî®sortËøõË°åÊéíÂ∫è
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">SortExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> <span class="c1">//{ throw NotImplementedException(&#34;SortExecutor is not implemented&#34;); }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span><span class="c1">// ÂêØÂä®ÈÄÅ‰π¶Êú∫Âô®‰∫∫
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">Tuple</span> <span class="n">tuple</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">RID</span> <span class="n">rid</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ê≠•È™§1ÔºöÊî∂ÈõÜÊâÄÊúâ‰π¶Á±ç
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuple</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">tuples_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÊéíÂ∫èÂ≠óÊÆµ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// std::vector&lt;std::pair&lt;OrderByType, AbstractExpressionRef&gt;&gt; order_bys
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">order_by</span> <span class="o">=</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetOrderBy</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÊéíÂ∫è
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">sort</span><span class="p">(</span><span class="n">tuples_</span><span class="p">.</span><span class="n">begin</span><span class="p">(),</span> <span class="n">tuples_</span><span class="p">.</span><span class="n">end</span><span class="p">(),</span> <span class="n">Comparator</span><span class="p">(</span><span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">order_by</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">    <span class="n">iter_</span> <span class="o">=</span> <span class="n">tuples_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÊåâÈ°∫Â∫è‰æùÊ¨°ËøîÂõûÊéíÂÆåÂ∫èÂêéÁöÑÂÖÉÁªÑ„Äê‰∏ÄÊ¨°ËøîÂõû‰∏Ä‰∏™„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ë∞ÉÁî®ÁöÑÊó∂ÂÄôËøîÂõûÔºå‰ªéÂ§¥Âà∞Â∞æ‰∏Ä‰∏™‰∏™ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">SortExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Ë∞ÉÁî®ÁöÑÊó∂ÂÄôËøîÂõûÔºå‰ªéÂ§¥Âà∞Â∞æ‰∏Ä‰∏™‰∏™ËøîÂõû
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">iter_</span> <span class="o">!=</span> <span class="n">tuples_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="o">*</span><span class="n">iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="o">++</span><span class="n">iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>2„ÄÅLimit Executors</strong>
<strong>2.1 ÊÄùË∑Ø</strong>
Ë¶ÅÊ±ÇÔºö ÈôêÂà∂ÂÖÉÁªÑÔºàËÆ∞ÂΩïÊàñË°åÔºâÁöÑÊï∞Èáè„ÄÇÊ≤°‰ªÄ‰πàËØ¥ÁöÑ„ÄÇ</p>
<p><strong>2.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="n">tuples_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;::</span><span class="n">iterator</span> <span class="n">iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">LimitExecutor</span><span class="o">::</span><span class="n">LimitExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">LimitPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                             <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">child_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">)</span><span class="c1">// {}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">plan_</span> <span class="o">=</span> <span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">child_executor_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">child_executor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàùÂßãÂåñÂ≠êÊâßË°åÂô®
</span></span></span><span class="line"><span class="cl"><span class="cm">	‰ªéplan‰∏≠Ëé∑ÂèñÈôêÂà∂ÁöÑÂÖÉÁªÑÊï∞
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ëé∑ÂèñÁ¨¶ÂêàÊù°‰ª∂Êï∞ÈáèÁöÑÂÖÉÁªÑÔºàÂç≥Ê≤°ËææÂà∞ÈôêÂà∂‰∏îËÉΩËé∑ÂèñÂà∞‰∏ã‰∏ÄÂÖÉÁªÑÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ë¶ÅÊòØtuples_‰∏ç‰∏∫Á©∫ÔºåÂàôËÆ©iter_ÊåáÂêëtuples_ÁöÑÂºÄÂ§¥
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">LimitExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span><span class="c1">// { throw NotImplementedException(&#34;LimitExecutor is not implemented&#34;); }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">std</span><span class="o">::</span><span class="n">size_t</span> <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÈôêÂà∂ÁöÑÂÖÉÁªÑÊï∞
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">limit</span> <span class="o">=</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetLimit</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tuple</span> <span class="n">tuple</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">RID</span> <span class="n">rid</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// Ëé∑ÂèñÁ¨¶ÂêàÊù°‰ª∂Êï∞ÈáèÁöÑÂÖÉÁªÑÔºàÊ≤°ËææÂà∞ÈôêÂà∂‰∏îËÉΩËé∑ÂèñÂà∞‰∏ã‰∏ÄÂÖÉÁªÑÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">count</span> <span class="o">&lt;</span> <span class="n">limit</span> <span class="o">&amp;&amp;</span> <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuple</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">count</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">tuples_</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tuples_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">iter_</span> <span class="o">=</span> <span class="n">tuples_</span><span class="p">.</span><span class="n">begin</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	Âú®ÈôêÂà∂Êï∞ÈáèÂÜÖÔºåË∞ÉÁî®ÂáΩÊï∞ÂêéÔºå‰æùÊ¨°ËøîÂõû‰∏Ä‰∏™ÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Ë¶ÅÊòØË∂ÖÂá∫ÈôêÂà∂ÁöÑÊï∞ÈáèÂêéÔºåËøîÂõûfalseÔºåË°®Á§∫Â§±Ë¥•„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">LimitExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">tuples_</span><span class="p">.</span><span class="n">empty</span><span class="p">()</span> <span class="o">&amp;&amp;</span> <span class="n">iter_</span> <span class="o">!=</span> <span class="n">tuples_</span><span class="p">.</span><span class="n">end</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="o">*</span><span class="n">iter_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="n">iter_</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>3„ÄÅTop-N Optimization</strong>
<strong>3.1 ÊÄùË∑Ø</strong></p>
<p>ËøôÈáåÂÆûÁé∞ÁöÑÊòØsortÂíålimitËøô‰ø©‰∏™ÁöÑÁªìÂêà‰ΩøÁî®ÔºåÊïàÁéáÊØîÂàÜÂà´ÂçïÁã¨‰ΩøÁî®sortÂíålimitË¶ÅÈ´ò</p>
<p>ÂÆÉÁöÑÂéüÁêÜÊòØÂÆûÁé∞Âä®ÊÄÅ‰øùÂ≠òÂâçn‰∏™Â§ßÔºàÊàñËÄÖÂ∞èÔºâÁöÑÂÖÉÁªÑ ÔºåÈÅçÂéÜÂÆåÊï¥‰∏™Ë°®ÁöÑÊï∞ÊçÆ‰πãÂêéÔºå‰øùÁïôÊúÄÂêéÁöÑÁ≠îÊ°àÔºõËøôÊ†∑ÂèØ‰ª•ÂÆûÁé∞Âä®ÊÄÅÁª¥Êä§ÂâçnÂ§ßÊàñËÄÖÂ∞èÁöÑÂÖÉÁªÑÊï∞ÔºåÂèØ‰ª•Âú®ÊèíÂÖ•Âêé‰ª•ÊúÄÂ∞èÁöÑ‰ª£Á†ÅÁª¥Êä§sortÂíålimitÁöÑÁªìÊûú„ÄÇ</p>
<p>ÊØîËæÉÂô®ÁöÑÂÆûÁé∞ÂíåsortÈáåÁöÑComparatorÊòØ‰∏ÄÊ†∑ÁöÑ„ÄÇ</p>
<p><strong>InitÂáΩÊï∞ÈáåÁî®</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">std</span><span class="o">::</span><span class="n">priority_queue</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">HeapComparator</span><span class="o">&gt;</span> <span class="n">heap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="n">HeapComparator</span><span class="p">(</span><span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetOrderBy</span><span class="p">()));</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÆö‰πâ‰∏Ä‰∏™ÂèØ‰ª•ÊéíÂ∫èÁöÑÔºàHeapComparatorÂÆûÁé∞Ôºâ„ÄÅÂ≠òÂÇ®top-nÂÖÉÁªÑÁöÑÂ†Ü</p>
<p><strong>3.2 ‰ª£Á†Å</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl">  <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">// Áî®‰∫éÊéíÂ∫èÁöÑÊØîËæÉÂô®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">class</span> <span class="nc">HeapComparator</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">public</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">   <span class="n">HeapComparator</span><span class="p">()</span> <span class="p">{</span> <span class="n">schema_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl">   <span class="n">HeapComparator</span><span class="p">(</span><span class="k">const</span> <span class="n">Schema</span> <span class="o">*</span><span class="n">schema</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">OrderByType</span><span class="p">,</span> <span class="n">AbstractExpressionRef</span><span class="o">&gt;&gt;</span> <span class="n">order_bys</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">       <span class="o">:</span> <span class="n">schema_</span><span class="p">(</span><span class="n">schema</span><span class="p">),</span> <span class="n">order_bys_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">order_bys</span><span class="p">))</span> <span class="p">{}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ËøôÈáåÊòØ‰ªøÂáΩÊï∞Êú∫Âà∂Ôºå‰ª•‰∏ãÊòØÁ§∫‰æã
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//  class Counter {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//   private:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//       int count = 0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//   public:
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//       int operator()() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//           return ++count;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//       }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//   };
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        
</span></span><span class="line"><span class="cl">      <span class="c1">//   int main() {
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//       Counter c1, c2;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//       std::cout &lt;&lt; c1();  // 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//       std::cout &lt;&lt; c2();  // 1ÔºàÊØè‰∏™ÂØπË±°Áã¨Á´ãÁª¥Êä§Áä∂ÊÄÅÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//   }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">auto</span> <span class="nf">operator</span><span class="p">()(</span><span class="k">const</span> <span class="n">Tuple</span> <span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span> <span class="k">const</span> <span class="n">Tuple</span> <span class="o">&amp;</span><span class="n">t2</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">     <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="k">const</span> <span class="o">&amp;</span><span class="nl">order_by</span> <span class="p">:</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">order_bys_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">       <span class="k">const</span> <span class="k">auto</span> <span class="n">order_type</span> <span class="o">=</span> <span class="n">order_by</span><span class="p">.</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// ‰ΩøÁî®EvaluateËé∑ÂèñÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="n">AbstractExpressionRef</span> <span class="n">expr</span> <span class="o">=</span> <span class="n">order_by</span><span class="p">.</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="n">Value</span> <span class="n">v1</span> <span class="o">=</span> <span class="n">expr</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t1</span><span class="p">,</span> <span class="o">*</span><span class="n">schema_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="n">Value</span> <span class="n">v2</span> <span class="o">=</span> <span class="n">expr</span><span class="o">-&gt;</span><span class="n">Evaluate</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t2</span><span class="p">,</span> <span class="o">*</span><span class="n">schema_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">       <span class="k">if</span> <span class="p">(</span><span class="n">v1</span><span class="p">.</span><span class="n">CompareEquals</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="n">CmpBool</span><span class="o">::</span><span class="n">CmpTrue</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">continue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// Â¶ÇÊûúÊòØÂçáÂ∫èÔºàASC Êàñ DEFAULTÔºâÔºåÊØîËæÉ v1 ÊòØÂê¶Â∞è‰∫é v2ÔºàCompareLessThanÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="k">if</span> <span class="p">(</span><span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderByType</span><span class="o">::</span><span class="n">ASC</span> <span class="o">||</span> <span class="n">order_type</span> <span class="o">==</span> <span class="n">OrderByType</span><span class="o">::</span><span class="n">DEFAULT</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">         <span class="k">return</span> <span class="n">v1</span><span class="p">.</span><span class="n">CompareLessThan</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="n">CmpBool</span><span class="o">::</span><span class="n">CmpTrue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">       <span class="p">}</span>
</span></span><span class="line"><span class="cl">       <span class="c1">// Â¶ÇÊûúÊòØÈôçÂ∫èÔºàDESCÔºâÔºåÊØîËæÉ v1 ÊòØÂê¶Â§ß‰∫é v2ÔºàCompareGreaterThanÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>       <span class="k">return</span> <span class="n">v1</span><span class="p">.</span><span class="n">CompareGreaterThan</span><span class="p">(</span><span class="n">v2</span><span class="p">)</span> <span class="o">==</span> <span class="n">CmpBool</span><span class="o">::</span><span class="n">CmpTrue</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">     <span class="p">}</span>
</span></span><span class="line"><span class="cl">     <span class="c1">// ‰∏§‰∏™ÂÖÉÁªÑÊâÄÊúâÈîÆÈÉΩÁõ∏Á≠â
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>     <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="p">}</span>
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl">  <span class="k">private</span><span class="o">:</span>
</span></span><span class="line"><span class="cl">   <span class="k">const</span> <span class="n">Schema</span> <span class="o">*</span><span class="n">schema_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// ‰∏§‰∏™ÂèÇÊï∞ÔºöÂçáÂ∫èËøòÊòØÈôçÂ∫èÔºåÁî®ÈÇ£‰∏™ÈîÆÁöÑÂÄº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">OrderByType</span><span class="p">,</span> <span class="n">AbstractExpressionRef</span><span class="o">&gt;&gt;</span> <span class="n">order_bys_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">};</span>
</span></span><span class="line"><span class="cl"> <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> 
</span></span><span class="line"><span class="cl"> 
</span></span><span class="line"><span class="cl"> <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÊåâÈ†ÜÂ∫èÂ≠òÂÇ®‰ºòÂÖàÈòüÂàó‰∏≠ÁöÑtuple
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="cm">/** The stack to store sorted top-n tuple*/</span>
</span></span><span class="line"><span class="cl">  <span class="n">std</span><span class="o">::</span><span class="n">stack</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span> <span class="n">top_entries_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_t</span> <span class="n">heap_size_</span><span class="p">{</span><span class="mi">0</span><span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">TopNExecutor</span><span class="o">::</span><span class="n">TopNExecutor</span><span class="p">(</span><span class="n">ExecutorContext</span> <span class="o">*</span><span class="n">exec_ctx</span><span class="p">,</span> <span class="k">const</span> <span class="n">TopNPlanNode</span> <span class="o">*</span><span class="n">plan</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                           <span class="n">std</span><span class="o">::</span><span class="n">unique_ptr</span><span class="o">&lt;</span><span class="n">AbstractExecutor</span><span class="o">&gt;</span> <span class="o">&amp;&amp;</span><span class="n">child_executor</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">AbstractExecutor</span><span class="p">(</span><span class="n">exec_ctx</span><span class="p">)</span> <span class="c1">//{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">-&gt;</span><span class="n">plan_</span> <span class="o">=</span> <span class="n">plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="k">this</span><span class="o">-&gt;</span><span class="n">child_executor_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">child_executor</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	‰ΩøÁî®‰ºòÂÖàÈòüÂàóÂ≠òÂÇ®topNÔºåÂçáÂ∫èÁî®Â§ßÈ°∂Â†ÜÔºåÈôçÂ∫èÁî®Â∞èÈ°∂Â†Ü
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈÅçÂéÜÂ≠êÊâßË°åÂô®ÔºåÂ∞ÜÂ≠êÊâßË°åÂô®ËøîÂõûÁöÑÂÖÉÁªÑÂä†ÂÖ•‰ºòÂÖàÈòüÂàó
</span></span></span><span class="line"><span class="cl"><span class="cm">		  Âõ†ÁÇ∫Âè™ÈúÄË¶ÅtopN‰∏™ÂÖÉÁªÑÔºåÊâÄ‰ª•ÂΩì‰ºòÂÖàÈòüÂàóÂ§ßÂ∞èÂ§ß‰∫étopNÊó∂ÔºåÂºπÂá∫Â†ÜÈ°∂ÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">      	ÔºàÂ¶ÇÊûúÊòØÂçáÂ∫èÔºåÂ†ÜÈ°∂ÊòØÊúÄÂ§ßÁöÑÂÖÉÁªÑÔºåÂ¶ÇÊûúÊòØÈôçÂ∫èÔºåÂ†ÜÈ°∂ÊòØÊúÄÂ∞èÁöÑÂÖÉÁªÑÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">      	 ÂçáÂ∫èÂú∫ÊôØÔºöÈúÄ‰øùÁïôÊúÄÂ∞èÁöÑN‰∏™ÂÖÉÁ¥† ‚Üí ‚Äã‰ΩøÁî®ÊúÄÂ§ßÂ†Ü‚ÄãÔºàÂ†ÜÈ°∂ÊòØÂΩìÂâçÊúÄÂ§ßÁöÑÂÖÉÁ¥†Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">      	 ÈôçÂ∫èÂú∫ÊôØÔºöÈúÄ‰øùÁïôÊúÄÂ§ßÁöÑN‰∏™ÂÖÉÁ¥† ‚Üí ‚Äã‰ΩøÁî®ÊúÄÂ∞èÂ†Ü‚ÄãÔºàÂ†ÜÈ°∂ÊòØÂΩìÂâçÊúÄÂ∞èÁöÑÂÖÉÁ¥†Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">TopNExecutor</span><span class="o">::</span><span class="n">Init</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//‰ΩøÁî®‰ºòÂÖàÈòüÂàóÂ≠òÂÇ®topNÔºåÂçáÂ∫èÁî®Â§ßÈ°∂Â†ÜÔºåÈôçÂ∫èÁî®Â∞èÈ°∂Â†Ü
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">std</span><span class="o">::</span><span class="n">priority_queue</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">Tuple</span><span class="o">&gt;</span><span class="p">,</span> <span class="n">HeapComparator</span><span class="o">&gt;</span> <span class="n">heap</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="n">HeapComparator</span><span class="p">(</span><span class="o">&amp;</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">GetOutputSchema</span><span class="p">(),</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetOrderBy</span><span class="p">()));</span>
</span></span><span class="line"><span class="cl">    <span class="n">Tuple</span> <span class="n">tuple</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="n">RID</span> <span class="n">rid</span><span class="p">{};</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//ÈÅçÂéÜÂ≠êÊâßË°åÂô®ÔºåÂ∞ÜÂ≠êÊâßË°åÂô®ËøîÂõûÁöÑÂÖÉÁªÑÂä†ÂÖ•‰ºòÂÖàÈòüÂàó
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">child_executor_</span><span class="o">-&gt;</span><span class="n">Next</span><span class="p">(</span><span class="o">&amp;</span><span class="n">tuple</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">rid</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">heap</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">tuple</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">heap_size_</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//Âõ†ÁÇ∫Âè™ÈúÄË¶ÅtopN‰∏™ÂÖÉÁªÑÔºåÊâÄ‰ª•ÂΩì‰ºòÂÖàÈòüÂàóÂ§ßÂ∞èÂ§ß‰∫étopNÊó∂ÔºåÂºπÂá∫Â†ÜÈ°∂ÂÖÉÁªÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// ÔºàÂ¶ÇÊûúÊòØÂçáÂ∫èÔºåÂ†ÜÈ°∂ÊòØÊúÄÂ§ßÁöÑÂÖÉÁªÑÔºåÂ¶ÇÊûúÊòØÈôçÂ∫èÔºåÂ†ÜÈ°∂ÊòØÊúÄÂ∞èÁöÑÂÖÉÁªÑÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// ÂçáÂ∫èÂú∫ÊôØÔºöÈúÄ‰øùÁïôÊúÄÂ∞èÁöÑN‰∏™ÂÖÉÁ¥† ‚Üí ‚Äã‰ΩøÁî®ÊúÄÂ§ßÂ†Ü‚ÄãÔºàÂ†ÜÈ°∂ÊòØÂΩìÂâçÊúÄÂ§ßÁöÑÂÖÉÁ¥†Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// ‚ÄãÈôçÂ∫èÂú∫ÊôØÔºöÈúÄ‰øùÁïôÊúÄÂ§ßÁöÑN‰∏™ÂÖÉÁ¥† ‚Üí ‚Äã‰ΩøÁî®ÊúÄÂ∞èÂ†Ü‚ÄãÔºàÂ†ÜÈ°∂ÊòØÂΩìÂâçÊúÄÂ∞èÁöÑÂÖÉÁ¥†Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">heap</span><span class="p">.</span><span class="n">size</span><span class="p">()</span> <span class="o">&gt;</span> <span class="n">plan_</span><span class="o">-&gt;</span><span class="n">GetN</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">heap_size_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">heap</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">-&gt;</span><span class="n">top_entries_</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">heap</span><span class="p">.</span><span class="n">top</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">      <span class="n">heap</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	Âà§Êñ≠top_entries_ÊòØÂê¶‰∏∫Á©∫
</span></span></span><span class="line"><span class="cl"><span class="cm">		Á©∫ÔºöÁªìÊùüÔºåËøîÂõûfalse
</span></span></span><span class="line"><span class="cl"><span class="cm">		‰∏ç‰∏∫Á©∫ÔºöÂºπÂá∫È°∂ÈÉ®ÂÖÉÁªÑÔºåËøîÂõûtureÔºåÁªìÊùü
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">TopNExecutor</span><span class="o">::</span><span class="n">Next</span><span class="p">(</span><span class="n">Tuple</span> <span class="o">*</span><span class="n">tuple</span><span class="p">,</span> <span class="n">RID</span> <span class="o">*</span><span class="n">rid</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">top_entries_</span><span class="p">.</span><span class="n">empty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="o">*</span><span class="n">tuple</span> <span class="o">=</span> <span class="n">top_entries_</span><span class="p">.</span><span class="n">top</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">top_entries_</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">TopNExecutor</span><span class="o">::</span><span class="n">GetNumInHeap</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">size_t</span> <span class="c1">//{ throw NotImplementedException(&#34;TopNExecutor is not implemented&#34;); };
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="k">return</span> <span class="n">top_entries_</span><span class="p">.</span><span class="n">size</span><span class="p">();</span> <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>3.3 ‰ºòÂåñ
Ë¶ÅÊ±ÇÔºö Â∞ÜÂ∏¶Êúâ ORDER BY + LIMIT Â≠êÂè•ÁöÑÊü•ËØ¢ËΩ¨Êç¢‰∏∫‰ΩøÁî® TopNExecutor
‰ºòÂåñÁöÑÂÆûÁé∞ÂíåÂâçÈù¢‰ºòÂåñÊàêhashjoinÁöÑÊúâÁÇπÂÉè
Ê≠•È™§Ôºö
1„ÄÅÊääÂ≠êËäÇÁÇπÁî®ÈÄíÂΩíÁöÑÊñπÂºèÊ∑ªÂä†Âà∞ optimized_children ÂàóË°®‰∏≠
2„ÄÅÁî® CloneWithChildren ÊñπÊ≥ïÂÖãÈöÜÂéüÂßãËÆ°ÂàíÔºåÂπ∂Áî®‰ºòÂåñÂêéÁöÑÂ≠êËäÇÁÇπÊõøÊç¢ÂéüÂßãÁöÑÂ≠êËäÇÁÇπ„ÄÇËøôÊ†∑Âç≥‰ΩøÂÆûÈôÖÊ≤°‰ºòÂåñÊàêÔºå‰πüËØ¥ÊòéÂ∞ùËØï‰ºòÂåñËøá‰∫Ü
3„ÄÅÁúã‰ºòÂåñ‰∏∫Top-NÁöÑÊù°‰ª∂Êª°‰∏çÊª°Ë∂≥ÔºåÂç≥ÊúâÊ≤°Êúâlimit+orderby
4„ÄÅÊª°Ë∂≥Â∞±Êç¢Ôºå‰∏çÊª°Ë∂≥ËæìÂá∫ÂéüËÆ°Âàí</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// ‚ÄãÊï∞ÊçÆÂ∫ìÊâßË°åËÆ°ÂàíÔºöÊï∞ÊçÆÂ∫ìÂ§ÑÁêÜSQLÊü•ËØ¢Êó∂Ôºå‰ºöÁîüÊàê‰∏Ä‰∏™Áî±Â§ö‰∏™ËäÇÁÇπÁªÑÊàêÁöÑÊ†ëÁä∂ÁªìÊûÑÔºàÁ±ª‰ººÂ∑•ÂéÇÊµÅÊ∞¥Á∫øÔºâÔºåÊØè‰∏™ËäÇÁÇπË¥üË¥£ÁâπÂÆöÊìç‰ΩúÔºàÂ¶ÇÊéíÂ∫è„ÄÅËøáÊª§Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// Á§∫‰æãÔºöSELECT * FROM table ORDER BY age LIMIT 10‰ºöË¢´Ëß£Êûê‰∏∫Sort‚ÜíLimitËÆ°Âàí
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚Äã‰ºòÂåñÂô®‰ΩúÁî®ÔºöÈÄöËøáÊîπÂÜôÊâßË°åËÆ°ÂàíÔºåËÆ©Êü•ËØ¢Êõ¥Âø´„ÄÅÊõ¥ÁúÅËµÑÊ∫êÔºàÂ¶ÇÂêåÂø´ÈÄíË∑ØÁ∫øËßÑÂàíÔºåÊâæÂà∞ÊúÄ‰ºòË∑ØÂæÑÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1">// ‚ÄãTopN‰ºòÂäøÔºöÁõ¥Êé•ÂèñÂâçNÊù°Êï∞ÊçÆÔºåÊØî&#34;ÂÖ®ÊéíÂ∫èÂêéÊà™Âèñ&#34;Êõ¥È´òÊïàÔºàÁ±ª‰ººÁõ¥Êé•‰ªéÊàêÁª©Âçï‰∏≠ÊâæÂâç10ÂêçÔºå‰∏çÁî®ÁªôÂÖ®Áè≠ÊéíÂÆåÊï¥ÂêçÊ¨°Ôºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl"><span class="cm">/*
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈÄíÂΩíÂ§ÑÁêÜÊâÄÊúâÂ≠êËäÇÁÇπÔºàÊ†ëÁä∂ÁªìÊûÑÈúÄË¶ÅÈÄêÂ±Ç‰ºòÂåñÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÁîüÊàê‰ºòÂåñÂêéÁöÑÊñ∞ËÆ°ÂàíËäÇÁÇπÔºàÊê∫Â∏¶Â∑≤‰ºòÂåñÁöÑÂ≠êËäÇÁÇπÔºâ
</span></span></span><span class="line"><span class="cl"><span class="cm">	Âà§Êñ≠ÂΩìÂâçËäÇÁÇπÊòØÂê¶ÊòØ&#34;Limit+Sort&#34;ÁªÑÂêà
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÂàõÂª∫Êõ¥È´òÊïàÁöÑTopNËäÇÁÇπÔºåÊõøÊç¢ÂéüÊúâÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="cm">	ÈùûLimit+SortÁªÑÂêàÂàô‰øùÊåÅÂéüÊ†∑„Äêreturn optimized_plan;„Äë
</span></span></span><span class="line"><span class="cl"><span class="cm">*/</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">Optimizer</span><span class="o">::</span><span class="n">OptimizeSortLimitAsTopN</span><span class="p">(</span><span class="k">const</span> <span class="n">AbstractPlanNodeRef</span> <span class="o">&amp;</span><span class="n">plan</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">AbstractPlanNodeRef</span> <span class="p">{</span><span class="c1">//return plan;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// TODO(student): implement sort + limit -&gt; top N optimizer rule
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// ÂØπÊâÄÊúâÂ≠êËäÇÁÇπÈÄíÂΩíÂ∫îÁî®Ëøô‰∏Ä‰ºòÂåñ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">bustub</span><span class="o">::</span><span class="n">AbstractPlanNodeRef</span><span class="o">&gt;</span> <span class="n">optimized_children</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 1. ÈÄíÂΩíÂ§ÑÁêÜÊâÄÊúâÂ≠êËäÇÁÇπÔºàÊ†ëÁä∂ÁªìÊûÑÈúÄË¶ÅÈÄêÂ±Ç‰ºòÂåñÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="nl">child</span> <span class="p">:</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">GetChildren</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">optimized_children</span><span class="p">.</span><span class="n">emplace_back</span><span class="p">(</span><span class="n">OptimizeSortLimitAsTopN</span><span class="p">(</span><span class="n">child</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// 2. ÁîüÊàê‰ºòÂåñÂêéÁöÑÊñ∞ËÆ°ÂàíËäÇÁÇπÔºàÊê∫Â∏¶Â∑≤‰ºòÂåñÁöÑÂ≠êËäÇÁÇπÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">optimized_plan</span> <span class="o">=</span> <span class="n">plan</span><span class="o">-&gt;</span><span class="n">CloneWithChildren</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">optimized_children</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// 3. Âà§Êñ≠ÂΩìÂâçËäÇÁÇπÊòØÂê¶ÊòØ&#34;Limit+Sort&#34;ÁªÑÂêà
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//    Êü•ËØ¢Ëß£ÊûêÁöÑÂ±ÇÁ∫ßÂÖ≥Á≥ª
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// SQL Êü•ËØ¢ÁöÑËØ≠Ê≥ïÈ°∫Â∫èÊòØ SELECT ‚Üí ORDER BY ‚Üí LIMITÔºå‰ΩÜÊâßË°åËÆ°ÂàíÁöÑÁîüÊàêÈ°∫Â∫èÊòØ ‚ÄãËá™Â∫ïÂêë‰∏ä ÁöÑÔºö
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>
</span></span><span class="line"><span class="cl">    <span class="c1">// ÂÖàÂØπÊï∞ÊçÆÊ∫êËøõË°åÊéíÂ∫èÔºàÁîüÊàê SORT ËäÇÁÇπÔºâÔºå
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ÂÜçÂú®ÊéíÂ∫èÁªìÊûú‰∏äÂ∫îÁî®Ë°åÊï∞ÈôêÂà∂ÔºàÁîüÊàê LIMIT ËäÇÁÇπÔºâ„ÄÇ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ‚ÄãÁ§∫‰æãÔºöSELECT * FROM table ORDER BY age LIMIT 10 ÁöÑÊâßË°åËÆ°ÂàíÊ†ë‰∏∫ LIMIT ‚Üí SORT ‚Üí TABLE_SCAN
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">GetType</span><span class="p">()</span> <span class="o">==</span> <span class="n">PlanType</span><span class="o">::</span><span class="n">Limit</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">limit_plan</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">LimitPlanNode</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">optimized_plan</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">child</span> <span class="o">=</span> <span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">children_</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span><span class="c1">// Ëé∑ÂèñLimitÁöÑÂ≠êËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">child</span><span class="o">-&gt;</span><span class="n">GetType</span><span class="p">()</span> <span class="o">==</span> <span class="n">PlanType</span><span class="o">::</span><span class="n">Sort</span><span class="p">)</span> <span class="p">{</span><span class="c1">// Â≠êËäÇÁÇπÊòØSort
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">const</span> <span class="k">auto</span> <span class="o">&amp;</span><span class="n">sort_plan</span> <span class="o">=</span> <span class="k">dynamic_cast</span><span class="o">&lt;</span><span class="k">const</span> <span class="n">SortPlanNode</span> <span class="o">&amp;&gt;</span><span class="p">(</span><span class="o">*</span><span class="n">child</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// 4. ÂàõÂª∫Êõ¥È´òÊïàÁöÑTopNËäÇÁÇπÔºåÊõøÊç¢ÂéüÊúâÁªìÊûÑ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// output_schema_-„ÄãËæìÂá∫ÁªìÊûÑ‰∏çÂèò
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// children_[0]   Â≠êËäÇÁÇπÔºàSortÁöÑÂ≠êËäÇÁÇπÔºâ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// GetOrderBy  ÁªßÊâøÊéíÂ∫èËßÑÂàô
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// limit_  ÁªßÊâøË°åÊï∞ÈôêÂà∂
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="n">std</span><span class="o">::</span><span class="n">make_shared</span><span class="o">&lt;</span><span class="n">TopNPlanNode</span><span class="o">&gt;</span><span class="p">(</span><span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">output_schema_</span><span class="p">,</span> <span class="n">optimized_plan</span><span class="o">-&gt;</span><span class="n">children_</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span>
</span></span><span class="line"><span class="cl">                                            <span class="n">sort_plan</span><span class="p">.</span><span class="n">GetOrderBy</span><span class="p">(),</span> <span class="n">limit_plan</span><span class="p">.</span><span class="n">limit_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// ÈùûLimit+SortÁªÑÂêàÂàô‰øùÊåÅÂéüÊ†∑
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">optimized_plan</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>4„ÄÅWindow Functions
4.1 ÊÄùË∑Ø
Áúã‰∏ãÂÆòÊñπ‰ªãÁªç:https://15445.courses.cs.cmu.edu/fall2023/project3/#optimizer-guide,ÂæàËØ¶ÁªÜ‰∫Ü
‰∏çÊÉ≥ÂÜô‰∫ÜÔºåÊàëË¶ÅÂá∫ÂéªÁé©„ÄÇË¶ÅÊòØÊúâ‰∫∫ÁúãÔºåÂ∏ÆÊàëÂÜô‰∫ÜÊàëÁ≤ò‰∏äÂéªÂêß</p>
<p>4.2 ‰ª£Á†Å</p>
<p>ÊúÄÂêéÊîæ‰∏™Êª°ÂàÜÊà™Âõæ„ÄÇÊúâÁöÑÂú∞ÊñπÊòéÂêéÂ§©ÊúâÁ©∫ÂÜçÂÆåÂñÑ‰∏ãÔºåÊ≤°Á©∫ÁÆó‰∫Ü„ÄÇ</p>
<p><strong>ÂèÇËÄÉÊñáÁ´†Ôºö</strong>
<a class="link" href="https://www.bilibili.com/video/BV1oH4y1c7av/?spm_id_from=333.788.videopod.sections&amp;vd_source=ea50b5eb79b04a1c97bf08e01fe873e4"  target="_blank" rel="noopener"
    >CMU 15-445 Êï∞ÊçÆÂ∫ìÂØºËÆ∫ proj3(‰∏ä) Query Execution ÂÆûÁé∞ÂÖ∑‰ΩìÁöÑSQLËØ≠Âè•_ÂìîÂì©ÂìîÂì©_bilibili</a></p>
<p><a class="link" href="https://zhuanlan.zhihu.com/p/688759885"  target="_blank" rel="noopener"
    >CMU 15-445 Bustub 2023-Fall Project 3 Query Execution ÊÄùË∑ØÂàÜ‰∫´ - Áü•‰πé</a></p>
<p><a class="link" href="https://blog.csdn.net/qq_40878302/article/details/137741785"  target="_blank" rel="noopener"
    >cmu15445 2023fall project3 ËØ¶ÁªÜËøáÁ®ãÔºà‰∏äÔºâQUERY EXECUTION_cmu15445 2023 fall project 3-CSDNÂçöÂÆ¢</a></p>
<p><a class="link" href="https://blog.csdn.net/qq_40878302?type=blog"  target="_blank" rel="noopener"
    >‰∏ØÊòØÂπ°Âä®-CSDNÂçöÂÆ¢</a></p>
<p><a class="link" href="https://blog.csdn.net/qq_40878302/article/details/138709575?spm=1001.2014.3001.5502"  target="_blank" rel="noopener"
    >cmu15445 2023fall project3 ËØ¶ÁªÜËøáÁ®ãÔºà‰∏ãÔºâQUERY EXECUTION-CSDNÂçöÂÆ¢</a></p>
<p><a class="link" href="https://blog.csdn.net/weixin_61432764/article/details/140909917"  target="_blank" rel="noopener"
    >CMU15445 (Fall 2023) Project 3 - Query Execution ÊÄùË∑ØÂàÜ‰∫´_cmu15445 2023fall project3-CSDNÂçöÂÆ¢</a></p>
<p><a class="link" href="https://zhuanlan.zhihu.com/p/679980578"  target="_blank" rel="noopener"
    >CMU15-445 2023 Fall Project0~4 ÈÄöÂÖ≥ÊÄªÁªì - Áü•‰πé</a></p>
<p><a class="link" href="https://zhuanlan.zhihu.com/p/587566135"  target="_blank" rel="noopener"
    >ÂÅö‰∏™Êï∞ÊçÆÂ∫ìÔºö2022 CMU15-445 Project3 Query Execution - Áü•‰πé</a></p>
<p><a class="link" href="https://zhuanlan.zhihu.com/p/570917775"  target="_blank" rel="noopener"
    >BusTub ÂÖªÊàêËÆ∞Ôºö‰ªéËØæÁ®ãÈ°πÁõÆÂà∞ SQL Êï∞ÊçÆÂ∫ì - Áü•‰πé</a></p>
<p><a class="link" href="https://zhuanlan.zhihu.com/p/679864362"  target="_blank" rel="noopener"
    >CMU15-445 2023 Fall Project#3 - Query Execution - Áü•‰πé</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            ÊúÄÂêéÊõ¥Êñ∞‰∫é Mar 21, 2025 21:48 &#43;0800
        </span>
    </section></footer>


    
</article>

    

    

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="1878247293/1878247293.github.io"
    data-repo-id="R_kgDONMr1fg"
    data-category="Announcements"
    data-category-id="DIC_kwDONMr1fs4CkNCD"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 ÊòéÂ§©ÂÜçËßÅ
    </section>
    
    <section class="powerby">
        ‰ΩøÁî® <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> ÊûÑÂª∫ <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<div id="aplayer"></div>

<script>
	const home = "https://1878247293.github.io/"
	const ap = new APlayer({
    container: document.getElementById('aplayer'),
	
    audio: [{
        name: 'Â§©‰∏ãÊúâÊÉÖ‰∫∫',
        artist: 'Âë®ÂçéÂÅ•',
        url: home+'music/Â§©‰∏ãÊúâÊÉÖ‰∫∫-Âë®ÂçéÂÅ•/song.mp3',
        cover: home+'music/Â§©‰∏ãÊúâÊÉÖ‰∫∫-Âë®ÂçéÂÅ•/cover.jpg',
		 
    },
	{
		
	}]
});
</script>
<style>
  body {
    background: url(https://1878247293.github.io/background/7nzi4hch.png) no-repeat center top;
    background-size: cover;
    background-attachment: fixed;
  }
</style>
<script src=https://1878247293.github.io/background/sakura.js></script>
<div id="particles-js"></div>

<script src=https://1878247293.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://1878247293.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>


<script>
const live2d_path = "https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/";

const cssPath = "https://1878247293.github.io/waifu/waifu.css"
const waifujosnPath = "https://1878247293.github.io/waifu/waifu-tips.json"
const live2dPath = "https://1878247293.github.io/waifu/live2d.min.js"

function loadExternalResource(url, type) {
	return new Promise((resolve, reject) => {
		let tag;

		if (type === "css") {
			tag = document.createElement("link");
			tag.rel = "stylesheet";
			tag.href = url;
		}
		else if (type === "js") {
			tag = document.createElement("script");
			tag.src = url;
		}
		if (tag) {
			tag.onload = () => resolve(url);
			tag.onerror = () => reject(url);
			document.head.appendChild(tag);
		}
	});
}


if (screen.width >= 768) {
	Promise.all([
		loadExternalResource(cssPath, "css"),
		loadExternalResource(live2dPath, "js"),
		loadExternalResource(live2d_path + "waifu-tips.js", "js")
	]).then(() => {
		
		initWidget({
			waifuPath: waifujosnPath,
			
			cdnPath: "https://fastly.jsdelivr.net/gh/fghrsh/live2d_api/",
			tools: ["hitokoto", "asteroids", "switch-model", "switch-texture", "photo", "info", "quit"]
		});
		initWaifuMouseEvent();
	});
}
function initWaifuMouseEvent() {
        const waifu = document.getElementById("waifu");
        let isDown = false;
        let waifuLeft;
        let mouseLeft;
        let waifuTop;
        let mouseTop;
        
        waifu.onmousedown = function (e) {
            isDown = true;
            
            waifuLeft = waifu.offsetLeft;
            mouseLeft = e.clientX;
            
            waifuTop = waifu.offsetTop;
            mouseTop = e.clientY;
        }
        
        window.onmousemove = function (e) {
            if (!isDown) {
                return;
            }
            
            let currentLeft = waifuLeft + (e.clientX - mouseLeft);
            if (currentLeft < 0) {
                currentLeft = 0;
            } else if (currentLeft > window.innerWidth - 300) {
                currentLeft = window.innerWidth - 300;
            }
            waifu.style.left = currentLeft  + "px";
            
            
            
            
            
            
            
            
        }
        
        window.onmouseup = function (e) {
            isDown = false;
        }
    }
</script>





    </body>
</html>
