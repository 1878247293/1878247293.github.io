<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content="é¡¹ç›®ç½‘å€ï¼š é¡¹ç›® #2 - å¯æ‰©å±•å“ˆå¸Œç´¢å¼• |CMU 15-445/645 ï¼šï¼š æ•°æ®åº“ç³»ç»Ÿç®€ä»‹ï¼ˆ2023 å¹´ç§‹å­£ï¼‰\nå…¨å±€æ€è·¯ï¼š æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬è¦åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­å®ç°ç£ç›˜æ”¯æŒçš„å“ˆå¸Œç´¢å¼•ï¼Œä½¿ç”¨å¯æ‰©å±•å“ˆå¸Œçš„å˜ä½“ä½œä¸ºå“ˆå¸Œæ–¹æ¡ˆï¼Œå¦‚ä¸‹å›¾ï¼š\n">
<title>cmu15445 2023 fall   p2</title>

<link rel='canonical' href='https://1878247293.github.io/p/cmu15445-2023-fall-p2/'>

<link rel="stylesheet" href="/scss/style.min.35b5cf656aeed6866c8c29f06538873b76aac06fc1c8c993b42ce1408b061e7a.css"><meta property='og:title' content="cmu15445 2023 fall   p2">
<meta property='og:description' content="é¡¹ç›®ç½‘å€ï¼š é¡¹ç›® #2 - å¯æ‰©å±•å“ˆå¸Œç´¢å¼• |CMU 15-445/645 ï¼šï¼š æ•°æ®åº“ç³»ç»Ÿç®€ä»‹ï¼ˆ2023 å¹´ç§‹å­£ï¼‰\nå…¨å±€æ€è·¯ï¼š æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬è¦åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­å®ç°ç£ç›˜æ”¯æŒçš„å“ˆå¸Œç´¢å¼•ï¼Œä½¿ç”¨å¯æ‰©å±•å“ˆå¸Œçš„å˜ä½“ä½œä¸ºå“ˆå¸Œæ–¹æ¡ˆï¼Œå¦‚ä¸‹å›¾ï¼š\n">
<meta property='og:url' content='https://1878247293.github.io/p/cmu15445-2023-fall-p2/'>
<meta property='og:site_name' content='æ˜å¤©å†è§ä¸ªäººåšå®¢'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:published_time' content='2024-11-11T15:29:00&#43;08:00'/><meta property='article:modified_time' content='2025-03-21T21:48:57&#43;08:00'/>
<meta name="twitter:title" content="cmu15445 2023 fall   p2">
<meta name="twitter:description" content="é¡¹ç›®ç½‘å€ï¼š é¡¹ç›® #2 - å¯æ‰©å±•å“ˆå¸Œç´¢å¼• |CMU 15-445/645 ï¼šï¼š æ•°æ®åº“ç³»ç»Ÿç®€ä»‹ï¼ˆ2023 å¹´ç§‹å­£ï¼‰\nå…¨å±€æ€è·¯ï¼š æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬è¦åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­å®ç°ç£ç›˜æ”¯æŒçš„å“ˆå¸Œç´¢å¼•ï¼Œä½¿ç”¨å¯æ‰©å±•å“ˆå¸Œçš„å˜ä½“ä½œä¸ºå“ˆå¸Œæ–¹æ¡ˆï¼Œå¦‚ä¸‹å›¾ï¼š\n">
    <link rel="shortcut icon" href="/favicon.ico" />

    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu6528894822542699760.png" width="300"
                            height="236" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">æ˜å¤©å†è§ä¸ªäººåšå®¢</a></h1>
            <h2 class="site-description">æ¬¢è¿æ¥åˆ°æˆ‘çš„ç½‘ç«™</h2>
        </div>
    </header><ol class="menu-social">
            
                <li>
                    <a 
                        href='https://space.bilibili.com/366783890?spm_id_from=333.1007.0.0'
                        target="_blank"
                        title="Bilibili"
                        rel="me"
                    >
                        
                        
                            <svg  xmlns="http://www.w3.org/2000/svg"  width="24"  height="24"  viewBox="0 0 24 24"  fill="none"  stroke="currentColor"  stroke-width="2"  stroke-linecap="round"  stroke-linejoin="round"  class="icon icon-tabler icons-tabler-outline icon-tabler-brand-bilibili"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M3 10a4 4 0 0 1 4 -4h10a4 4 0 0 1 4 4v6a4 4 0 0 1 -4 4h-10a4 4 0 0 1 -4 -4v-6z" /><path d="M8 3l2 3" /><path d="M16 3l-2 3" /><path d="M9 13v-2" /><path d="M15 11v2" /></svg>
                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://github.com/dashboard'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>ä¸»é¡µ</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%85%B3%E4%BA%8E/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="7" r="4" />
  <path d="M6 21v-2a4 4 0 0 1 4 -4h4a4 4 0 0 1 4 4v2" />
</svg>



                
                <span>å…³äº</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>å½’æ¡£</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>æœç´¢</span>
            </a>
        </li>
        
        
        <li >
            <a href='/%E5%8F%8B%E6%83%85%E9%93%BE%E6%8E%A5/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>å‹æƒ…é“¾æ¥</span>
            </a>
        </li>
        
        <li class="menu-bottom-section">
            <ol class="menu">

                
                    <li id="dark-mode-toggle">
                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                        <span>æš—è‰²æ¨¡å¼</span>
                    </li>
                
            </ol>
        </li>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ä»»åŠ¡-1---è¯»å†™é¡µé¢å®ˆå«">ä»»åŠ¡ #1 - è¯»/å†™é¡µé¢å®ˆå«</a></li>
    <li><a href="#ä»»åŠ¡-2---å¯æ‰©å±•å“ˆå¸Œè¡¨é¡µé¢">ä»»åŠ¡ #2 - å¯æ‰©å±•å“ˆå¸Œè¡¨é¡µé¢</a>
      <ol>
        <li><a href="#ä¸€æ•´ä½“æ€è·¯">ä¸€ã€æ•´ä½“æ€è·¯ï¼š</a></li>
        <li><a href="#äºŒhash-table-header-page">äºŒã€Hash Table Header Page</a></li>
        <li><a href="#ä¸‰hash-table-directory-page">ä¸‰ã€Hash Table Directory Page</a></li>
        <li><a href="#å››hash-table-buckethttpssocsdnnetsosearchqbucketspm1001210130017020-page">å››ã€Hash Table <a href="https://so.csdn.net/so/search?q=Bucket&amp;spm=1001.2101.3001.7020">Bucket</a> Page</a></li>
      </ol>
    </li>
    <li><a href="#ä»»åŠ¡-3---å¯æ‰©å±•å“ˆå¸Œå®ç°">ä»»åŠ¡ #3 - å¯æ‰©å±•å“ˆå¸Œå®ç°</a></li>
    <li><a href="#ä»»åŠ¡-4---å¹¶å‘æ§åˆ¶">ä»»åŠ¡ #4 - å¹¶å‘æ§åˆ¶</a></li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/cmu15445-2023-fall-p2/">cmu15445 2023 fall   p2</a>
        </h2>
    
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Nov 11, 2024</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 29 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <p>é¡¹ç›®ç½‘å€ï¼š
<a class="link" href="https://15445.courses.cs.cmu.edu/fall2023/project2/"  target="_blank" rel="noopener"
    >é¡¹ç›® #2 - å¯æ‰©å±•å“ˆå¸Œç´¢å¼• |CMU 15-445/645 ï¼šï¼š æ•°æ®åº“ç³»ç»Ÿç®€ä»‹ï¼ˆ2023 å¹´ç§‹å­£ï¼‰</a></p>
<p><strong>å…¨å±€æ€è·¯ï¼š</strong>
æ€»çš„æ¥è¯´ï¼Œæˆ‘ä»¬è¦åœ¨æ•°æ®åº“ç³»ç»Ÿä¸­å®ç°ç£ç›˜æ”¯æŒçš„å“ˆå¸Œç´¢å¼•ï¼Œä½¿ç”¨å¯æ‰©å±•å“ˆå¸Œçš„å˜ä½“ä½œä¸ºå“ˆå¸Œæ–¹æ¡ˆï¼Œå¦‚ä¸‹å›¾ï¼š</p>
<p><strong>å¯è§æ•´ä¸ªç´¢å¼•ç»“æ„è¢«åˆ†æˆäº†ä¸‰çº§ç»“æ„ï¼š</strong>
Hash Table Header Page</p>
<p>â€‹	Hash Table Directory Page</p>
<p>â€‹	Hash Table Bucket Page</p>
<p><strong>ä¹Ÿå°±æ˜¯Task #2 - Extendible Hash Table Pagesè¦å®ç°çš„ä¸‰ä¸ªéƒ¨åˆ†</strong></p>
<p>â€‹	è€Œæ•´ä¸ªå¤§ç»“æ„éƒ½æ˜¯åœ¨P1ï¼šbuffer_poolçš„åŸºç¡€ä¸Šçš„ï¼Œä¸ºäº†å®ç°ç£ç›˜æ”¯æŒï¼Œè¿›è¡ŒæŸ¥æ‰¾ï¼Œåˆ é™¤ï¼Œæ’å…¥æ“ä½œï¼Œå¿…é¡»å€Ÿç”¨buffer_pool_managerè¿™ä¸€ä¸­ä»‹æ¥è¿›è¡Œæ“ä½œï¼Œè€Œè¿™éƒ¨åˆ†å†…å®¹ä¹Ÿå°±æ˜¯æˆ‘ä»¬çš„Task #3 - Extendible Hashing Implementationï¼Œä¹Ÿæ˜¯æ•´ä¸ªP2çš„é‡ä¸­ä¹‹é‡ï¼Œéš¾ä¸­ä¹‹éš¾ï¼</p>
<p>â€‹	å›å¤´æ¥çœ‹ï¼Œæ•´ä¸ªé¡¹ç›®çš„æœ€å¤§éš¾ç‚¹æˆ‘ä¸ªäººè®¤ä¸ºåœ¨æ”¯æŒå¹¶å‘å¤šçº¿ç¨‹ä¸Šï¼Œä¸ºè¾¾æˆæ­¤ç›®çš„ï¼Œ2023 fallçš„ç‰ˆæœ¬ï¼Œ15445è¯¾ç¨‹æ–¹è¦æ±‚æˆ‘ä»¬å…ˆå®ç°ä¸€ä¸ªpage_guardæ¥ç®¡ç†buffer_poolä¸­çš„pageã€‚ä¸ºä»€ä¹ˆè¦å¼ºè°ƒç‰ˆæœ¬2023 fallå‘¢ï¼Ÿå› ä¸ºå¯¹æ¯”2022 fallç‰ˆæœ¬çš„B+ tree_index,æˆ‘ä»¬ä¼šå‘ç°ï¼Œåœ¨å®ç°å¹¶å‘å¤šçº¿ç¨‹æ—¶ï¼Œéœ€è¦å¤§é‡çš„æ‰‹åŠ¨ä¸Šé”è§£é”ï¼ŒFetchPageä¹‹åå¿…é¡»åŠæ—¶æ‰‹åŠ¨UnpinPageï¼š</p>
<p>â€‹	é’ˆå¯¹ä¸Šè¿°æƒ…å†µï¼Œ2023 fallç‰ˆæœ¬æå‡ºäº†ä¸€ç§ä¼˜åŒ–æ–¹æ¡ˆï¼Œå³ï¼šTask #1 - Read/Write Page Guardsï¼š</p>
<h2 id="ä»»åŠ¡-1---è¯»å†™é¡µé¢å®ˆå«">ä»»åŠ¡ #1 - è¯»/å†™é¡µé¢å®ˆå«
</h2><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">â€œFetchPage å’Œ NewPage å‡½æ•°è¿”å›æŒ‡å‘å·²å›ºå®šé¡µé¢çš„æŒ‡é’ˆã€‚å›ºå®šæœºåˆ¶å¯ç¡®ä¿åœ¨é¡µé¢ä¸Šä¸å†æœ‰è¯»å–å’Œå†™å…¥ä¹‹å‰ä¸ä¼šé€å‡ºé¡µé¢ã€‚è¦æŒ‡ç¤ºå†…å­˜ä¸­ä¸å†éœ€è¦è¯¥é¡µï¼Œç¨‹åºå‘˜å¿…é¡»æ‰‹åŠ¨è°ƒç”¨ UnpinPageã€‚å¦‚æœç¨‹åºå‘˜å¿˜è®°è°ƒç”¨ UnpinPageï¼Œåˆ™æ°¸è¿œä¸ä¼šå°†é¡µé¢ä»ç¼“å†²æ± ä¸­é€å‡ºã€‚ç”±äºç¼“å†²æ± ä½¿ç”¨è¾ƒå°‘çš„å¸§æ•°è¿è¡Œï¼Œå› æ­¤å°†æœ‰æ›´å¤šçš„é¡µé¢æ¢å…¥å’Œæ¢å‡ºç£ç›˜ã€‚ä¸ä»…æ€§èƒ½å—åˆ°å½±å“ï¼Œè€Œä¸” bug ä¹Ÿå¾ˆéš¾è¢«å‘ç°ã€‚æ‚¨å°†å®ç° BasicPageGuardï¼Œå®ƒå­˜å‚¨æŒ‡å‘ BufferPoolManager å’Œ Page å¯¹è±¡çš„æŒ‡é’ˆã€‚Page Guard ç¡®ä¿åœ¨ç›¸åº”çš„ Page å¯¹è±¡è¶…å‡ºèŒƒå›´æ—¶ç«‹å³è°ƒç”¨ UnpinPageã€‚â€
</span></span></code></pre></td></tr></table>
</div>
</div><p>â€‹	æ‰€ä»¥å¯è§ï¼Œå¦‚æœæˆ‘ä»¬å®Œæˆäº†Task #1 ï¼Œå¹¶åœ¨Task #3çš„å®ç°ä¸­ä¸¥æ ¼éµå®ˆå¹¶å€ŸåŠ©Task #1 ä¸­çš„ä¸‰ç§ä¸åŒç±»å‹çš„Page Guardï¼šBasicPageGuardã€ReadPageGuardå’ŒWritePageGuardï¼Œé‚£ä¹ˆTask #4 - Concurrency Controlçš„å®Œæˆæ˜¯æ°´åˆ°æ¸ æˆï¼Œä¸éœ€è¦åšé¢å¤–å·¥ä½œçš„ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">	â€œWe recommend that you complete this task by using the FetchPageWrite or FetchPageRead buffer pool API, depending on whether you want to access a page with read or write privileges. Then modify your implementation to grab and release read and write latches as necessary to implement the latch crabbing algorithm.&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å¥½ï¼Œé‚£ä¹ˆåºŸè¯å°‘è¯´ï¼Œæˆ‘ä»¬ç›´æ¥è¿›å…¥Task #1 - Read/Write Page Guardsï¼š</strong></p>
<p>â€‹	åœ¨page.cppæ–‡ä»¶é‡Œä¸»è¦å®ç°ä»¥ä¸‹ä¸‰ä¸ªç±»çš„å„ç§â€œç±»å®šä¹‰â€å‡½æ•°ï¼Œå³æ„é€ å‡½æ•°ï¼Œç§»åŠ¨æ„é€ å‡½æ•°ï¼Œç§»åŠ¨æ“ä½œç¬¦ï¼Œèµ‹å€¼æ“ä½œç¬¦ç­‰ç­‰ï¼Œå’Œc++è¯¾ç¨‹å½“æ—¶çš„å®éªŒè¯¾è¦åšçš„ä¸œè¥¿å·®ä¸å¤šï¼Œå†™èµ·æ¥ä¹Ÿå¾ˆè½»æ¾ï¼Œå…·ä½“æ€è·¯å¦‚ä¸‹ï¼ŒåŸºæœ¬ä¸Šéƒ½æ˜¯å®˜ç½‘ä»¥åŠå¤´æ–‡ä»¶é‡Œæä¾›çš„æ€è·¯ï¼š</p>
<p><strong>BasicPageGuard</strong>
BasicPageGuardæ˜¯åŸºç¡€çš„é¡µé¢ä¿æŠ¤å™¨ï¼ˆpage_guard)(å¾ˆå°¬çš„ç›´è¯‘&hellip;ï¼‰ï¼Œç”¨äºç»´æŠ¤å¯¹BufferPoolManagerå’ŒPageå¯¹è±¡çš„æŒ‡é’ˆã€‚åœ¨å…¶ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶ï¼Œå®ƒä¼šè‡ªåŠ¨è°ƒç”¨UnpinPageæ¥è§£é™¤é¡µé¢çš„å›ºå®šçŠ¶æ€ï¼Œç¡®ä¿é¡µé¢å¯ä»¥åœ¨ä¸å†éœ€è¦æ—¶è¢«ç¼“å†²æ± é©±é€ã€‚</p>
<p>æ„é€ å‡½æ•°ä¸ç§»åŠ¨æ“ä½œç¬¦ï¼šå®ç°äº†ç§»åŠ¨æ„é€ å‡½æ•°å’Œç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼Œèƒ½å¤Ÿå°†å…¶ä»–BasicPageGuardå¯¹è±¡çš„å†…å®¹è½¬ç§»åˆ°å½“å‰å®ä¾‹ï¼ŒåŒæ—¶ä¿è¯åŸå®ä¾‹çš„æŒ‡é’ˆç½®ç©ºã€‚
Drop()å‡½æ•°ï¼šç”¨äºè§£é™¤é¡µé¢çš„å›ºå®šçŠ¶æ€ï¼Œè°ƒç”¨UnpinPageæ–¹æ³•ï¼Œç¡®ä¿ä¸ä¼šå› å¿˜è®°è§£é™¤å›ºå®šè€Œå¯¼è‡´é¡µé¢ä¸€ç›´æ»ç•™åœ¨ç¼“å†²æ± ä¸­ã€‚
UpgradeReadä¸UpgradeWriteï¼šåˆ†åˆ«å‡çº§ä¸ºReadPageGuardæˆ–WritePageGuardï¼Œä»è€Œå¯ç”¨è¯»å†™é”å®šä¿æŠ¤ï¼Œåœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­ç¡®ä¿è¯»å†™çš„æ­£ç¡®æ€§ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// è¿™æ˜¯ä¸€ä¸ªåŸºæœ¬çš„é¡µé¢ä¿æŠ¤ç±»ï¼Œç”¨äºç®¡ç†å¯¹é¡µé¢çš„è®¿é—®å¹¶ç¡®ä¿åœ¨é€‚å½“çš„æ—¶å€™é‡Šæ”¾èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BasicPageGuard</span><span class="o">::</span><span class="n">BasicPageGuard</span><span class="p">(</span><span class="n">BasicPageGuard</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">noexcept</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span><span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç§»åŠ¨æ„é€ å‡½æ•°ã€‚å®ƒä»å¦ä¸€ä¸ª BasicPageGuard å¯¹è±¡ä¸­æ¥ç®¡èµ„æº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è¢«ç”¨æ¥è®¿é—®ç¼“å†²æ± ç®¡ç†å™¨çš„åŠŸèƒ½ã€‚åœ¨ä»£ç ä¸­ï¼Œå®ƒè¢«ç”¨æ¥è°ƒç”¨ BufferPoolManager çš„æ–¹æ³•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">bpm_</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">bpm_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">page_</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">page_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">is_dirty_</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">is_dirty_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">that</span><span class="p">.</span><span class="n">bpm_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">that</span><span class="p">.</span><span class="n">page_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">that</span><span class="p">.</span><span class="n">is_dirty_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span><span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// Drop æ–¹æ³•ç”¨äºé‡Šæ”¾é¡µé¢èµ„æºã€‚å®ƒè°ƒç”¨ UnpinPage æ–¹æ³•æ¥è§£é™¤å¯¹é¡µé¢çš„é©»ç•™ï¼Œå¹¶å°†èµ„æºè®¾ç½®ä¸ºæ— æ•ˆçŠ¶æ€ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">BasicPageGuard</span><span class="o">::</span><span class="n">Drop</span><span class="p">()</span> 
</span></span><span class="line"><span class="cl"><span class="p">{</span><span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bpm_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">UnpinPage</span><span class="p">(</span><span class="k">this</span><span class="o">-&gt;</span><span class="n">PageId</span><span class="p">(),</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">is_dirty_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">-&gt;</span><span class="n">bpm_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">-&gt;</span><span class="n">page_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="k">this</span><span class="o">-&gt;</span><span class="n">is_dirty_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ã€‚å®ƒå°†å½“å‰å¯¹è±¡çš„èµ„æºé‡Šæ”¾ï¼Œå¹¶ä»å¦ä¸€ä¸ªå¯¹è±¡ä¸­æ¥ç®¡èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">BasicPageGuard</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">BasicPageGuard</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">noexcept</span> <span class="o">-&gt;</span> <span class="n">BasicPageGuard</span> <span class="o">&amp;</span> <span class="c1">//{ return *this; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Drop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">bpm_</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">bpm_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">page_</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">page_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">is_dirty_</span> <span class="o">=</span> <span class="n">that</span><span class="p">.</span><span class="n">is_dirty_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">that</span><span class="p">.</span><span class="n">bpm_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">that</span><span class="p">.</span><span class="n">page_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">that</span><span class="p">.</span><span class="n">is_dirty_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// ææ„å‡½æ•°è°ƒç”¨ Drop æ–¹æ³•æ¥ç¡®ä¿åœ¨å¯¹è±¡é”€æ¯æ—¶é‡Šæ”¾èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">BasicPageGuard</span><span class="o">::~</span><span class="n">BasicPageGuard</span><span class="p">()</span><span class="c1">//{};  // NOLINT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Drop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ReadPageGuard</strong>
ReadPageGuardä¸“é—¨ç”¨äºå¤„ç†é¡µé¢çš„è¯»æ“ä½œï¼Œå¹¶åœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è‡ªåŠ¨è§£é”é¡µé¢çš„è¯»é”ï¼ˆRUnlatchï¼‰ã€‚</p>
<p>ç§»åŠ¨æ„é€ å‡½æ•°ä¸èµ‹å€¼æ“ä½œç¬¦ï¼šå…è®¸ä»å…¶ä»–ReadPageGuardå¯¹è±¡ä¸­è½¬ç§»å†…å®¹ï¼Œå¹¶ç¡®ä¿æºå¯¹è±¡çš„çŠ¶æ€è¢«é‡ç½®ã€‚
Drop()å‡½æ•°ï¼šè‡ªåŠ¨è§£é™¤é¡µé¢çš„è¯»é”ï¼Œç¡®ä¿åœ¨ReadPageGuardå¯¹è±¡é”€æ¯æ—¶é‡Šæ”¾è¯»é”ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œç”¨äºä»å¦ä¸€ä¸ª ReadPageGuard å¯¹è±¡ä¸­æ¥ç®¡èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// å¯èƒ½æ˜¯ä¸€ä¸ª BasicPageGuard ç±»å‹çš„å¯¹è±¡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ReadPageGuard</span><span class="o">::</span><span class="n">ReadPageGuard</span><span class="p">(</span><span class="n">ReadPageGuard</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="c1">//noexcept = default;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">noexcept</span> <span class="p">{</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">guard_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">guard_</span><span class="p">);</span> <span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼Œç”¨äºä»å¦ä¸€ä¸ªå¯¹è±¡ä¸­æ¥ç®¡èµ„æº
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ReadPageGuard</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">ReadPageGuard</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">noexcept</span> <span class="o">-&gt;</span> <span class="n">ReadPageGuard</span> <span class="o">&amp;</span><span class="c1">// { return *this; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Drop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">guard_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">guard_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// Drop æ–¹æ³•ç”¨äºé‡Šæ”¾é¡µé¢èµ„æºï¼Œå¹¶è§£é™¤å¯¹é¡µé¢çš„åªè¯»é”å®šã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ReadPageGuard</span><span class="o">::</span><span class="n">Drop</span><span class="p">()</span> <span class="c1">//{}
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">&amp;</span><span class="n">guard</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">guard_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">guard</span><span class="p">.</span><span class="n">page_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">guard</span><span class="p">.</span><span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">UnpinPage</span><span class="p">(</span><span class="n">guard</span><span class="p">.</span><span class="n">PageId</span><span class="p">(),</span> <span class="n">guard</span><span class="p">.</span><span class="n">is_dirty_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">guard</span><span class="p">.</span><span class="n">page_</span><span class="o">-&gt;</span><span class="n">RUnlatch</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">guard</span><span class="p">.</span><span class="n">page_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">guard</span><span class="p">.</span><span class="n">bpm_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">guard</span><span class="p">.</span><span class="n">is_dirty_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// ææ„å‡½æ•°è°ƒç”¨ Drop æ–¹æ³•æ¥ç¡®ä¿åœ¨å¯¹è±¡é”€æ¯æ—¶é‡Šæ”¾èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">ReadPageGuard</span><span class="o">::~</span><span class="n">ReadPageGuard</span><span class="p">()</span> <span class="c1">//{}  // NOLINT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Drop</span><span class="p">();</span> 
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>WritePageGuard</strong>
WritePageGuardç”¨äºé¡µé¢çš„å†™æ“ä½œï¼Œå…·æœ‰è‡ªåŠ¨ç®¡ç†å†™é”çš„åŠŸèƒ½ã€‚åœ¨é”€æ¯æ—¶è°ƒç”¨Dropæ¥è§£é™¤å†™é”ï¼ŒåŒæ—¶å°†é¡µé¢æ ‡è®°ä¸ºå·²ä¿®æ”¹ï¼ˆis_dirty_è®¾ä¸ºtrueï¼‰ã€‚</p>
<p>ç§»åŠ¨æ„é€ å‡½æ•°ä¸èµ‹å€¼æ“ä½œç¬¦ï¼šå…è®¸ä»å…¶ä»–WritePageGuardå¯¹è±¡è½¬ç§»å†…å®¹ã€‚
Drop()å‡½æ•°ï¼šåœ¨ç”Ÿå‘½å‘¨æœŸç»“æŸæ—¶è‡ªåŠ¨è§£é™¤é¡µé¢çš„å†™é”ï¼Œå¹¶è®¾ç½®è„æ ‡å¿—ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// ç§»åŠ¨æ„é€ å‡½æ•°ï¼Œç”¨äºä»å¦ä¸€ä¸ª WritePageGuard å¯¹è±¡ä¸­æ¥ç®¡èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">WritePageGuard</span><span class="o">::</span><span class="n">WritePageGuard</span><span class="p">(</span><span class="n">WritePageGuard</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span><span class="k">noexcept</span> <span class="c1">//noexcept = default;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">guard_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">guard_</span><span class="p">);</span> <span class="p">};</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// ç§»åŠ¨èµ‹å€¼è¿ç®—ç¬¦ï¼Œç”¨äºä»å¦ä¸€ä¸ªå¯¹è±¡ä¸­æ¥ç®¡èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">WritePageGuard</span><span class="o">::</span><span class="k">operator</span><span class="o">=</span><span class="p">(</span><span class="n">WritePageGuard</span> <span class="o">&amp;&amp;</span><span class="n">that</span><span class="p">)</span> <span class="k">noexcept</span> <span class="o">-&gt;</span> <span class="n">WritePageGuard</span> <span class="o">&amp;</span><span class="c1">// { return *this; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Drop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">this</span><span class="o">-&gt;</span><span class="n">guard_</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">that</span><span class="p">.</span><span class="n">guard_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="o">*</span><span class="k">this</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// Drop æ–¹æ³•ç”¨äºé‡Šæ”¾é¡µé¢èµ„æºï¼Œå¹¶è§£é™¤å¯¹é¡µé¢çš„å†™å…¥é”å®š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">WritePageGuard</span><span class="o">::</span><span class="n">Drop</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="o">&amp;</span><span class="n">guard</span> <span class="o">=</span> <span class="k">this</span><span class="o">-&gt;</span><span class="n">guard_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">guard</span><span class="p">.</span><span class="n">page_</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">guard</span><span class="p">.</span><span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">UnpinPage</span><span class="p">(</span><span class="n">guard</span><span class="p">.</span><span class="n">PageId</span><span class="p">(),</span> <span class="n">guard</span><span class="p">.</span><span class="n">is_dirty_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">guard</span><span class="p">.</span><span class="n">page_</span><span class="o">-&gt;</span><span class="n">WUnlatch</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="n">guard</span><span class="p">.</span><span class="n">page_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">guard</span><span class="p">.</span><span class="n">bpm_</span> <span class="o">=</span> <span class="k">nullptr</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">guard</span><span class="p">.</span><span class="n">is_dirty_</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// ææ„å‡½æ•°è°ƒç”¨ Drop æ–¹æ³•æ¥ç¡®ä¿åœ¨å¯¹è±¡é”€æ¯æ—¶é‡Šæ”¾èµ„æºã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="n">WritePageGuard</span><span class="o">::~</span><span class="n">WritePageGuard</span><span class="p">()</span>
</span></span><span class="line"><span class="cl"> <span class="p">{</span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">this</span><span class="o">-&gt;</span><span class="n">Drop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl"> <span class="p">}</span>  <span class="c1">// NOLINT
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">//////////////////////////////////////////////////////////////////////
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ç¼“å†²æ± ç®¡ç†å™¨</strong></p>
<p><strong>(è¿™é‡Œå¾—æä¸€ä¸‹ï¼Œå¯¹é¡µé¢çš„è¯»å†™æ˜¯é€šè¿‡å…ˆè·å–é¡µé¢çš„ä¿¡æ¯ï¼Œåœ¨å¯¹è¿™ä¸ªä¿¡æ¯è¿›è¡Œè¯»å†™ï¼Œå› æ­¤è¯»å†™æ“ä½œéœ€è¦å¯¹Fetchè¿›è¡ŒåŠ é”)</strong>
æ–°å¢çš„FetchPageBasicã€FetchPageReadå’ŒFetchPageWriteå‡½æ•°ï¼Œåˆ†åˆ«è¿”å›BasicPageGuardã€ReadPageGuardå’ŒWritePageGuardï¼Œä»¥ç®€åŒ–é¡µé¢çš„è¯»å†™é”å®šç®¡ç†ï¼š</p>
<p>FetchPageBasicï¼šæä¾›åŸºç¡€çš„é¡µé¢è·å–ä¿æŠ¤ï¼Œä¸æ¶‰åŠé”å®šæ“ä½œã€‚
FetchPageReadä¸FetchPageWriteï¼šåˆ†åˆ«åœ¨è¿”å›çš„é¡µé¢ä¸ŠåŠ è¯»é”å’Œå†™é”ï¼Œä¿è¯åœ¨å¤šçº¿ç¨‹ç¯å¢ƒä¸­é¡µé¢çš„è¯»å†™æ“ä½œå®‰å…¨ã€‚
NewPageGuardedï¼šåˆ›å»ºå¹¶è¿”å›ä¸€ä¸ªæ–°é¡µé¢çš„BasicPageGuardã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// è·å–é¡µé¢çš„ä¿æŠ¤ç‰ˆæœ¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">BufferPoolManager</span><span class="o">::</span><span class="n">FetchPageBasic</span><span class="p">(</span><span class="n">page_id_t</span> <span class="n">page_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BasicPageGuard</span> <span class="c1">//{ return {this, nullptr}; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è·å–é¡µé¢çš„åŸºæœ¬ä¿æŠ¤ç‰ˆæœ¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">pg_ptr</span> <span class="o">=</span> <span class="n">FetchPage</span><span class="p">(</span><span class="n">page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span><span class="k">this</span><span class="p">,</span> <span class="n">pg_ptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">BufferPoolManager</span><span class="o">::</span><span class="n">FetchPageRead</span><span class="p">(</span><span class="n">page_id_t</span> <span class="n">page_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">ReadPageGuard</span> <span class="c1">//{ return {this, nullptr}; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è·å–é¡µé¢çš„è¯»ä¿æŠ¤ç‰ˆæœ¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">pg_ptr</span> <span class="o">=</span> <span class="n">FetchPage</span><span class="p">(</span><span class="n">page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pg_ptr</span><span class="o">-&gt;</span><span class="n">RLatch</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">pg_ptr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span><span class="k">this</span><span class="p">,</span> <span class="n">pg_ptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">BufferPoolManager</span><span class="o">::</span><span class="n">FetchPageWrite</span><span class="p">(</span><span class="n">page_id_t</span> <span class="n">page_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">WritePageGuard</span> <span class="c1">//{ return {this, nullptr}; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è·å–é¡µé¢çš„å†™ä¿æŠ¤ç‰ˆæœ¬ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">pg_ptr</span> <span class="o">=</span> <span class="n">FetchPage</span><span class="p">(</span><span class="n">page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">pg_ptr</span><span class="o">-&gt;</span><span class="n">WLatch</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">pg_ptr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span><span class="k">this</span><span class="p">,</span> <span class="n">pg_ptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">BufferPoolManager</span><span class="o">::</span><span class="n">NewPageGuarded</span><span class="p">(</span><span class="n">page_id_t</span> <span class="o">*</span><span class="n">page_id</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">BasicPageGuard</span> <span class="c1">//{ return {this, nullptr}; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è°ƒç”¨ NewPageï¼šåˆ›å»ºæ–°é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è¿”å›ä¿æŠ¤ç‰ˆæœ¬ï¼šè¿”å›å¸¦æœ‰ä¿æŠ¤çš„é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">pg_ptr</span> <span class="o">=</span> <span class="n">NewPage</span><span class="p">(</span><span class="n">page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">pg_ptr</span> <span class="o">!=</span> <span class="k">nullptr</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">{</span><span class="k">this</span><span class="p">,</span> <span class="n">pg_ptr</span><span class="p">};</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å€¼å¾—æ³¨æ„çš„æ˜¯ï¼š</strong></p>
<p>â€‹	1.WritePageGuard::Drop() å’Œ ReadPageGuard::Drop() å‡½æ•°é‡Œè¦è¿›è¡Œè§£é”æ“ä½œï¼Œè¿™ä¸€ç‚¹å’ŒFetchPageRead/Write é‡Œé¢çš„ä¸Šé”æ“ä½œåˆšå¥½å¯¹åº”ã€‚åé¢åœ¨Task#3ä¸­è¿›è¡Œæ’å…¥åˆ é™¤æŸ¥æ‰¾ç­‰æ“ä½œæ—¶ï¼Œç”±äºæ˜¯ç´¢å¼•ç»“æ„æ˜¯ä¸‰çº§å¯æ‹“å±•çš„ï¼Œå°±éœ€è¦æˆ‘ä»¬è°¨æ…å°å¿ƒçš„å±‚å±‚å‰¥ç¬‹å¼çš„å…ˆä»Hash Table Header Pageç»ç”± Hash Table Directory Pageæœ€ååˆ°è¾¾Hash Table Bucket Page ï¼Œå†è¿›è¡Œå„ç§æ“ä½œã€‚è€Œè¿™æ•´ä¸ªè¿‡ç¨‹ï¼Œéƒ½å¾—ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œé‚£ä¹ˆå°±å…¨ä¾èµ–äºtask1å®ç°çš„åŸºç¡€ã€‚</p>
<p>â€‹			Task#1éš¾åº¦ä¸å¤§ï¼Œä»”ç»†ç ”è¯»page.hä»¥åŠpage_guard.hçš„è¯ä¼šå¾ˆå¥½å®ç°ã€‚</p>
<p>â€‹	2.å‰é¢å†™ä»£ç ä¸€å®šè¦è°¨æ…å°å¿ƒï¼Œæ¯ä¸€ä¸ªå‡½æ•°éƒ½è¦å†™ä»”ç»†ï¼ŒåŒ…æ‹¬P1å¦‚æœæœ‰ç‘•ç–µï¼Œä¹Ÿè¦åŠæ—¶æ›´æ”¹å®Œå–„ï¼Œä¸ç„¶æ”’åˆ°æœ€åå†™å®ŒP2åœ¨çº¿æäº¤çš„æ—¶å€™ï¼Œä¸€ä¸‹å­æ¶‰åŠäºŒåå‡ ä¸ªæ–‡ä»¶ï¼ŒDEBUGéš¾åº¦ååˆ†ä¹‹å¤§ï¼Œåç‰¢æ„Ÿååˆ†ä¹‹å¼ºï¼</p>
<h2 id="ä»»åŠ¡-2---å¯æ‰©å±•å“ˆå¸Œè¡¨é¡µé¢">ä»»åŠ¡ #2 - å¯æ‰©å±•å“ˆå¸Œè¡¨é¡µé¢
</h2><h3 id="ä¸€æ•´ä½“æ€è·¯">ä¸€ã€æ•´ä½“æ€è·¯ï¼š
</h3><p>â€‹		æœ¬èŠ‚ä¸»è¦æ˜¯è¦å®ç°ä¸‰çº§å¯æ‹“å±•å“ˆå¸Œçš„æ¯ä¸€å±‚ç»“æ„ï¼ˆå¦‚ä¸‹å›¾ï¼‰ã€‚ä»£ç éš¾åº¦ä¸å¤§ï¼Œä¸»è¦æ˜¯å¾—ç†è§£ä¸€ä¸ªæ“ä½œå®ç°çš„æ—¶å€™ï¼Œä¾æ¬¡åœ¨ä¸‰å±‚ç»“æ„ä¸­çš„å†ç¨‹ï¼Œä»¥åŠâ€œæ‹†åˆ†â€â€œæ‰©å±•â€æ—¶å“ˆå¸Œç»“æ„çš„åŠ¨æ€å˜åŒ–ã€‚ä¾‹å¦‚åœ¨æ‰§è¡Œæ’å…¥æ“ä½œæ—¶ï¼Œç¬¬ä¸€çº§æ˜¯<strong>headeré‡‡ç”¨hashå€¼çš„é«˜ä½å†³å®šå°†key-valueæ’å…¥åˆ°</strong>å“ªä¸ªdirectoryï¼Œç¬¬äºŒçº§æ˜¯dierctoryï¼Œç¬¬äºŒçº§é‡‡ç”¨<strong>hashå€¼çš„ä½ä½å†³</strong>å®šå°†key-valueæ’å…¥åˆ°å“ªä¸ªbucketï¼Œæœ€åæ‰¾åˆ°bucketåå°†key-valueé”®å€¼å¯¹æ’å…¥ã€‚</p>
<p>â€‹		è¿™é‡Œå…ˆè¯´æ˜ä»¥ä¸‹ï¼Œheaderå’Œdirectoryçš„maxdepthä»¥åŠbucketçš„sizeæ˜¯æå‰äººä¸ºè®¾ç½®çš„ï¼Œä¸æ˜¯åŠ¨æ€å˜åŒ–çš„ï¼ˆbuckeçš„å¤§å°æ˜¯å›ºå®šçš„ï¼Œä¸æ˜¯2^localï¼‰ï¼Œè¿™é‡Œæ³¨æ„ä¸€ä¸‹ï¼Œlocalåªä»£è¡¨bucketä¸­çš„keyçš„åå‡ ä½ä¸­ï¼Œæœ‰å‡ ä½æ˜¯ç›¸åŒçš„ã€‚2^(global-local)ä¸ºæ¯ä¸ªæ¡¶çš„æœ€å¤§è¢«directoryæŒ‡å‘çš„æ•°é‡ã€‚</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319155413932.png"
	width="733"
	height="393"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319155413932_hu6246214778629329909.png 480w, /p/cmu15445-2023-fall-p2/image-20250319155413932_hu7835080334551719259.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="186"
		data-flex-basis="447px"
	
></p>
<h3 id="äºŒhash-table-header-page">äºŒã€Hash Table Header Page
</h3><p>è¿™éƒ¨åˆ†æ•´ä½“å¾ˆç®€å•ï¼Œå¤§å®¶ç»†å¿ƒæŒ‰.hæ–‡ä»¶æ³¨é‡Šå®Œæˆå³å¯</p>
<p>è¿™é‡Œæä¾›ä¸€ç§HashToDirectoryIndexï¼ˆï¼‰å‡½æ•°çš„å®ç°ï¼š</p>
<p>â€‹		æ³¨ï¼šè¿™é‡Œçš„idxä¸ºç´¢å¼•ï¼Œä»£è¡¨ç€ä»å¤´åˆ°ç›®å½•å¯¹åº”æ•°ç»„ä¸‹çš„ç´¢å¼•ï¼›è€Œidæ˜¯é¡µé¢idï¼Œæ˜¯å”¯ä¸€çš„ã€‚</p>
<p>â€‹				ç„¶åè¿™é‡Œä½¿ç”¨çš„æ˜¯directory_page_ids_æ•°ç»„ï¼Œé€šè¿‡ç´¢å¼•è·å¾—å¯¹åº”çš„é¡µé¢idã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ExtendibleHTableHeaderPage</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">max_depth</span><span class="p">)</span> <span class="p">{</span><span class="c1">// åˆå§‹åŒ–æ ‡é¢˜é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableHeaderPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">this</span><span class="o">-&gt;</span><span class="n">max_depth_</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">;</span><span class="c1">// è¡¨ç¤ºæ ‡é¢˜é¡µå¯ä»¥å¤„ç†çš„æœ€å¤§æ·±åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">MaxSize</span><span class="p">();</span><span class="c1">// è®¡ç®—æœ€å¤§ç›®å½•é¡¹æ•° lenï¼Œé€šè¿‡è°ƒç”¨ MaxSize() æ–¹æ³•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span><span class="c1">// éå† directory_page_ids_ æ•°ç»„ï¼Œå°†æ¯ä¸ªå…ƒç´ åˆå§‹åŒ–ä¸º INVALID_PAGE_IDï¼Œè¡¨ç¤ºåˆå§‹æ—¶æ²¡æœ‰ç›®å½•é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">directory_page_ids_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INVALID_PAGE_ID</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è®¡ç®—å“ˆå¸Œåˆ°ç›®å½•ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableHeaderPage</span><span class="o">::</span><span class="n">HashToDirectoryIndex</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">hash</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span><span class="c1">// { return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">max_depth_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// é€šè¿‡å³ç§»æ“ä½œå°†å“ˆå¸Œå€¼çš„é«˜ä½éƒ¨åˆ†æå–å‡ºæ¥ï¼Œä½œä¸ºç›®å½•ç´¢å¼•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è¿™åˆ©ç”¨äº†ä½è¿ç®—çš„ç‰¹æ€§ï¼Œå°†å“ˆå¸Œå€¼çš„å‰ max_depth_ ä½ä½œä¸ºç´¢å¼•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">hash</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="mi">32</span> <span class="o">-</span> <span class="n">max_depth_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">// è·å–ç›®å½•é¡µé¢ ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableHeaderPage</span><span class="o">::</span><span class="n">GetDirectoryPageId</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">directory_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="c1">//{ return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">directory_idx</span> <span class="o">&lt;</span> <span class="n">MaxSize</span><span class="p">());</span><span class="c1">// ä½¿ç”¨ assert ç¡®ä¿ç›®å½•ç´¢å¼•åœ¨æœ‰æ•ˆèŒƒå›´å†…ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">directory_page_ids_</span><span class="p">[</span><span class="n">directory_idx</span><span class="p">];</span><span class="c1">// è¿”å› directory_page_ids_ æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">// è®¾ç½®ç›®å½•é¡µé¢ ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableHeaderPage</span><span class="o">::</span><span class="n">SetDirectoryPageId</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">directory_idx</span><span class="p">,</span> <span class="n">page_id_t</span> <span class="n">directory_page_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableHeaderPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">directory_idx</span> <span class="o">&lt;</span> <span class="n">MaxSize</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="n">directory_page_ids_</span><span class="p">[</span><span class="n">directory_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">directory_page_id</span><span class="p">;</span><span class="c1">// è®¾ç½® directory_page_ids_ æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„å€¼ä¸ºä¼ å…¥çš„ directory_page_id
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">// è®¡ç®—æœ€å¤§ç›®å½•é¡¹æ•°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableHeaderPage</span><span class="o">::</span><span class="n">MaxSize</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="c1">//{ return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1">//===----------------------------------------------------------------------===//
</span></span></span><span class="line"><span class="cl"><span class="c1">//é€šè¿‡ä½è¿ç®— 1 &lt;&lt; max_depth_ è®¡ç®—æœ€å¤§ç›®å½•é¡¹æ•°ã€‚è¿™ç›¸å½“äºè®¡ç®— 2 çš„ max_depth_ æ¬¡æ–¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span> <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">max_depth_</span><span class="p">);</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>  <span class="c1">// namespace bustub
</span></span></span></code></pre></td></tr></table>
</div>
</div><h3 id="ä¸‰hash-table-directory-page">ä¸‰ã€Hash Table Directory Page
</h3><p>â€‹		<strong>è¿™é‡Œä½¿ç”¨äº†local_depthsæ•°ç»„ï¼Œbucket_page_idsæ•°ç»„ï¼ŒGlobal Depthå’ŒLocal Depthè¿™å››ä¸ªï¼Œå…·ä½“æ„æ€å‚è€ƒä¸Šé¢çš„å¤´éƒ¨å’Œä»¥ä¸‹å†…å®¹ï¼š</strong></p>
<p><strong>è¿™ä¸€éƒ¨åˆ†çš„é‡ç‚¹åœ¨äºä¸€å®šè¦ç†è§£Global Depthå’ŒLocal Depth</strong></p>
<p><strong>1.global_mask æ˜¯å¹²å•¥çš„ï¼Ÿ</strong>
ç­”ï¼šç”¨äºè®°å½•å½“å‰global_depthçš„æ•´ä½“ç‰¹å¾å€¼ã€‚</p>
<pre><code>   å…¬å¼ï¼š(1 &lt;&lt; global_depth) - 1;

   ä¸¾ä¸ªä¾‹å­ï¼š101å’Œ111çš„global_maskéƒ½æ˜¯111ï¼Œå³å®ƒä¿©å¯¹åº”çš„depthéƒ½æ˜¯3ã€‚
</code></pre>
<p>æ‰€ä»¥å½“æˆ‘ä»¬æ‹¥æœ‰ä¸€ä¸ªhash_keyçš„æ—¶å€™ï¼Œç›´æ¥hash_key&amp;global_maskå°±èƒ½å¸®æˆ‘ä»¬å¾—åˆ°ä»–åœ¨dirctory_pageä¸­çš„indexï¼Œè¿™é‡Œä¹Ÿå¯ä»¥çœ‹å‡ºglobal_maskæ˜¯å¹²å•¥çš„ã€‚</p>
<p><strong>2.local_mask æ˜¯å¹²å•¥çš„ï¼Ÿ</strong>
ç­”ï¼šä¸global_maskç±»ä¼¼ï¼Œåªä¸è¿‡æ˜¯åœ¨å±€éƒ¨æ¡¶ä¸­è®°å½•æ·±åº¦çš„æ©ç ã€‚
<strong>3.æ‰©å®¹è¿‡ç¨‹ï¼š</strong>
å‡è®¾ç°åœ¨æœ‰ç´¢å¼•ç»“æ„å¦‚ä¸‹ï¼š</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319155715805.png"
	width="608"
	height="192"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319155715805_hu7601043185427564083.png 480w, /p/cmu15445-2023-fall-p2/image-20250319155715805_hu15386935830159309329.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="316"
		data-flex-basis="760px"
	
></p>
<p>ç°åœ¨è¦æ’å…¥1011ï¼Œå°±éœ€è¦ IncrGlobalDepth()ï¼š</p>
<p>ç°åœ¨æˆ‘ä»¬æ¥å¥½å¥½è§£æä¸Šé¢è¿™å¼ å›¾ï¼š</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319155739130.png"
	width="722"
	height="389"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319155739130_hu1886192498828579306.png 480w, /p/cmu15445-2023-fall-p2/image-20250319155739130_hu13466109655530278961.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="185"
		data-flex-basis="445px"
	
></p>
<p>global_depthä»1æ‹“å±•åˆ°2çš„è¿‡ç¨‹ï¼Œæ‹“å±•å‡ºæ¥çš„entryçš„æŒ‡å‘å°±æ˜¯ç›´æ¥å¤åˆ¶ä¸€ä»½åŸæ¥çš„æŒ‡é’ˆï¼ˆä¸Šå›¾çš„è“è‰²ç®­å¤´å¤åˆ¶ç»¿è‰²ç®­å¤´ï¼‰ï¼Œå› ä¸ºDirectory Pagesæ˜¯é hashå€¼çš„ä½ä½ç´¢å¼•çš„ï¼Œè¯•æƒ³æˆ‘ä»¬æ¯æ¬¡æ‹“å±• ï¼š1+1ï¼Œ2+2ï¼Œ4+4 &hellip; æ‹“å±•å‡ºæ¥çš„è¿™éƒ¨åˆ†æ­£å¥½æ˜¯åŸæ¥entryçš„å¯¹ç­‰å®ä½“ï¼Œè¿™é‡ŒçœŸçš„å¥½å·§å¦™å•Šï¼ï¼ï¼ï¼ï¼</p>
<p>å†ç»§ç»­çœ‹ï¼š</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319155827246.png"
	width="742"
	height="369"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319155827246_hu8016330523538009456.png 480w, /p/cmu15445-2023-fall-p2/image-20250319155827246_hu12683246991536791503.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="201"
		data-flex-basis="482px"
	
></p>
<p>local_depthä¸º1çš„å«ä¹‰å°±æ˜¯ï¼Œè¯¥æ¡¶ä¸­çš„æœ€ä½ä¸€ä½éƒ½ç›¸ç­‰ã€‚ä¸”è®°å¾—local_depthæ°¸è¿œä¸èƒ½å¤§äºglobal_depth</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–ç›®å½•é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">Init</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">max_depth</span><span class="p">)</span> <span class="p">{</span><span class="c1">// max_depth è¡¨ç¤ºç›®å½•é¡µé¢å¯ä»¥å¤„ç†çš„æœ€å¤§æ·±åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableDirectoryPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">max_depth_</span> <span class="o">=</span> <span class="n">max_depth</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">global_depth_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">MaxSize</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket_page_ids_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">INVALID_PAGE_ID</span><span class="p">;</span><span class="c1">// å§‹æ—¶æ²¡æœ‰å­˜å‚¨æ¡¶é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è®¡ç®—å“ˆå¸Œåˆ°å­˜å‚¨æ¡¶ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">HashToBucketIndex</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">hash</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span><span class="c1">// { return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">hash</span> <span class="o">&amp;</span> <span class="p">((</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">global_depth_</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">);</span>  <span class="c1">//ä½¿ç”¨æŒ‰ä½ä¸æ“ä½œæå–å“ˆå¸Œå€¼çš„æœ€ä½ global_depth_ ä½ä½œä¸ºå­˜å‚¨æ¡¶ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//////////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// è·å–æœ€å¤§æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">GetMaxDepth</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="p">{</span> <span class="k">return</span> <span class="n">max_depth_</span><span class="p">;</span> <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">//è·å–å­˜å‚¨æ¡¶é¡µé¢ ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="n">page_id_t</span><span class="c1">// { return INVALID_PAGE_ID; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>  <span class="n">assert</span><span class="p">(</span><span class="n">bucket_idx</span> <span class="o">&lt;</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_depth_</span><span class="p">));</span>  <span class="c1">//åˆ¤æ–­ä¸‹æ ‡æœ‰æ²¡æœ‰è¶…é™å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">bucket_page_ids_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">];</span><span class="c1">// è¿”å› bucket_page_ids_ æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è®¾ç½®å­˜å‚¨æ¡¶é¡µé¢ ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">SetBucketPageId</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">,</span> <span class="n">page_id_t</span> <span class="n">bucket_page_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableDirectoryPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">bucket_idx</span> <span class="o">&lt;</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_depth_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">bucket_page_ids_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket_page_id</span><span class="p">;</span><span class="c1">// è®¾ç½® bucket_page_ids_ æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„å€¼ä¸ºä¼ å…¥çš„ bucket_page_idã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//åˆ†è£‚æ¡¶ï¼Œè¿™é‡Œæ˜¯ä¸ºäº†è·å¾—ä¸€ä¸ªæ¡¶å¯¹åº”çš„å¦ä¸€ä¸ªæ¡¶çš„ç´¢å¼•ï¼ˆegï¼š00å’Œ10æ˜¯ä¸€å¯¹ï¼Œé€šè¿‡è¿™ä¸ªå‡½æ•°ï¼Œè¿™ä¿©ä¸ªå¯ä»¥äº’ç›¸è·å¾—ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1">// è·å–åˆ†è£‚å›¾åƒç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">GetSplitImageIndex</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span><span class="c1">// { return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">local_depth_mask</span> <span class="o">=</span> <span class="n">GetLocalDepthMask</span><span class="p">(</span><span class="n">bucket_idx</span><span class="p">);</span>              <span class="c1">// 11
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">local_depth</span> <span class="o">=</span> <span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">bucket_idx</span><span class="p">);</span>                       <span class="c1">//å‡è®¾ä¸º2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="p">(</span><span class="n">bucket_idx</span> <span class="o">&amp;</span> <span class="n">local_depth_mask</span><span class="p">)</span> <span class="o">^</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">local_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">));</span>  <span class="c1">// 10-&gt;00 01-&gt;11 11-&gt;01 00-&gt;10
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>  
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">//  è·å–å…¨å±€æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">GetGlobalDepth</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span><span class="c1">// { return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">assert</span><span class="p">(</span><span class="n">global_depth_</span> <span class="o">&lt;=</span> <span class="n">max_depth_</span><span class="p">);</span><span class="c1">// ä½¿ç”¨ assert ç¡®ä¿å…¨å±€æ·±åº¦ä¸è¶…è¿‡æœ€å¤§æ·±åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">global_depth_</span><span class="p">;</span><span class="c1">// è¿”å› global_depth_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// è·å–å…¨å±€æ·±åº¦æ©ç (è¿™ä¸ªå‡½æ•°æ²¡æœ‰ç”¨åˆ°)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">GetGlobalDepthMask</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">global_depth</span> <span class="o">=</span> <span class="n">GetGlobalDepth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">global_depth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span><span class="c1">// è®¡ç®— 1 &lt;&lt; global_depthï¼Œç„¶åå‡å» 1ï¼Œå¾—åˆ°æ©ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// å¢åŠ å…¨å±€æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">IncrGlobalDepth</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableDirectoryPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">global_depth_</span> <span class="o">&lt;=</span> <span class="n">max_depth_</span><span class="p">);</span><span class="c1">// ä½¿ç”¨ assert ç¡®ä¿å…¨å±€æ·±åº¦ä¸è¶…è¿‡æœ€å¤§æ·±åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">global_depth_</span> <span class="o">==</span> <span class="n">max_depth_</span><span class="p">)</span> <span class="p">{</span><span class="c1">// å¦‚æœå½“å‰å…¨å±€æ·±åº¦å·²ç»è¾¾åˆ°æœ€å¤§æ·±åº¦ï¼Œç›´æ¥è¿”å›ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¢åŠ ç›®å½•çš„å…¨å±€æ·±åº¦ï¼Œä¹Ÿå°±æ˜¯ç›®å‰æ‰€æœ‰æ¡¶ä¸­çš„æœ€å¤§æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è®¡ç®—å¢åŠ æ·±åº¦å‰åçš„ç›®å½•å¤§å°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">pre_size</span> <span class="o">=</span> <span class="n">Size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">global_depth_</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">curr_size</span> <span class="o">=</span> <span class="n">Size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//å¢åŠ ä»¥ä¸ºè¦ä¹˜ä»¥2å°±æ˜¯ç¿»ä¸€å€
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//å®˜ç½‘è¿™ä¹ˆæŒ‡ç¤ºï¼Œè¦æŠŠå…¶æ‰©å±•åçš„åˆå§‹åŒ–ä¸ºç›¸åº”ä½ç½®ï¼Œä¸æ¸…æ¥šä¸ºä»€ä¹ˆè¿™æ ·åˆå§‹åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//æ˜¯å› ä¸ºå¯¹åº”ä½ç½®æœ€åxxä½æ˜¯ä¸€æ ·çš„æ‰€ä»¥å¯ä»¥å…ˆè¿™æ ·åˆå§‹åŒ–ï¼Ÿï¼Ÿï¼Ÿ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// å°†æ–°æ‰©å±•çš„éƒ¨åˆ†åˆå§‹åŒ–ä¸ºå¯¹åº”ä½ç½®çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">pre_size</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">curr_size</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket_page_ids_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">bucket_page_ids_</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">pre_size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">    <span class="n">local_depths_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_depths_</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="n">pre_size</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å‡å°‘å…¨å±€æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">DecrGlobalDepth</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableDirectoryPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">global_depth_</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// å¦‚æœå½“å‰å…¨å±€æ·±åº¦å¤§äº 0ï¼Œå‡å°‘ 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">global_depth_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ£€æŸ¥æ˜¯å¦å¯ä»¥æ”¶ç¼©
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">CanShrink</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="c1">//{ return false; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="n">global_depth_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// å¦‚æœå…¨å±€æ·±åº¦ä¸º 0ï¼Œç›´æ¥è¿”å› falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// éå†æ‰€æœ‰å­˜å‚¨æ¡¶ï¼Œæ£€æŸ¥æ˜¯å¦æœ‰å­˜å‚¨æ¡¶çš„å±€éƒ¨æ·±åº¦ç­‰äºå…¨å±€æ·±åº¦ã€‚å¦‚æœæœ‰ï¼Œè¿”å› falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">len</span> <span class="o">=</span> <span class="n">Size</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">len</span><span class="p">;</span> <span class="n">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">local_depths_</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">==</span> <span class="n">global_depth_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœæ‰€æœ‰å­˜å‚¨æ¡¶çš„å±€éƒ¨æ·±åº¦éƒ½å°äºå…¨å±€æ·±åº¦ï¼Œè¿”å› trueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–ç›®å½•å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">Size</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="c1">//{ return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¡ç®— 2^global_depth_ï¼Œå¹¶è½¬æ¢ä¸º uint32_t ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">size_float</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">global_depth_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">size</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">size_float</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// è·å–æœ€å¤§ç›®å½•å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">MaxSize</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è®¡ç®— 2^max_depth_ï¼Œå¹¶è½¬æ¢ä¸º uint32_t ç±»å‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">double</span> <span class="n">tmp</span> <span class="o">=</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_depth_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">max_size</span> <span class="o">=</span> <span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span><span class="p">(</span><span class="n">tmp</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">max_size</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// è·å–å±€éƒ¨æ·±åº¦(è·å–æŒ‡å®šå­˜å‚¨æ¡¶ç´¢å¼•å¯¹åº”çš„å±€éƒ¨æ·±åº¦ã€‚)
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="c1">//{ return 0; }
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">local_depths_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">];</span><span class="c1">// è¿”å› local_depths_ æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// è·å–å±€éƒ¨æ·±åº¦æ©ç ï¼ˆæ©ç å°±æ˜¯è·å–äºŒè¿›åˆ¶çš„å‰local_depthä½ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">auto</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">GetLocalDepthMask</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">local_depth</span> <span class="o">=</span> <span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">bucket_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="p">(</span><span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="n">local_depth</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span><span class="c1">// è®¡ç®— 1 &lt;&lt; local_depthï¼Œç„¶åå‡å» 1ï¼Œå¾—åˆ°æ©ç ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">////////////////////////////////////////////////////
</span></span></span><span class="line"><span class="cl"><span class="c1">// è®¾ç½®å±€éƒ¨æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">SetLocalDepth</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">,</span> <span class="kt">uint8_t</span> <span class="n">local_depth</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableDirectoryPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">bucket_idx</span> <span class="o">&lt;</span> <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">max_depth_</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">  <span class="n">local_depths_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">]</span> <span class="o">=</span> <span class="n">local_depth</span><span class="p">;</span><span class="c1">// è®¾ç½® local_depths_ æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„å€¼ä¸ºä¼ å…¥çš„ local_depthã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å¢åŠ å±€éƒ¨æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">IncrLocalDepth</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl"> <span class="c1">// throw NotImplementedException(&#34;ExtendibleHTableDirectoryPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">local_depths_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span><span class="p">;</span> <span class="c1">//ç›´æ¥å¢åŠ  local_depths_ æ•°ç»„ä¸­å¯¹åº”ç´¢å¼•çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å‡å°‘å±€éƒ¨æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableDirectoryPage</span><span class="o">::</span><span class="n">DecrLocalDepth</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableDirectoryPage is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">local_depths_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// å¦‚æœå½“å‰å±€éƒ¨æ·±åº¦å¤§äº 0ï¼Œå‡å°‘ 1ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">local_depths_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">]</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="å››hash-table-buckethttpssocsdnnetsosearchqbucketspm1001210130017020-page">å››ã€Hash Table <a class="link" href="https://so.csdn.net/so/search?q=Bucket&amp;spm=1001.2101.3001.7020"  target="_blank" rel="noopener"
    >Bucket</a> Page
</h3><p>è¿™éƒ¨åˆ†çš„ä»»åŠ¡å°±å¾ˆè½»æ¾äº†ï¼Œæ¡¶ä¸­&lt;key,value&gt;çš„å­˜å‚¨ç»“æ„ç”¨çš„æ˜¯æ•°ç»„ï¼Œä¸”å·²ç»ç»™å¥½äº†æ¯”è¾ƒå·¥å…· <strong>cmp_</strong>ï¼Œæ‰€ä»¥å¤§é‡è¿›è¡Œéå†ï¼Œä¸€ä¸ªä¸ªæŒ‰æ³¨é‡Šå®Œæˆç›¸åº”å‡½æ•°è¦æ±‚å³å¯ï¼Œä¸å†åšè¿‡å¤šèµ˜è¿°ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="c1">// åˆå§‹åŒ–å­˜å‚¨æ¡¶é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="kt">void</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">Init</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">max_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableBucketPage not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">this</span><span class="o">-&gt;</span><span class="n">max_size_</span> <span class="o">=</span> <span class="n">max_size</span><span class="p">;</span><span class="c1">// å­˜å‚¨æ¡¶é¡µé¢å¯ä»¥å­˜å‚¨çš„æœ€å¤§é”®å€¼å¯¹æ•°é‡ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">this</span><span class="o">-&gt;</span><span class="n">size_</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span><span class="c1">// åˆå§‹åŒ– size_ ä¸º 0ï¼Œè¡¨ç¤ºå½“å‰å­˜å‚¨æ¡¶é¡µé¢ä¸­æ²¡æœ‰é”®å€¼å¯¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æŸ¥æ‰¾é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">Lookup</span><span class="p">(</span><span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">V</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">KC</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span><span class="c1">// éå†å­˜å‚¨æ¡¶é¡µé¢ä¸­çš„é”®å€¼å¯¹æ•°ç»„ array_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">(</span><span class="n">array_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// ä½¿ç”¨æ¯”è¾ƒå™¨ cmp æ¯”è¾ƒæ¯ä¸ªé”®ä¸ç›®æ ‡é”®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">value</span> <span class="o">=</span> <span class="n">array_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">;</span><span class="c1">// å¦‚æœæ‰¾åˆ°åŒ¹é…çš„é”®ï¼Œå°†å¯¹åº”çš„å€¼å­˜å‚¨åœ¨ value ä¸­å¹¶è¿”å› trueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ’å…¥é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">Insert</span><span class="p">(</span><span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">V</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="k">const</span> <span class="n">KC</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">size_</span> <span class="o">==</span> <span class="n">max_size_</span><span class="p">)</span> <span class="p">{</span><span class="c1">// æ£€æŸ¥å­˜å‚¨æ¡¶é¡µé¢æ˜¯å¦å·²æ»¡ï¼Œå¦‚æœå·²æ»¡ï¼Œè¿”å› falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span><span class="c1">// éå†å­˜å‚¨æ¡¶é¡µé¢ä¸­çš„é”®å€¼å¯¹æ•°ç»„ array_ï¼Œæ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨ç›¸åŒçš„é”®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">(</span><span class="n">array_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// å¦‚æœå­˜åœ¨ç›¸åŒçš„é”®ï¼Œè¿”å› falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœä¸å­˜åœ¨ç›¸åŒçš„é”®ï¼Œå°†é”®å€¼å¯¹æ’å…¥åˆ°æ•°ç»„çš„æœ«å°¾ï¼Œå¹¶å¢åŠ  size_ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">array_</span><span class="p">[</span><span class="n">size_</span><span class="p">].</span><span class="n">first</span> <span class="o">=</span> <span class="n">key</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">array_</span><span class="p">[</span><span class="n">size_</span><span class="p">].</span><span class="n">second</span> <span class="o">=</span> <span class="n">value</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// åˆ é™¤é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">Remove</span><span class="p">(</span><span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">KC</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//éå†å­˜å‚¨æ¡¶é¡µé¢ä¸­çš„é”®å€¼å¯¹æ•°ç»„ array_ï¼Œæ‰¾åˆ°è¦åˆ é™¤çš„é”®çš„ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">cmp</span><span class="p">(</span><span class="n">array_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">,</span> <span class="n">key</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å¦‚æœæ‰¾åˆ°åŒ¹é…çš„é”®ï¼Œå°†è¯¥ä½ç½®ä¹‹åçš„é”®å€¼å¯¹å‘å‰ç§»åŠ¨ï¼Œè¦†ç›–è¯¥ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">i</span> <span class="o">==</span> <span class="n">size_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">j</span> <span class="o">=</span> <span class="n">i</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">size_</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">array_</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">first</span> <span class="o">=</span> <span class="n">array_</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">array_</span><span class="p">[</span><span class="n">j</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">second</span> <span class="o">=</span> <span class="n">array_</span><span class="p">[</span><span class="n">j</span><span class="p">].</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å‡å°‘ size_ å¹¶è¿”å› trueã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">size_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æŒ‰ç´¢å¼•åˆ é™¤é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="kt">void</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">RemoveAt</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//throw NotImplementedException(&#34;ExtendibleHTableBucketPage not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">if</span> <span class="p">(</span><span class="n">bucket_idx</span> <span class="o">&gt;=</span> <span class="n">size_</span><span class="p">)</span> <span class="p">{</span><span class="c1">// æ£€æŸ¥ç´¢å¼•æ˜¯å¦æœ‰æ•ˆã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">return</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†è¯¥ç´¢å¼•ä¹‹åçš„é”®å€¼å¯¹å‘å‰ç§»åŠ¨ï¼Œè¦†ç›–è¯¥ç´¢å¼•ä½ç½®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">bucket_idx</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">size_</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">array_</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">first</span> <span class="o">=</span> <span class="n">array_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">first</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">array_</span><span class="p">[</span><span class="n">i</span> <span class="o">-</span> <span class="mi">1</span><span class="p">].</span><span class="n">second</span> <span class="o">=</span> <span class="n">array_</span><span class="p">[</span><span class="n">i</span><span class="p">].</span><span class="n">second</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="n">size_</span><span class="o">--</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–æŒ‡å®šç´¢å¼•çš„é”®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">KeyAt</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="n">K</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return {};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">array_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">].</span><span class="n">first</span><span class="p">;</span><span class="c1">// ç›´æ¥è¿”å› array_ ä¸­å¯¹åº”ç´¢å¼•çš„é”®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">//  è·å–æŒ‡å®šç´¢å¼•çš„å€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">ValueAt</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="n">V</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return {};
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">array_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">].</span><span class="n">second</span><span class="p">;</span><span class="c1">// ç›´æ¥è¿”å› array_ ä¸­å¯¹åº”ç´¢å¼•çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–æŒ‡å®šç´¢å¼•çš„é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">EntryAt</span><span class="p">(</span><span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">)</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">pair</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="o">&gt;</span> <span class="o">&amp;</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return array_[0];
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">array_</span><span class="p">[</span><span class="n">bucket_idx</span><span class="p">];</span><span class="c1">// ç›´æ¥è¿”å› array_ ä¸­å¯¹åº”ç´¢å¼•çš„é”®å€¼å¯¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// è·å–å­˜å‚¨æ¡¶å¤§å°
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">Size</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return 0;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">size_</span><span class="p">;</span><span class="c1">// è¿”å› size_
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦å·²æ»¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">IsFull</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">size_</span> <span class="o">==</span> <span class="n">max_size_</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æ£€æŸ¥å­˜å‚¨æ¡¶æ˜¯å¦ä¸ºç©º
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">IsEmpty</span><span class="p">()</span> <span class="k">const</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">return</span> <span class="n">size_</span> <span class="o">==</span> <span class="mi">0</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä»»åŠ¡-3---å¯æ‰©å±•å“ˆå¸Œå®ç°">ä»»åŠ¡ #3 - å¯æ‰©å±•å“ˆå¸Œå®ç°
</h2><p><strong>ä¸€ã€æ•´ä½“æ€è·¯ï¼š</strong></p>
<p><strong>æ€è·¯æ‹ä¸€ä¸‹ï¼š</strong></p>
<p>â€‹		<strong>é¦–å…ˆä¸€ä¸ªheaderä¼šæŒ‡å‘å¤šä¸ªç›®å½•ï¼Œä¸€ä¸ªç›®å½•ä¼šæŒ‡å‘å¤šä¸ªæ¡¶</strong></p>
<p>â€‹		<strong>headeré€šè¿‡keyçš„å‰å‡ ä½æ˜ å°„åˆ°ç›®å½•ï¼Œç›®å½•é€šè¿‡åå‡ ä½çš„keyæ˜ å°„åˆ°æ¡¶</strong></p>
<p>â€‹		<strong>è¦å®ç°çš„æ’å…¥å’Œç§»é™¤éƒ½åº”è¯¥é€æ­¥hashåˆ°ç›®æ ‡æ¡¶</strong></p>
<p>â€‹		TASK#3æ˜¯æ•´ä¸ªP2çš„é‡ç‚¹å’Œéš¾ç‚¹ï¼Œè¦æ±‚æˆ‘ä»¬åˆ©ç”¨Task#1 å®ç°çš„page_guardå’ŒTask#2å®ç°çš„ä¸‰çº§hash_pageæ¥å®ç°æœ€ç»ˆçš„å¯æ‹“å±•å“ˆå¸Œç»“æ„ï¼Œä¸”æ”¯æŒTask#4 å¹¶å‘æ§åˆ¶çš„è¦æ±‚ã€‚</p>
<p>â€‹		è¿™éƒ¨åˆ†å†…å®¹è¿‡äºå¤æ‚ï¼Œæˆ‘ä¹Ÿæ˜¯å‚è€ƒäº†ä¼—å¤šå…¶ä»–åšå®¢çš„æ€è·¯æ¥å®ç°çš„ï¼Œå¤§è‡´ä¸Šå¤§å®¶å¯ä»¥å‚è€ƒä»¥ä¸‹è¿™ç¯‡åšå®¢é‡Œçš„æµç¨‹å›¾æ€è·¯ï¼Œæˆ‘å°±ä¸å†é‡å¤é€ è½®å­äº†ï¼š
[CMU15-445 2023 Fall Project#2 - Extensible Hash Index - çŸ¥ä¹](<a class="link" href="https://zhuanlan.zhihu.com/p/679864158#2"  target="_blank" rel="noopener"
    >https://zhuanlan.zhihu.com/p/679864158#2</a> - Extensible Hash Indexï¼‰)</p>
<p><strong>äºŒã€å¸¸ç”¨æ€è·¯å’ŒæŠ€å·§ï¼š</strong>
ä¸Šé¢å¼•ç”¨çš„åšå®¢å¯¹äºç»†èŠ‚çš„æè¿°è¾ƒå°‘ï¼Œæˆ‘åœ¨æ­¤è¡¥å……å‡ ç‚¹ï¼š</p>
<p><strong>1.å¦‚ä½•å–„ç”¨page_guardç±»ï¼š</strong>
å¦‚ä½•å–„ç”¨page_guardç±»æ¥ä¾¿åˆ©çš„å®ç°æˆ‘ä»¬çš„å¢åˆ æŸ¥æ“ä½œå¹¶ä¸”ä¿è¯å¤šçº¿ç¨‹å®‰å…¨ï¼Ÿ</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319221154980.png"
	width="715"
	height="190"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319221154980_hu8491441173659368322.png 480w, /p/cmu15445-2023-fall-p2/image-20250319221154980_hu16262066502635444118.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="376"
		data-flex-basis="903px"
	
></p>
<p>Task#3çš„ç¬¬ä¸€å¤§éš¾ç‚¹ä¸ªäººæ„Ÿè§‰å°±åœ¨è¿™é‡Œï¼Œå› ä¸ºæ¯”å¦‚æ‹¿ GetValue() ä¸¾ä¾‹ï¼Œæœ€ç»ˆçš„æŸ¥æ‰¾æ“ä½œå…¶å®å°±ä¸‹é¢è¿™ä¹ˆä¸€ä¸¤å¥ï¼šå³åœ¨ç¬¬ä¸‰å±‚bucket_pageè¿›è¡ŒæŸ¥æ‰¾ã€‚ä½†å¦‚ä½•åœ¨ä¸‰å±‚å¯æ‹“å±•å“ˆå¸Œç»“æ„å’Œå¤šçº¿ç¨‹å®‰å…¨çš„é‡é‡è¦æ±‚ä¸‹å±‚å±‚å‰¥ç¬‹çš„è¿›å…¥ç¬¬ä¸‰å±‚bucket_pageï¼Ÿå…·ä½“æ€è·¯å’Œåšæ³•å¦‚ä¸‹ï¼ˆè¿˜æ˜¯ä»¥ GetValue()ä¸¾ä¾‹ï¼‰ï¼š</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319221227796.png"
	width="1069"
	height="690"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319221227796_hu11081509621333477827.png 480w, /p/cmu15445-2023-fall-p2/image-20250319221227796_hu13648186135401116404.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="154"
		data-flex-basis="371px"
	
></p>
<p><strong>2.Insertæ—¶çš„SplitBucketæƒ…å†µï¼š</strong>
å½“ä¸€ä¸ªæ¡¶å†…çš„å…ƒç´ æ•°ç›®è¾¾åˆ°ä¸Šé™æ—¶ï¼ˆæ¡¶æ»¡ï¼‰ï¼Œå°±éœ€è¦åˆ†è£‚æ¡¶ã€‚åˆ†è£‚çš„ç›®çš„æ˜¯å°†ç°æœ‰æ¡¶ä¸­çš„å…ƒç´ åˆ†é…åˆ°ä¸¤ä¸ªæ–°çš„æ¡¶ä¸­ï¼Œä»è€Œå‡å°‘å•ä¸ªæ¡¶çš„è´Ÿè½½ï¼Œä¿æŒå“ˆå¸Œè¡¨çš„æ€§èƒ½ã€‚</p>
<p>è¿™é‡Œæœ‰ä¸€ç‚¹è¦è®°ä½ï¼ŒåŸæ¡¶ä¼šåˆ†è£‚æˆä¿©ä¸ªæ¡¶ï¼ŒåŸæ¡¶ä¸º0xxxï¼Œåˆ†è£‚æ¡¶ä¸º1xxxï¼Œä¸”åªæœ‰ä¸è¿™ä¿©ä¸ªæ¡¶ç›¸å…³çš„æ•°æ®å’Œç´¢å¼•ä¼šå‘ç”Ÿå˜åŒ–ï¼ˆå³é‡æ–°åˆ†é…ï¼‰ï¼Œå…¶å®ƒæ¡¶ä¸ä¼šå˜åŒ–ã€‚</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319221253261.png"
	width="566"
	height="711"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319221253261_hu11622578696027886987.png 480w, /p/cmu15445-2023-fall-p2/image-20250319221253261_hu10612474887623689066.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="79"
		data-flex-basis="191px"
	
></p>
<p><strong>3.Romoveæ—¶çš„mergeæƒ…å†µï¼š</strong>
Romoveæ“ä½œæ—¶ï¼Œå¦‚æœå½“å‰bucketçš„local depthä¸ä¸º0ï¼Œä¸”å¤§äº0ï¼Œå¯¹åº”çš„Split_Bucketçš„local depthç›¸åŒï¼Œå¹¶ä¸”ä¸¤ä¸ªbucketå…¶ä¸­æœ‰ä¸€ä¸ªä¸ºç©ºå³éœ€è¦åˆå¹¶æ¡¶ã€‚</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319221352309.png"
	width="747"
	height="717"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319221352309_hu8870171684301722039.png 480w, /p/cmu15445-2023-fall-p2/image-20250319221352309_hu16638773287415541736.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="104"
		data-flex-basis="250px"
	
></p>
<p>è¿™é‡Œå€¼å¾—ä¸€æçš„æ˜¯ï¼Œåœ¨è®¡ç®—å¾…åˆå¹¶æ¡¶çš„ç´¢å¼•ï¼ˆç¬¬ä¸‰æ­¥ï¼‰ä»¥åŠæœ€åï¼ˆå€’æ•°ç¬¬äºŒæ­¥ï¼‰è®¡ç®—å±€éƒ¨æ·±åº¦å’Œæ¡¶ç´¢å¼•æ—¶éƒ½æ¶‰åŠåˆ°å¯¹æ©ç çš„ä½è¿ç®—ï¼Œè¿™é‡Œæä¾›ä»¥ä¸‹æ€è·¯å‚è€ƒï¼š</p>
<p>3.1 è®¡ç®—å¾…åˆå¹¶æ¡¶ merge_bucket_idxï¼š</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319230105161.png"
	width="1390"
	height="277"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319230105161_hu5547801827211712569.png 480w, /p/cmu15445-2023-fall-p2/image-20250319230105161_hu1205852078015972985.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="501"
		data-flex-basis="1204px"
	
></p>
<p>å…ˆå–å½“å‰å±€éƒ¨æ·±åº¦çš„äºŒè¿›åˆ¶ä½è¡¨ç¤ºï¼Œæ¯”å¦‚å±€éƒ¨æ·±åº¦ä¸º3ï¼Œåˆ™merge_mask : 0100,</p>
<p>å†ä¸å½“å‰æ¡¶çš„idxè¿›è¡Œå¼‚æˆ–ï¼Œå³å¯å¾—åˆ° merge_bucket_idxã€‚</p>
<p>3.2 æ›´æ–°ç›®å½•ç´¢å¼•æ—¶ï¼Œè®¡ç®—æ¯ä¸ªæ¡¶çš„å”¯ä¸€idxï¼š</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319230404859.png"
	width="1346"
	height="129"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319230404859_hu275676112911610859.png 480w, /p/cmu15445-2023-fall-p2/image-20250319230404859_hu13165402234233311981.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="1043"
		data-flex-basis="2504px"
	
></p>
<p>è¿™é‡Œå¦‚æœçœ‹æ‡‚äº†ä¸Šä¸€ç¯‡åšå®¢é‡Œå¯¹äºlocal_maskä½œç”¨çš„è®²è§£çš„è¯ä¼šå¾ˆæ¸…æ™°ï¼šâ€œ&amp;æ“ä½œå¾—åˆ°ç‹¬ç‰¹ä½â€</p>
<p>4.åŠæ—¶é‡Šæ”¾ç©ºé—´ï¼š
ï¼ˆè¿™ä¸€ç‚¹æˆ‘åœ¨åšä¹‹å‰çœ‹åˆ«äººçš„ç»éªŒç›´æ¥é¿å‘äº†ï¼Œæ‰€ä»¥å¹¶æ²¡æœ‰äº²èº«ä½“ä¼šï¼‰</p>
<p>åœ¨Insert å’Œ Romoveçš„è¿‡ç¨‹ä¸­ï¼Œå·²ç»ä½¿ç”¨è¿‡çš„page_guardå¯ä»¥æå‰æ‰‹åŠ¨Drop () æ‰ï¼Œåˆ«ç­‰ææ„çš„æ—¶å€™è‡ªåŠ¨æ¸…é™¤ï¼ŒäºŒ.1çš„æµç¨‹å›¾ä¸­ä¹Ÿå·²ç»åŒ…å«ï¼š</p>
<p><img src="/p/cmu15445-2023-fall-p2/image-20250319231008681.png"
	width="1069"
	height="715"
	srcset="/p/cmu15445-2023-fall-p2/image-20250319231008681_hu1859812940378622404.png 480w, /p/cmu15445-2023-fall-p2/image-20250319231008681_hu2873667881790157908.png 1024w"
	loading="lazy"
	
	
		class="gallery-image" 
		data-flex-grow="149"
		data-flex-basis="358px"
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">  1
</span><span class="lnt">  2
</span><span class="lnt">  3
</span><span class="lnt">  4
</span><span class="lnt">  5
</span><span class="lnt">  6
</span><span class="lnt">  7
</span><span class="lnt">  8
</span><span class="lnt">  9
</span><span class="lnt"> 10
</span><span class="lnt"> 11
</span><span class="lnt"> 12
</span><span class="lnt"> 13
</span><span class="lnt"> 14
</span><span class="lnt"> 15
</span><span class="lnt"> 16
</span><span class="lnt"> 17
</span><span class="lnt"> 18
</span><span class="lnt"> 19
</span><span class="lnt"> 20
</span><span class="lnt"> 21
</span><span class="lnt"> 22
</span><span class="lnt"> 23
</span><span class="lnt"> 24
</span><span class="lnt"> 25
</span><span class="lnt"> 26
</span><span class="lnt"> 27
</span><span class="lnt"> 28
</span><span class="lnt"> 29
</span><span class="lnt"> 30
</span><span class="lnt"> 31
</span><span class="lnt"> 32
</span><span class="lnt"> 33
</span><span class="lnt"> 34
</span><span class="lnt"> 35
</span><span class="lnt"> 36
</span><span class="lnt"> 37
</span><span class="lnt"> 38
</span><span class="lnt"> 39
</span><span class="lnt"> 40
</span><span class="lnt"> 41
</span><span class="lnt"> 42
</span><span class="lnt"> 43
</span><span class="lnt"> 44
</span><span class="lnt"> 45
</span><span class="lnt"> 46
</span><span class="lnt"> 47
</span><span class="lnt"> 48
</span><span class="lnt"> 49
</span><span class="lnt"> 50
</span><span class="lnt"> 51
</span><span class="lnt"> 52
</span><span class="lnt"> 53
</span><span class="lnt"> 54
</span><span class="lnt"> 55
</span><span class="lnt"> 56
</span><span class="lnt"> 57
</span><span class="lnt"> 58
</span><span class="lnt"> 59
</span><span class="lnt"> 60
</span><span class="lnt"> 61
</span><span class="lnt"> 62
</span><span class="lnt"> 63
</span><span class="lnt"> 64
</span><span class="lnt"> 65
</span><span class="lnt"> 66
</span><span class="lnt"> 67
</span><span class="lnt"> 68
</span><span class="lnt"> 69
</span><span class="lnt"> 70
</span><span class="lnt"> 71
</span><span class="lnt"> 72
</span><span class="lnt"> 73
</span><span class="lnt"> 74
</span><span class="lnt"> 75
</span><span class="lnt"> 76
</span><span class="lnt"> 77
</span><span class="lnt"> 78
</span><span class="lnt"> 79
</span><span class="lnt"> 80
</span><span class="lnt"> 81
</span><span class="lnt"> 82
</span><span class="lnt"> 83
</span><span class="lnt"> 84
</span><span class="lnt"> 85
</span><span class="lnt"> 86
</span><span class="lnt"> 87
</span><span class="lnt"> 88
</span><span class="lnt"> 89
</span><span class="lnt"> 90
</span><span class="lnt"> 91
</span><span class="lnt"> 92
</span><span class="lnt"> 93
</span><span class="lnt"> 94
</span><span class="lnt"> 95
</span><span class="lnt"> 96
</span><span class="lnt"> 97
</span><span class="lnt"> 98
</span><span class="lnt"> 99
</span><span class="lnt">100
</span><span class="lnt">101
</span><span class="lnt">102
</span><span class="lnt">103
</span><span class="lnt">104
</span><span class="lnt">105
</span><span class="lnt">106
</span><span class="lnt">107
</span><span class="lnt">108
</span><span class="lnt">109
</span><span class="lnt">110
</span><span class="lnt">111
</span><span class="lnt">112
</span><span class="lnt">113
</span><span class="lnt">114
</span><span class="lnt">115
</span><span class="lnt">116
</span><span class="lnt">117
</span><span class="lnt">118
</span><span class="lnt">119
</span><span class="lnt">120
</span><span class="lnt">121
</span><span class="lnt">122
</span><span class="lnt">123
</span><span class="lnt">124
</span><span class="lnt">125
</span><span class="lnt">126
</span><span class="lnt">127
</span><span class="lnt">128
</span><span class="lnt">129
</span><span class="lnt">130
</span><span class="lnt">131
</span><span class="lnt">132
</span><span class="lnt">133
</span><span class="lnt">134
</span><span class="lnt">135
</span><span class="lnt">136
</span><span class="lnt">137
</span><span class="lnt">138
</span><span class="lnt">139
</span><span class="lnt">140
</span><span class="lnt">141
</span><span class="lnt">142
</span><span class="lnt">143
</span><span class="lnt">144
</span><span class="lnt">145
</span><span class="lnt">146
</span><span class="lnt">147
</span><span class="lnt">148
</span><span class="lnt">149
</span><span class="lnt">150
</span><span class="lnt">151
</span><span class="lnt">152
</span><span class="lnt">153
</span><span class="lnt">154
</span><span class="lnt">155
</span><span class="lnt">156
</span><span class="lnt">157
</span><span class="lnt">158
</span><span class="lnt">159
</span><span class="lnt">160
</span><span class="lnt">161
</span><span class="lnt">162
</span><span class="lnt">163
</span><span class="lnt">164
</span><span class="lnt">165
</span><span class="lnt">166
</span><span class="lnt">167
</span><span class="lnt">168
</span><span class="lnt">169
</span><span class="lnt">170
</span><span class="lnt">171
</span><span class="lnt">172
</span><span class="lnt">173
</span><span class="lnt">174
</span><span class="lnt">175
</span><span class="lnt">176
</span><span class="lnt">177
</span><span class="lnt">178
</span><span class="lnt">179
</span><span class="lnt">180
</span><span class="lnt">181
</span><span class="lnt">182
</span><span class="lnt">183
</span><span class="lnt">184
</span><span class="lnt">185
</span><span class="lnt">186
</span><span class="lnt">187
</span><span class="lnt">188
</span><span class="lnt">189
</span><span class="lnt">190
</span><span class="lnt">191
</span><span class="lnt">192
</span><span class="lnt">193
</span><span class="lnt">194
</span><span class="lnt">195
</span><span class="lnt">196
</span><span class="lnt">197
</span><span class="lnt">198
</span><span class="lnt">199
</span><span class="lnt">200
</span><span class="lnt">201
</span><span class="lnt">202
</span><span class="lnt">203
</span><span class="lnt">204
</span><span class="lnt">205
</span><span class="lnt">206
</span><span class="lnt">207
</span><span class="lnt">208
</span><span class="lnt">209
</span><span class="lnt">210
</span><span class="lnt">211
</span><span class="lnt">212
</span><span class="lnt">213
</span><span class="lnt">214
</span><span class="lnt">215
</span><span class="lnt">216
</span><span class="lnt">217
</span><span class="lnt">218
</span><span class="lnt">219
</span><span class="lnt">220
</span><span class="lnt">221
</span><span class="lnt">222
</span><span class="lnt">223
</span><span class="lnt">224
</span><span class="lnt">225
</span><span class="lnt">226
</span><span class="lnt">227
</span><span class="lnt">228
</span><span class="lnt">229
</span><span class="lnt">230
</span><span class="lnt">231
</span><span class="lnt">232
</span><span class="lnt">233
</span><span class="lnt">234
</span><span class="lnt">235
</span><span class="lnt">236
</span><span class="lnt">237
</span><span class="lnt">238
</span><span class="lnt">239
</span><span class="lnt">240
</span><span class="lnt">241
</span><span class="lnt">242
</span><span class="lnt">243
</span><span class="lnt">244
</span><span class="lnt">245
</span><span class="lnt">246
</span><span class="lnt">247
</span><span class="lnt">248
</span><span class="lnt">249
</span><span class="lnt">250
</span><span class="lnt">251
</span><span class="lnt">252
</span><span class="lnt">253
</span><span class="lnt">254
</span><span class="lnt">255
</span><span class="lnt">256
</span><span class="lnt">257
</span><span class="lnt">258
</span><span class="lnt">259
</span><span class="lnt">260
</span><span class="lnt">261
</span><span class="lnt">262
</span><span class="lnt">263
</span><span class="lnt">264
</span><span class="lnt">265
</span><span class="lnt">266
</span><span class="lnt">267
</span><span class="lnt">268
</span><span class="lnt">269
</span><span class="lnt">270
</span><span class="lnt">271
</span><span class="lnt">272
</span><span class="lnt">273
</span><span class="lnt">274
</span><span class="lnt">275
</span><span class="lnt">276
</span><span class="lnt">277
</span><span class="lnt">278
</span><span class="lnt">279
</span><span class="lnt">280
</span><span class="lnt">281
</span><span class="lnt">282
</span><span class="lnt">283
</span><span class="lnt">284
</span><span class="lnt">285
</span><span class="lnt">286
</span><span class="lnt">287
</span><span class="lnt">288
</span><span class="lnt">289
</span><span class="lnt">290
</span><span class="lnt">291
</span><span class="lnt">292
</span><span class="lnt">293
</span><span class="lnt">294
</span><span class="lnt">295
</span><span class="lnt">296
</span><span class="lnt">297
</span><span class="lnt">298
</span><span class="lnt">299
</span><span class="lnt">300
</span><span class="lnt">301
</span><span class="lnt">302
</span><span class="lnt">303
</span><span class="lnt">304
</span><span class="lnt">305
</span><span class="lnt">306
</span><span class="lnt">307
</span><span class="lnt">308
</span><span class="lnt">309
</span><span class="lnt">310
</span><span class="lnt">311
</span><span class="lnt">312
</span><span class="lnt">313
</span><span class="lnt">314
</span><span class="lnt">315
</span><span class="lnt">316
</span><span class="lnt">317
</span><span class="lnt">318
</span><span class="lnt">319
</span><span class="lnt">320
</span><span class="lnt">321
</span><span class="lnt">322
</span><span class="lnt">323
</span><span class="lnt">324
</span><span class="lnt">325
</span><span class="lnt">326
</span><span class="lnt">327
</span><span class="lnt">328
</span><span class="lnt">329
</span><span class="lnt">330
</span><span class="lnt">331
</span><span class="lnt">332
</span><span class="lnt">333
</span><span class="lnt">334
</span><span class="lnt">335
</span><span class="lnt">336
</span><span class="lnt">337
</span><span class="lnt">338
</span><span class="lnt">339
</span><span class="lnt">340
</span><span class="lnt">341
</span><span class="lnt">342
</span><span class="lnt">343
</span><span class="lnt">344
</span><span class="lnt">345
</span><span class="lnt">346
</span><span class="lnt">347
</span><span class="lnt">348
</span><span class="lnt">349
</span><span class="lnt">350
</span><span class="lnt">351
</span><span class="lnt">352
</span><span class="lnt">353
</span><span class="lnt">354
</span><span class="lnt">355
</span><span class="lnt">356
</span><span class="lnt">357
</span><span class="lnt">358
</span><span class="lnt">359
</span><span class="lnt">360
</span><span class="lnt">361
</span><span class="lnt">362
</span><span class="lnt">363
</span><span class="lnt">364
</span><span class="lnt">365
</span><span class="lnt">366
</span><span class="lnt">367
</span><span class="lnt">368
</span><span class="lnt">369
</span><span class="lnt">370
</span><span class="lnt">371
</span><span class="lnt">372
</span><span class="lnt">373
</span><span class="lnt">374
</span><span class="lnt">375
</span><span class="lnt">376
</span><span class="lnt">377
</span><span class="lnt">378
</span><span class="lnt">379
</span><span class="lnt">380
</span><span class="lnt">381
</span><span class="lnt">382
</span><span class="lnt">383
</span><span class="lnt">384
</span><span class="lnt">385
</span><span class="lnt">386
</span><span class="lnt">387
</span><span class="lnt">388
</span><span class="lnt">389
</span><span class="lnt">390
</span><span class="lnt">391
</span><span class="lnt">392
</span><span class="lnt">393
</span><span class="lnt">394
</span><span class="lnt">395
</span><span class="lnt">396
</span><span class="lnt">397
</span><span class="lnt">398
</span><span class="lnt">399
</span><span class="lnt">400
</span><span class="lnt">401
</span><span class="lnt">402
</span><span class="lnt">403
</span><span class="lnt">404
</span><span class="lnt">405
</span><span class="lnt">406
</span><span class="lnt">407
</span><span class="lnt">408
</span><span class="lnt">409
</span><span class="lnt">410
</span><span class="lnt">411
</span><span class="lnt">412
</span><span class="lnt">413
</span><span class="lnt">414
</span><span class="lnt">415
</span><span class="lnt">416
</span><span class="lnt">417
</span><span class="lnt">418
</span><span class="lnt">419
</span><span class="lnt">420
</span><span class="lnt">421
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">DiskExtendibleHashTable</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">DiskExtendibleHashTable</span><span class="p">(</span><span class="k">const</span> <span class="n">std</span><span class="o">::</span><span class="n">string</span> <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="n">BufferPoolManager</span> <span class="o">*</span><span class="n">bpm</span><span class="p">,</span><span class="c1">// å“ˆå¸Œè¡¨çš„åç§°ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                                                           <span class="k">const</span> <span class="n">KC</span> <span class="o">&amp;</span><span class="n">cmp</span><span class="p">,</span> <span class="k">const</span> <span class="n">HashFunction</span><span class="o">&lt;</span><span class="n">K</span><span class="o">&gt;</span> <span class="o">&amp;</span><span class="n">hash_fn</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                           <span class="kt">uint32_t</span> <span class="n">header_max_depth</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">directory_max_depth</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                           <span class="kt">uint32_t</span> <span class="n">bucket_max_size</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">:</span> <span class="n">bpm_</span><span class="p">(</span><span class="n">bpm</span><span class="p">),</span><span class="c1">// ç¼“å†²æ± ç®¡ç†å™¨ï¼Œç”¨äºç®¡ç†é¡µé¢çš„åˆ†é…å’Œé‡Šæ”¾ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">cmp_</span><span class="p">(</span><span class="n">cmp</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">hash_fn_</span><span class="p">(</span><span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">hash_fn</span><span class="p">)),</span><span class="c1">// å“ˆå¸Œå‡½æ•°ï¼Œç”¨äºè®¡ç®—é”®çš„å“ˆå¸Œå€¼
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">header_max_depth_</span><span class="p">(</span><span class="n">header_max_depth</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">directory_max_depth_</span><span class="p">(</span><span class="n">directory_max_depth</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="n">bucket_max_size_</span><span class="p">(</span><span class="n">bucket_max_size</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span> <span class="c1">// throw NotImplementedException(&#34;DiskExtendibleHashTable is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">index_name_</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// Create a new header page
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">page_id_t</span> <span class="n">page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// é€šè¿‡ç¼“å†²æ± ç®¡ç†å™¨åˆ›å»ºä¸€ä¸ªæ–°çš„é¡µé¢ï¼Œå¹¶è·å–å…¶ä¿æŠ¤ç‰ˆæœ¬
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">auto</span> <span class="n">tmp_header_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">NewPageGuarded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// å‡çº§ä¸º WritePageGuardï¼Œä»¥è·å¾—å¯¹é¡µé¢çš„å†™æƒé™ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">auto</span> <span class="n">header_guard</span> <span class="o">=</span> <span class="n">tmp_header_guard</span><span class="p">.</span><span class="n">UpgradeWrite</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// å°†é¡µé¢è½¬æ¢ä¸º ExtendibleHTableHeaderPage ç±»å‹ï¼Œä»¥ä¾¿è¿›è¡Œç±»å‹å®‰å…¨çš„æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="k">auto</span> <span class="n">header_page</span> <span class="o">=</span> <span class="n">header_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableHeaderPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// è°ƒç”¨æ ‡é¢˜é¡µé¢çš„ Init æ–¹æ³•ï¼Œåˆå§‹åŒ–æ ‡é¢˜é¡µé¢çš„æœ€å¤§æ·±åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">header_page</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">header_max_depth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">   <span class="c1">// å°†æ–°åˆ›å»ºçš„æ ‡é¢˜é¡µé¢çš„ ID å­˜å‚¨åœ¨æˆå‘˜å˜é‡ä¸­ï¼Œä»¥ä¾¿åç»­è®¿é—®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="n">header_page_id_</span> <span class="o">=</span> <span class="n">page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">   <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * SEARCH
</span></span></span><span class="line"><span class="cl"><span class="cm"> *****************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="c1">// æŸ¥æ‰¾é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1">// GetValue æ–¹æ³•çš„ä¸»è¦åŠŸèƒ½æ˜¯æ ¹æ®ç»™å®šçš„é”® keyï¼Œåœ¨å¯æ‰©å±•å“ˆå¸Œè¡¨ä¸­æŸ¥æ‰¾å¯¹åº”çš„å€¼ï¼Œå¹¶å°†ç»“æœå­˜å‚¨åœ¨ result å‚æ•°ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">// å¦‚æœæ‰¾åˆ°é”®å€¼å¯¹ï¼Œè¿”å› trueï¼›å¦åˆ™è¿”å› falseã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">DiskExtendibleHashTable</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">GetValue</span><span class="p">(</span><span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="n">V</span><span class="o">&gt;</span> <span class="o">*</span><span class="n">result</span><span class="p">,</span> <span class="n">Transaction</span> <span class="o">*</span><span class="n">transaction</span><span class="p">)</span> <span class="k">const</span>
</span></span><span class="line"><span class="cl">    <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è·å–æ ‡é¢˜é¡µé¢çš„è¯»ä¿æŠ¤,ç¡®ä¿äº†åœ¨è¯»å–æ ‡é¢˜é¡µé¢æ—¶ï¼Œé¡µé¢ä¸ä¼šè¢«ä¿®æ”¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">header_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageRead</span><span class="p">(</span><span class="n">header_page_id_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å°†è·å–åˆ°çš„é¡µé¢è½¬æ¢ä¸º ExtendibleHTableHeaderPage ç±»å‹ï¼Œä»¥ä¾¿è¿›è¡Œç±»å‹å®‰å…¨çš„æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">header_page</span> <span class="o">=</span> <span class="n">header_guard</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">ExtendibleHTableHeaderPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint32_t</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">key</span><span class="p">);</span><span class="c1">// ä½¿ç”¨å“ˆå¸Œå‡½æ•°è®¡ç®—é”®çš„å“ˆå¸Œå€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// å“ˆå¸Œå€¼è®¡ç®—ç›®å½•é¡µé¢çš„ç´¢å¼•ã€‚è¿™ä¸ªç´¢å¼•ç”¨äºåœ¨æ ‡é¢˜é¡µé¢ä¸­æ‰¾åˆ°å¯¹åº”çš„ç›®å½•é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">directory_index</span> <span class="o">=</span> <span class="n">header_page</span><span class="o">-&gt;</span><span class="n">HashToDirectoryIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// æ ‡é¢˜é¡µé¢çš„ GetDirectoryPageId æ–¹æ³•ï¼Œè·å–ç›®å½•é¡µé¢çš„ IDã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">page_id_t</span> <span class="n">directory_page_id</span> <span class="o">=</span> <span class="n">header_page</span><span class="o">-&gt;</span><span class="n">GetDirectoryPageId</span><span class="p">(</span><span class="n">directory_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½•é¡µé¢ ID æ— æ•ˆï¼ˆå³ç­‰äº INVALID_PAGE_IDï¼‰ï¼Œè¿”å› falseï¼Œè¡¨ç¤ºæŸ¥æ‰¾å¤±è´¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">directory_page_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">INVALID_PAGE_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ç¼“å†²æ± ç®¡ç†å™¨çš„ FetchPageRead æ–¹æ³•è·å–ç›®å½•é¡µé¢çš„è¯»ä¿æŠ¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadPageGuard</span> <span class="n">directory_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageRead</span><span class="p">(</span><span class="n">directory_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è·å–åˆ°çš„é¡µé¢è½¬æ¢ä¸º ExtendibleHTableDirectoryPage ç±»å‹ï¼Œä»¥ä¾¿è¿›è¡Œç±»å‹å®‰å…¨çš„æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">directory_page</span> <span class="o">=</span> <span class="n">directory_guard</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">ExtendibleHTableDirectoryPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒç”¨ç›®å½•é¡µé¢çš„ HashToBucketIndex æ–¹æ³•ï¼Œæ ¹æ®å“ˆå¸Œå€¼è®¡ç®—å­˜å‚¨æ¡¶é¡µé¢çš„ç´¢å¼•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è¿™ä¸ªç´¢å¼•ç”¨äºåœ¨ç›®å½•é¡µé¢ä¸­æ‰¾åˆ°å¯¹åº”çš„å­˜å‚¨æ¡¶é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">bucket_index</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">HashToBucketIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è°ƒç”¨ç›®å½•é¡µé¢çš„ GetBucketPageId æ–¹æ³•ï¼Œè·å–å­˜å‚¨æ¡¶é¡µé¢çš„ ID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">page_id_t</span> <span class="n">bucket_page_id</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœå­˜å‚¨æ¡¶é¡µé¢ ID æ— æ•ˆï¼ˆå³ç­‰äº INVALID_PAGE_IDï¼‰ï¼Œè¿”å› falseï¼Œè¡¨ç¤ºæŸ¥æ‰¾å¤±è´¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bucket_page_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">INVALID_PAGE_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// ä½¿ç”¨ç¼“å†²æ± ç®¡ç†å™¨çš„ FetchPageRead æ–¹æ³•è·å–å­˜å‚¨æ¡¶é¡µé¢çš„è¯»ä¿æŠ¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">ReadPageGuard</span> <span class="n">bucket_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageRead</span><span class="p">(</span><span class="n">bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// è·å–åˆ°çš„é¡µé¢è½¬æ¢ä¸º ExtendibleHTableBucketPage ç±»å‹ï¼Œä»¥ä¾¿è¿›è¡Œç±»å‹å®‰å…¨çš„æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">auto</span> <span class="n">bucket_page</span> <span class="o">=</span> <span class="n">bucket_guard</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">        <span class="n">V</span> <span class="n">value</span><span class="p">;</span><span class="c1">// å£°æ˜ä¸€ä¸ªå€¼å˜é‡ï¼Œç”¨äºå­˜å‚¨æŸ¥æ‰¾ç»“æœ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// è°ƒç”¨å­˜å‚¨æ¡¶é¡µé¢çš„ Lookup æ–¹æ³•ï¼Œåœ¨å­˜å‚¨æ¡¶é¡µé¢ä¸­æŸ¥æ‰¾é”®å€¼å¯¹ã€‚å¦‚æœæ‰¾åˆ°ï¼Œvalue å°†è¢«è®¾ç½®ä¸ºå¯¹åº”çš„å€¼ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="kt">bool</span> <span class="n">lookup_success</span> <span class="o">=</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Lookup</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">lookup_success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="n">result</span><span class="o">-&gt;</span><span class="n">push_back</span><span class="p">(</span><span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="nb">true</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * INSERTION
</span></span></span><span class="line"><span class="cl"><span class="cm"> å…ˆæ‰¾header_pageï¼Œåˆ¤æ–­ç›®å½•é¡µé¢ IDæ˜¯å¦æœ‰æ•ˆï¼Œæ²¡æœ‰ï¼Œåˆ™InsertToNewDirectory æ–¹æ³•åˆ›å»ºæ–°çš„ç›®å½•é¡µé¢å¹¶æ’å…¥é”®å€¼å¯¹ï¼Œç„¶åé‡Šæ”¾
</span></span></span><span class="line"><span class="cl"><span class="cm"> æ‰¾directory_pageï¼Œåˆ¤æ–­å­˜å‚¨æ¡¶é¡µé¢ IDæ˜¯å¦æœ‰æ•ˆï¼Œæ²¡æœ‰ï¼Œåˆ™ InsertToNewBucket æ–¹æ³•åˆ›å»ºæ–°çš„å­˜å‚¨æ¡¶é¡µé¢å¹¶æ’å…¥é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> åˆ°å¤„ç†å­˜å‚¨æ¡¶æ—¶ï¼Œæœ‰é‡å¤åˆ™è¿”å›falseï¼›æ¡¶æ²¡æ»¡ï¼Œåˆ™æ’å…¥æˆåŠŸï¼›
</span></span></span><span class="line"><span class="cl"><span class="cm"> æ¡¶æ»¡æ—¶ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">		å¦‚æœlocal&lt;Global:
</span></span></span><span class="line"><span class="cl"><span class="cm">				åˆ™é€šè¿‡ç¼“å†²æ± ç®¡ç†å™¨åˆ›å»ºæ–°çš„å­˜å‚¨æ¡¶é¡µé¢ï¼Œç„¶ålocal++ï¼›å†æŠŠæ—§æ¡¶é‡Œçš„æ•°æ®é‡æ–°åˆ†é…åˆ°æ–°æ¡¶é‡Œï¼Œå†æŠŠæ—§æ¡¶ä¸­è¢«åˆ†é…å‡ºæ¥çš„æ•°æ®åˆ æ‰ã€‚å¦‚æœæ–°æ¡¶ä¹Ÿæ»¡äº†ï¼Œåˆ™è¿›è¡Œå¾ªç¯ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">		å¦‚æœlocal=Global:
</span></span></span><span class="line"><span class="cl"><span class="cm">				å¦‚æœGlobal=maxdepth: åˆ™è¿”å›å¤±è´¥ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm">				å¦‚æœGlobal&lt;maxdepth: åˆ™Global++(æ–°å¢çš„éƒ¨åˆ†çš„å†…å®¹ä¸ºåŸéƒ¨åˆ†çš„å¤åˆ¶),ç„¶åå†æŒ‰local&lt;Globalçš„çŠ¶å†µå¤„ç†ã€‚
</span></span></span><span class="line"><span class="cl"><span class="cm"> *****************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å°†é”®å€¼å¯¹æ’å…¥åˆ°å¯æ‰©å±•å“ˆå¸Œè¡¨ä¸­ã€‚å¦‚æœé”®å·²å­˜åœ¨ï¼Œè¿”å› falseï¼›å¦‚æœæ’å…¥æˆåŠŸï¼Œè¿”å› trueã€‚å¦‚æœå­˜å‚¨æ¡¶æ»¡ï¼Œåˆ™éœ€è¦è¿›è¡Œåˆ†è£‚æ“ä½œã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">DiskExtendibleHashTable</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">Insert</span><span class="p">(</span><span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">V</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">,</span> <span class="n">Transaction</span> <span class="o">*</span><span class="n">transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//è¦æ’å…¥å…ƒç´ å…ˆä¸€æ­¥ä¸€æ­¥æ˜ å°„åˆ°æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ç¼“å†²æ± ç®¡ç†å™¨çš„ FetchPageWrite æ–¹æ³•è·å–æ ‡é¢˜é¡µé¢çš„å†™ä¿æŠ¤ã€‚è¿™ç¡®ä¿äº†åœ¨å†™å…¥æ ‡é¢˜é¡µé¢æ—¶ï¼Œé¡µé¢ä¸ä¼šè¢«å…¶ä»–æ“ä½œä¿®æ”¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">header_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageWrite</span><span class="p">(</span><span class="n">header_page_id_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">header_page</span> <span class="o">=</span> <span class="n">header_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableHeaderPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="kt">uint32_t</span> <span class="n">directory_index</span> <span class="o">=</span> <span class="n">header_page</span><span class="o">-&gt;</span><span class="n">HashToDirectoryIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">directory_page_id</span> <span class="o">=</span> <span class="n">header_page</span><span class="o">-&gt;</span><span class="n">GetDirectoryPageId</span><span class="p">(</span><span class="n">directory_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœç›®å½•é¡µé¢ ID æ— æ•ˆï¼ˆå³ç­‰äº INVALID_PAGE_IDï¼‰ï¼Œè°ƒç”¨ InsertToNewDirectory æ–¹æ³•åˆ›å»ºæ–°çš„ç›®å½•é¡µé¢å¹¶æ’å…¥é”®å€¼å¯¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">directory_page_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">INVALID_PAGE_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">auto</span> <span class="n">insert_success</span> <span class="o">=</span> <span class="n">InsertToNewDirectory</span><span class="p">(</span><span class="n">header_page</span><span class="p">,</span> <span class="n">directory_index</span><span class="p">,</span> <span class="n">hash</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">insert_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// é‡Šæ”¾æ ‡é¢˜é¡µé¢çš„å†™ä¿æŠ¤ï¼Œå› ä¸ºåç»­æ“ä½œä¸éœ€è¦å†ä¿®æ”¹æ ‡é¢˜é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">header_guard</span><span class="p">.</span><span class="n">Drop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–ç›®å½•é¡µé¢çš„å†™ä¿æŠ¤ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WritePageGuard</span> <span class="n">directory_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageWrite</span><span class="p">(</span><span class="n">directory_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">directory_page</span> <span class="o">=</span> <span class="n">directory_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableDirectoryPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">bucket_index</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">HashToBucketIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">bucket_page_id</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå­˜å‚¨æ¡¶é¡µé¢ ID æ— æ•ˆï¼ˆå³ç­‰äº INVALID_PAGE_IDï¼‰ï¼Œè°ƒç”¨ InsertToNewBucket æ–¹æ³•åˆ›å»ºæ–°çš„å­˜å‚¨æ¡¶é¡µé¢å¹¶æ’å…¥é”®å€¼å¯¹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bucket_page_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">INVALID_PAGE_ID</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//è¦æ˜¾ç¤ºè½¬æ¢ç±»å‹ï¼Œä½¿å…¶ç­‰å·å·¦å³ä¸¤è¾¹ç›¸ç­‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">insert_success</span> <span class="o">=</span> <span class="n">InsertToNewBucket</span><span class="p">(</span><span class="n">directory_page</span><span class="p">,</span> <span class="n">bucket_index</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">insert_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// Check whether the bucket is full or not.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">bool</span> <span class="n">insert_success</span> <span class="o">=</span> <span class="nb">false</span><span class="p">;</span><span class="c1">// å£°æ˜ä¸€ä¸ªå¸ƒå°”å˜é‡ï¼Œç”¨äºæ ‡è®°æ’å…¥æ“ä½œæ˜¯å¦æˆåŠŸã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// ä½¿ç”¨ç¼“å†²æ± ç®¡ç†å™¨çš„ FetchPageWrite æ–¹æ³•è·å–å­˜å‚¨æ¡¶é¡µé¢çš„å†™ä¿æŠ¤ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">WritePageGuard</span> <span class="n">bucket_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageWrite</span><span class="p">(</span><span class="n">bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">bucket_page</span> <span class="o">=</span> <span class="n">bucket_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="n">V</span> <span class="n">tmp_val</span><span class="p">;</span><span class="c1">// å£°æ˜ä¸€ä¸ªä¸´æ—¶å€¼å˜é‡ï¼Œç”¨äºå­˜å‚¨æŸ¥æ‰¾ç»“æœã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">//å¦‚æœå·²å­˜åœ¨è¯¥é”®å€¼åˆ™ä¸éœ€è¦æ’å…¥ç›´æ¥è¿”å›false
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Lookup</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">tmp_val</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å¦‚æœå­˜å‚¨æ¡¶æœªæ»¡ï¼Œç›´æ¥æ’å…¥é”®å€¼å¯¹å¹¶è¿”å›ç»“æœã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">IsFull</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">insert_success</span> <span class="o">=</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">return</span> <span class="n">insert_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//æ¡¶æ»¡äº†ï¼Œé‚£ä¹ˆæ‰©å±•é‚£ä¸ªæ¡¶çš„å±€éƒ¨æ·±åº¦ï¼Œç„¶ååˆ†è£‚æ¡¶ï¼Œç„¶åå°†å€¼é‡æ–°hashï¼Œè¦ä¸åœçš„å¾ªç¯å¯èƒ½åˆ†è£‚åæ¡¶åœ¨hashåä¾æ—§ä¼šæ»¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="o">!</span><span class="n">insert_success</span> <span class="o">&amp;&amp;</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">IsFull</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetGlobalDepth</span><span class="p">()</span> <span class="o">==</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">))</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetGlobalDepth</span><span class="p">()</span> <span class="o">==</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetMaxDepth</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// directory growing
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">IncrGlobalDepth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//è¦åˆ†è£‚æ¡¶éœ€è¦é€šè¿‡ç¼“å†²åŒºé‡æ–°è·å¾—ä¸€å—é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">page_id_t</span> <span class="n">new_bucket_page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// é€šè¿‡ç¼“å†²æ± ç®¡ç†å™¨åˆ›å»ºæ–°çš„å­˜å‚¨æ¡¶é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">tmp_new_bucket_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">NewPageGuarded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">new_bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">auto</span> <span class="n">new_bucket_guard</span> <span class="o">=</span> <span class="n">tmp_new_bucket_guard</span><span class="p">.</span><span class="n">UpgradeWrite</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="k">auto</span> <span class="n">new_bucket_page</span> <span class="o">=</span> <span class="n">new_bucket_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">new_bucket_page</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">bucket_max_size_</span><span class="p">);</span>       <span class="c1">//è°ƒç”¨ Init æ–¹æ³•åˆå§‹åŒ–æ–°å­˜å‚¨æ¡¶é¡µé¢ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">IncrLocalDepth</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>  <span class="c1">//å¢åŠ åŸæ¡¶å±€éƒ¨æ·±åº¦ï¼ˆåŸæ¡¶ä¸º0ï¼Œæ–°æ¡¶ä¸º1ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// è·å–æ–°çš„å±€éƒ¨æ·±åº¦å’Œæ©ç ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">new_local_depth</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">auto</span> <span class="n">local_depth_mask</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepthMask</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//å› ä¸ºæ–°å»ºäº†ä¸€ä¸ªæ¡¶é¡µé‚£ä¹ˆè¦é‡æ–°è¿›è¡Œå“ˆå¸Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// è°ƒç”¨ UpdateDirectoryMapping æ–¹æ³•æ›´æ–°ç›®å½•é¡µé¢ä¸­çš„æ˜ å°„ï¼Œç¡®ä¿æ–°å­˜å‚¨æ¡¶é¡µé¢è¢«æ­£ç¡®å¼•ç”¨ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">new_bucket_idx</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">          <span class="n">UpdateDirectoryMapping</span><span class="p">(</span><span class="n">directory_page</span><span class="p">,</span> <span class="n">bucket_index</span><span class="p">,</span> <span class="n">new_bucket_page_id</span><span class="p">,</span> <span class="n">new_local_depth</span><span class="p">,</span> <span class="n">local_depth_mask</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Rehash the old bucket&#39;s KV pairs.
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">page_id_t</span> <span class="n">rehash_page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">std</span><span class="o">::</span><span class="n">vector</span><span class="o">&lt;</span><span class="kt">uint32_t</span><span class="o">&gt;</span> <span class="n">remove_array</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å°†å½“æ—¶çš„æ»¡æ¡¶é‡Œé¢çš„é¡µé‡æ–°hash,å› ä¸ºå¢åŠ äº†å±€éƒ¨æ·±åº¦å’Œåˆ†è£‚äº†æ¡¶æ‰€ä»¥éœ€è¦é‡æ–°åˆ†é…
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// éå†å½“å‰å­˜å‚¨æ¡¶ä¸­çš„æ‰€æœ‰é”®å€¼å¯¹ï¼Œé‡æ–°è®¡ç®—å®ƒä»¬çš„å“ˆå¸Œå€¼ï¼Œå¹¶å°†å®ƒä»¬æ’å…¥åˆ°æ–°å­˜å‚¨æ¡¶é¡µé¢æˆ–åŸå­˜å‚¨æ¡¶é¡µé¢ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// è®°å½•éœ€è¦ä»åŸå­˜å‚¨æ¡¶ä¸­ç§»é™¤çš„é”®å€¼å¯¹çš„ç´¢å¼•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// éå†åŸæ¡¶é”®å€¼å¯¹å¹¶é‡æ–°å“ˆå¸Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">();</span> <span class="o">++</span><span class="n">i</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">k</span> <span class="o">=</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">KeyAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">v</span> <span class="o">=</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">ValueAt</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="kt">uint32_t</span> <span class="n">hash_k</span> <span class="o">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">auto</span> <span class="n">rehash_idx</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">HashToBucketIndex</span><span class="p">(</span><span class="n">hash_k</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">rehash_page_id</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="n">rehash_idx</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">rehash_page_id</span> <span class="o">==</span> <span class="n">new_bucket_page_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">new_bucket_page</span><span class="o">-&gt;</span><span class="n">Insert</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">v</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">remove_array</span><span class="p">.</span><span class="n">push_back</span><span class="p">(</span><span class="n">i</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// ç”±äºæ¯æ¬¡åˆ é™¤æ“ä½œä¼šæ”¹å˜åŸæ¡¶çš„æ•°ç»„ä¸‹æ ‡ï¼Œéœ€ç”¨helperå˜é‡è®°å½•å·²åˆ é™¤å…ƒç´ çš„æ•°é‡ï¼Œç¡®ä¿åç»­åˆ é™¤ä½ç½®æ­£ç¡®ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">helper</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>  <span class="c1">// è€ƒè™‘arrayç§»é™¤æ—¶éœ€è¦åˆ é™¤å…ƒç´ çš„ä¸‹æ ‡å˜åŒ–
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="k">auto</span> <span class="o">&amp;</span><span class="nl">remove_id</span> <span class="p">:</span> <span class="n">remove_array</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å½“ä»æ•°ç»„ä¸­æŒ‰ç´¢å¼•é¡ºåºåˆ é™¤å…ƒç´ æ—¶ï¼Œæ¯æ¬¡åˆ é™¤æ“ä½œä¼šå¯¼è‡´åç»­å…ƒç´ çš„ç´¢å¼•è‡ªåŠ¨å‰ç§»
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">RemoveAt</span><span class="p">(</span><span class="n">remove_id</span> <span class="o">-</span> <span class="n">helper</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">helper</span><span class="o">++</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">      <span class="c1">// æ’å…¥æ–°çš„é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">bucket_index</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">HashToBucketIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">rehash_page_id</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="k">if</span> <span class="p">(</span><span class="n">rehash_page_id</span> <span class="o">==</span> <span class="n">new_bucket_page_id</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">insert_success</span> <span class="o">=</span> <span class="n">new_bucket_page</span><span class="o">-&gt;</span><span class="n">Insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="c1">// å¦‚æœæ–°æ¡¶æ’å…¥åå†æ¬¡æ»¡ï¼ˆä¾‹å¦‚å“ˆå¸Œå†²çªä¸¥é‡ï¼‰ï¼Œ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="c1">// éœ€é‡æ–°è¿›å…¥åˆ†è£‚å¾ªç¯ï¼ˆwhile (!insert_success &amp;&amp; bucket_page-&gt;IsFull())ï¼‰ï¼Œç›´åˆ°æ’å…¥æˆåŠŸæˆ–è¾¾åˆ°æœ€å¤§æ·±åº¦ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">insert_success</span> <span class="o">&amp;&amp;</span> <span class="n">new_bucket_page</span><span class="o">-&gt;</span><span class="n">IsFull</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="n">bucket_guard</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">new_bucket_guard</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="n">bucket_page_id</span> <span class="o">=</span> <span class="n">new_bucket_page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">bucket_page</span> <span class="o">=</span> <span class="n">new_bucket_page</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">          <span class="n">bucket_index</span> <span class="o">=</span> <span class="n">new_bucket_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">insert_success</span> <span class="o">=</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">insert_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// å¯æ‰©å±•å“ˆå¸Œè¡¨ä¸­æ’å…¥æ•°æ®æ—¶ï¼Œå½“éœ€è¦åˆ›å»ºæ–°ç›®å½•é¡µ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">DiskExtendibleHashTable</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">InsertToNewDirectory</span><span class="p">(</span><span class="n">ExtendibleHTableHeaderPage</span> <span class="o">*</span><span class="n">header</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">directory_idx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                             <span class="kt">uint32_t</span> <span class="n">hash</span><span class="p">,</span> <span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">V</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// åœ¨ç£ç›˜ä¸Šåˆ›å»ºä¸€ä¸ªæ–°çš„ç›®å½•é¡µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">page_id_t</span> <span class="n">dir_page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">tmp_directory_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">NewPageGuarded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">dir_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">directory_guard</span> <span class="o">=</span> <span class="n">tmp_directory_guard</span><span class="p">.</span><span class="n">UpgradeWrite</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†æ–°åˆ†é…çš„é¡µåˆå§‹åŒ–ä¸ºç›®å½•é¡µã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">directory_page</span> <span class="o">=</span> <span class="n">directory_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableDirectoryPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">directory_max_depth_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†æ–°ç›®å½•é¡µçš„IDè®°å½•åˆ°å“ˆå¸Œè¡¨çš„å¤´éƒ¨é¡µä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">header</span><span class="o">-&gt;</span><span class="n">SetDirectoryPageId</span><span class="p">(</span><span class="n">directory_idx</span><span class="p">,</span> <span class="n">dir_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ ¹æ®å“ˆå¸Œå€¼è®¡ç®—é”®å€¼å¯¹åº”åœ¨ç›®å½•é¡µä¸­çš„æ¡¶ç´¢å¼•ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">bucket_idx</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">HashToBucketIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†é”®å€¼å¯¹æ’å…¥åˆ°æ–°ç›®å½•é¡µå¯¹åº”çš„æ¡¶ä¸­ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">insert_success</span> <span class="o">=</span> <span class="n">InsertToNewBucket</span><span class="p">(</span><span class="n">directory_page</span><span class="p">,</span> <span class="n">bucket_idx</span><span class="p">,</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">insert_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="c1">// åœ¨å¯æ‰©å±•å“ˆå¸Œè¡¨ä¸­åˆ›å»ºä¸€ä¸ªæ–°çš„å­˜å‚¨æ¡¶ï¼ˆBucketï¼‰ï¼Œå¹¶å°†é”®å€¼å¯¹æ’å…¥å…¶ä¸­
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">DiskExtendibleHashTable</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">InsertToNewBucket</span><span class="p">(</span><span class="n">ExtendibleHTableDirectoryPage</span> <span class="o">*</span><span class="n">directory</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">bucket_idx</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                          <span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="k">const</span> <span class="n">V</span> <span class="o">&amp;</span><span class="n">value</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">page_id_t</span> <span class="n">bucket_page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// â€‹åˆ›å»ºæ–°æ¡¶é¡µé¢
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">tmp_bucket_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">NewPageGuarded</span><span class="p">(</span><span class="o">&amp;</span><span class="n">bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å‡çº§ä¸ºå†™ä¿æŠ¤å¹¶è½¬æ¢é¡µé¢ç±»å‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">bucket_guard</span> <span class="o">=</span> <span class="n">tmp_bucket_guard</span><span class="p">.</span><span class="n">UpgradeWrite</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">bucket_page</span> <span class="o">=</span> <span class="n">bucket_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Init</span><span class="p">(</span><span class="n">bucket_max_size_</span><span class="p">);</span><span class="c1">// åˆå§‹åŒ–æ¡¶ï¼Œè®¾ç½®å…¶æœ€å¤§å®¹é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// â€‹æ›´æ–°ç›®å½•é¡µä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">directory</span><span class="o">-&gt;</span><span class="n">SetBucketPageId</span><span class="p">(</span><span class="n">bucket_idx</span><span class="p">,</span> <span class="n">bucket_page_id</span><span class="p">);</span><span class="c1">// å°†ç›®å½•é¡¹ bucket_idx ç»‘å®šåˆ°æ–°æ¡¶çš„é¡µé¢IDã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">directory</span><span class="o">-&gt;</span><span class="n">SetLocalDepth</span><span class="p">(</span><span class="n">bucket_idx</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span><span class="c1">// è®¾ç½®è¯¥æ¡¶çš„å±€éƒ¨æ·±åº¦ï¼ˆåˆå§‹ä¸º0ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">assert</span><span class="p">(</span><span class="n">directory</span><span class="o">-&gt;</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">bucket_idx</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">directory</span><span class="o">-&gt;</span><span class="n">GetGlobalDepth</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°†é”®å€¼å¯¹æ’å…¥æ–°æ¡¶ï¼Œcmp_ä¸ºé”®æ¯”è¾ƒå™¨ï¼ˆå¦‚åˆ¤æ–­é”®æ˜¯å¦ç›¸ç­‰ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">insert_success</span> <span class="o">=</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Insert</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">value</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">insert_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">// template &lt;typename K, typename V, typename KC&gt;
</span></span></span><span class="line"><span class="cl"><span class="c1">// void DiskExtendibleHashTable&lt;K, V, KC&gt;::UpdateDirectoryMapping(ExtendibleHTableDirectoryPage *directory,
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                                                uint32_t new_bucket_idx, page_id_t new_bucket_page_id,
</span></span></span><span class="line"><span class="cl"><span class="c1">//                                                                uint32_t new_local_depth, uint32_t local_depth_mask) {
</span></span></span><span class="line"><span class="cl"><span class="c1">//   //throw NotImplementedException(&#34;DiskExtendibleHashTable is not implemented&#34;);
</span></span></span><span class="line"><span class="cl"><span class="c1">// }
</span></span></span><span class="line"><span class="cl"><span class="c1">// åœ¨å¯æ‰©å±•å“ˆå¸Œè¡¨ä¸­æ›´æ–°ç›®å½•é¡µçš„æ˜ å°„å…³ç³»ï¼Œä¸»è¦å‘ç”Ÿåœ¨æ¡¶åˆ†è£‚åé‡æ–°åˆ†é…ç›®å½•é¡¹ä¸æ¡¶çš„å¯¹åº”å…³ç³»ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1">//ï¼ˆæ¡¶åˆ†è£‚æ—¶ï¼Œåªæœ‰åŸæ¡¶å’Œæ–°æ¡¶ä¸ç›®å½•é¡µé¢ä¹‹é—´çš„æ˜ å°„ä¼šå‘ç”Ÿå˜åŒ–ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">DiskExtendibleHashTable</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">UpdateDirectoryMapping</span><span class="p">(</span><span class="n">ExtendibleHTableDirectoryPage</span> <span class="o">*</span><span class="n">directory_page</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                               <span class="kt">uint32_t</span> <span class="n">old_bucket_idx</span><span class="p">,</span> <span class="n">page_id_t</span> <span class="n">new_bucket_page_id</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                                                               <span class="kt">uint32_t</span> <span class="n">new_local_depth</span><span class="p">,</span> <span class="kt">uint32_t</span> <span class="n">local_depth_mask</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">    <span class="o">-&gt;</span> <span class="kt">uint32_t</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//æ›´æ–°æ˜ å°„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è®¡ç®—æ–°èµ·å§‹ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    
</span></span><span class="line"><span class="cl">  <span class="c1">// è¿™é‡Œæ˜¯é€šè¿‡local_depth_mask &amp; old_bucket_idxï¼ˆegï¼š00ï¼ˆ000å’Œ100çš„åŸç”Ÿï¼Œä½†æ˜¯ç”±äº000ç­‰äº00ï¼Œæ•…ä¸ºæ—§æ¡¶çš„æ–°idxï¼‰ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">new_first_bucket_idx</span> <span class="o">=</span> <span class="n">local_depth_mask</span> <span class="o">&amp;</span> <span class="n">old_bucket_idx</span><span class="p">;</span>  <span class="c1">// 111111111&amp; old_bucket_idx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">prime_idx</span> <span class="o">=</span> <span class="n">new_first_bucket_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">distance</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl">      <span class="n">pow</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="n">new_local_depth</span><span class="p">);</span>  <span class="c1">//è¿™ä¸ªæ„æ€å°±æ˜¯ç”±å±€éƒ¨æ·±åº¦å¾—åˆ°ä¸€ä¸ªå‘¨æœŸé•¿åº¦æ¯”å¦‚000 001 002 é‚£ä¹ˆ000åŠ ä¸Š8å°±è¿˜æ˜¯000
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//è¿‡äº†ä¸€åŠå‡å»ä¸€åŠï¼Œæ²¡è¿‡ä¸€åŠåŠ ä¸Šä¸€åŠ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//ä»æœ€å°çš„ä¸‹æ ‡å¼€å§‹ æ¯”å¦‚000å°±è¦å˜æˆ100ï¼Œè¿™é‡Œå°±è·å¾—äº†æ–°æ¡¶çš„idx
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">new_first_bucket_idx</span> <span class="o">=</span> <span class="p">(</span><span class="n">new_first_bucket_idx</span> <span class="o">&gt;&gt;</span> <span class="p">(</span><span class="n">new_local_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">?</span> <span class="p">(</span><span class="n">new_first_bucket_idx</span> <span class="o">+</span> <span class="p">(</span><span class="n">distance</span> <span class="o">/</span> <span class="mi">2</span><span class="p">))</span>
</span></span><span class="line"><span class="cl">                                                                              <span class="o">:</span> <span class="p">(</span><span class="n">new_first_bucket_idx</span> <span class="o">-</span> <span class="p">(</span><span class="n">distance</span> <span class="o">/</span> <span class="mi">2</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="c1">// é‡æ–°æ˜ å°„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">new_first_bucket_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">();</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">distance</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">SetBucketPageId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">new_bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">SetLocalDepth</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">new_local_depth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">SetLocalDepth</span><span class="p">(</span><span class="n">prime_idx</span><span class="p">,</span> <span class="n">new_local_depth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetGlobalDepth</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">assert</span><span class="p">(</span><span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">prime_idx</span><span class="p">)</span> <span class="o">&lt;=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetGlobalDepth</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">    <span class="n">prime_idx</span> <span class="o">+=</span> <span class="n">distance</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">new_first_bucket_idx</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="cm">/*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="cm"> * REMOVE
</span></span></span><span class="line"><span class="cl"><span class="cm"> å¯æ‰©å±•å“ˆå¸Œè¡¨çš„é”®å€¼å¯¹åˆ é™¤æ“ä½œï¼Œæ ¸å¿ƒåŠŸèƒ½åŒ…æ‹¬ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm">	â€‹å®šä½ç›®æ ‡å­˜å‚¨æ¡¶â€‹ï¼ˆä¸‰çº§ç»“æ„ï¼šHeader Page â†’ Directory Page â†’ Bucket Pageï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm"> 	â€‹åˆ é™¤é”®å€¼å¯¹â€‹ï¼ˆè‹¥å­˜åœ¨ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm"> 	â€‹å¤„ç†ç©ºæ¡¶åˆå¹¶â€‹ï¼ˆæ”¶ç¼©ç›®å½•å’Œæ¡¶ç»“æ„ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="cm"> 		å…ˆè·å–æ¡¶çš„localæ·±åº¦ï¼Œä¸º0åˆ™æ— éœ€åˆå¹¶ï¼Œç›´æ¥é€€å‡ºå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> 		å¦åˆ™ï¼Œå¼€å§‹å¾ªç¯ï¼š
</span></span></span><span class="line"><span class="cl"><span class="cm"> 			è·å–é•œåƒæ¡¶ã€ä¸åŸæ¡¶å…±äº«çˆ¶æ¡¶çš„å¦ä¸€ä¸ªå­æ¡¶ï¼ˆä¾‹å¦‚åŸæ¡¶ç´¢å¼•ä¸º0b101ï¼Œé•œåƒæ¡¶ä¸º0b001ï¼‰ã€‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> 			å¦‚æœç©ºæ¡¶å’Œé•œåƒæ¡¶æ·±åº¦ä¸€æ ·ï¼Œåˆ™åˆå¹¶ã€æ›´æ–°ç›®å½•æ˜ å°„ï¼Œåˆå¹¶å­˜å‚¨æ¡¶ã€‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> 				è·å–ç›®å½•é¡µé¢ä¸­ç¬¬ä¸€ä¸ªæŒ‡å‘ç©ºæ¡¶å’Œæƒ³è¦åˆå¹¶æ¡¶çš„åœ°æ–¹
</span></span></span><span class="line"><span class="cl"><span class="cm"> 				è·å–æ­¥é•¿ã€æ¯ä¸ªæŒ‡å‘åˆå¹¶å­˜å‚¨æ¡¶çš„ç›®å½•é¡µé¢å†…çš„ç›¸é‚»çš„ä¿©ä¸ªå†…å®¹ä¹‹é—´çš„é—´è·ï¼Œè¿™ä¸ªé—´è·åº”è¯¥æ˜¯å›ºå®šå¤§å°çš„ã€‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> 				éå†é‡‡ç”¨è·³è·ƒå¼æ›´æ–°ï¼Œä¾‹å¦‚æ·±åº¦3æ—¶æ¯éš”4ä¸ªç›®å½•é¡¹æ›´æ–°ä¸€æ¬¡ã€è¿™é‡Œæ˜¯æŠŠç›®å½•é¡µé¢æ•°ç»„éƒ½æŒ‡å‘é•œåƒæ¡¶çš„idã€‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> 				å¤„ç†çˆ¶çº§åˆå¹¶
</span></span></span><span class="line"><span class="cl"><span class="cm"> 					å…ˆè·å–æ¡¶çš„localæ·±åº¦ï¼Œä¸º0åˆ™æ— éœ€åˆå¹¶ï¼Œç›´æ¥é€€å‡ºå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> 					è¿™é‡Œç”±äºlocal--äº†ï¼Œæ‰€ä»¥é•œåƒæ¡¶çš„idxæ˜¯ç›´æ¥å–localä½çš„ã€‚ã€eg:111-&gt;11ã€‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> 					è·å–è¯¥çˆ¶çº§çš„é•œåƒæ¡¶ã€01ã€‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> 					ç„¶åæŠŠçˆ¶çº§çš„é•œåƒæ¡¶çš„ä¿¡æ¯æ”¾åˆ°bucket_indexé‡Œï¼Œå†æ¬¡è¿›å…¥å¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> 					å‡å°‘ç›®å½•æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="cm"> 			å¦åˆ™ï¼Œè·³å‡ºå¾ªç¯
</span></span></span><span class="line"><span class="cl"><span class="cm"> 	â€‹åŠ¨æ€è°ƒæ•´å…¨å±€æ·±åº¦ã€å³å‡å°‘ç›®å½•æ·±åº¦ã€‘
</span></span></span><span class="line"><span class="cl"><span class="cm"> *****************************************************************************/</span>
</span></span><span class="line"><span class="cl"><span class="k">template</span> <span class="o">&lt;</span><span class="k">typename</span> <span class="n">K</span><span class="p">,</span> <span class="k">typename</span> <span class="n">V</span><span class="p">,</span> <span class="k">typename</span> <span class="n">KC</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl"><span class="k">auto</span> <span class="n">DiskExtendibleHashTable</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;::</span><span class="n">Remove</span><span class="p">(</span><span class="k">const</span> <span class="n">K</span> <span class="o">&amp;</span><span class="n">key</span><span class="p">,</span> <span class="n">Transaction</span> <span class="o">*</span><span class="n">transaction</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kt">bool</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//return false;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// è·å– Header Pageï¼ˆè¯»ä¿æŠ¤ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">header_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageRead</span><span class="p">(</span><span class="n">header_page_id_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">header_page</span> <span class="o">=</span> <span class="n">header_guard</span><span class="p">.</span><span class="n">As</span><span class="o">&lt;</span><span class="n">ExtendibleHTableHeaderPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="kt">uint32_t</span> <span class="n">hash</span> <span class="o">=</span> <span class="n">Hash</span><span class="p">(</span><span class="n">key</span><span class="p">);</span>  <span class="c1">// for test
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">auto</span> <span class="n">directory_index</span> <span class="o">=</span> <span class="n">header_page</span><span class="o">-&gt;</span><span class="n">HashToDirectoryIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">directory_page_id</span> <span class="o">=</span> <span class="n">header_page</span><span class="o">-&gt;</span><span class="n">GetDirectoryPageId</span><span class="p">(</span><span class="n">directory_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">directory_page_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">INVALID_PAGE_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// è·å– Directory Pageï¼ˆå†™ä¿æŠ¤ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">WritePageGuard</span> <span class="n">directory_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageWrite</span><span class="p">(</span><span class="n">directory_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">directory_page</span> <span class="o">=</span> <span class="n">directory_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableDirectoryPage</span><span class="o">&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">bucket_index</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">HashToBucketIndex</span><span class="p">(</span><span class="n">hash</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">bucket_page_id</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="k">static_cast</span><span class="o">&lt;</span><span class="kt">int</span><span class="o">&gt;</span><span class="p">(</span><span class="n">bucket_page_id</span><span class="p">)</span> <span class="o">==</span> <span class="n">INVALID_PAGE_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="c1">// è·å–å­˜å‚¨æ¡¶é¡µï¼ˆå†™ä¿æŠ¤ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// find the target key in the third level
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">WritePageGuard</span> <span class="n">bucket_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageWrite</span><span class="p">(</span><span class="n">bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">auto</span> <span class="n">bucket_page</span> <span class="o">=</span> <span class="n">bucket_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å°è¯•åˆ é™¤é”®å€¼å¯¹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="kt">bool</span> <span class="n">remove_success</span> <span class="o">=</span> <span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">Remove</span><span class="p">(</span><span class="n">key</span><span class="p">,</span> <span class="n">cmp_</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">remove_success</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="nb">false</span><span class="p">;</span><span class="c1">// é”®ä¸å­˜åœ¨
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// å½“å­˜å‚¨æ¡¶å˜ä¸ºç©ºæ—¶ï¼Œéœ€åˆå¹¶ç›¸é‚»æ¡¶å¹¶è°ƒæ•´ç›®å½•ç»“æ„ï¼š
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">bucket_page</span><span class="o">-&gt;</span><span class="n">IsEmpty</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">bucket_guard</span><span class="p">.</span><span class="n">Drop</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// è·å–å½“å‰æ¡¶çš„å±€éƒ¨æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">bucket_local_depth</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bucket_local_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span><span class="c1">// // å±€éƒ¨æ·±åº¦ä¸º0æ—¶æ— æ³•åˆå¹¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">//å¾—åˆ°åˆ†è£‚çš„æ¡¶ï¼Œå‡†å¤‡é‡æ–°åˆå¹¶ï¼›
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// è·å–é•œåƒæ¡¶ï¼ˆSplit Imageï¼‰çš„ç´¢å¼•å’Œé¡µID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="c1">// é•œåƒæ¡¶ï¼šä¸åŸæ¡¶å…±äº«çˆ¶æ¡¶çš„å¦ä¸€ä¸ªå­æ¡¶ï¼ˆä¾‹å¦‚åŸæ¡¶ç´¢å¼•ä¸º0b101ï¼Œé•œåƒæ¡¶ä¸º0b001ï¼‰ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">auto</span> <span class="n">merge_bucket_index</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetSplitImageIndex</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">merge_bucket_local_depth</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepth</span><span class="p">(</span><span class="n">merge_bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="k">auto</span> <span class="n">merge_bucket_page_id</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="n">merge_bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">bucket_local_depth</span> <span class="o">==</span> <span class="n">merge_bucket_local_depth</span><span class="p">)</span> <span class="p">{</span>  <span class="c1">//ç©ºæ¡¶å’Œæƒ³è¦åˆå¹¶æ¡¶æ·±åº¦ä¸€æ ·
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// æ›´æ–°ç›®å½•æ˜ å°„ï¼Œåˆå¹¶å­˜å‚¨æ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// è·å–å½“å‰æ·±åº¦çš„ä½æ©ç ï¼ˆæˆ‘è®¤ä¸ºæ˜¯è·å–ç›®å½•é¡µé¢ä¸­ç¬¬ä¸€ä¸ªæŒ‡å‘ç©ºæ¡¶å’Œæƒ³è¦åˆå¹¶æ¡¶çš„åœ°æ–¹ï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">uint32_t</span> <span class="n">traverse_bucket_idx</span> <span class="o">=</span><span class="n">std</span><span class="o">::</span><span class="n">min</span><span class="p">(</span><span class="n">bucket_index</span> <span class="o">&amp;</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetLocalDepthMask</span><span class="p">(</span><span class="n">bucket_index</span><span class="p">),</span> <span class="n">merge_bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//è¿™é‡Œæ˜¯è·å–æ­¥é•¿ï¼Œæˆ‘å¾—ç†è§£æ˜¯æ¯ä¸ªæŒ‡å‘åˆå¹¶å­˜å‚¨æ¡¶çš„ç›®å½•é¡µé¢å†…çš„ç›¸é‚»çš„ä¿©ä¸ªå†…å®¹ä¹‹é—´çš„é—´è·ï¼Œè¿™ä¸ªé—´è·åº”è¯¥æ˜¯å›ºå®šå¤§å°çš„
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">uint32_t</span> <span class="n">distance</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">&lt;&lt;</span> <span class="p">(</span><span class="n">bucket_local_depth</span> <span class="o">-</span><span class="mi">1</span><span class="p">);</span>  <span class="c1">//å‡å°å±€éƒ¨æ·±åº¦åˆå¹¶åœ¨ä¸€èµ·æ¯”å¦‚ 011åº”è¯¥å’Œ111åˆå¹¶åœ¨ä¸€èµ·æ‰€ä»¥æ˜¯bucket_local_depth - 1
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kt">uint32_t</span> <span class="n">new_local_depth</span> <span class="o">=</span> <span class="n">bucket_local_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å°†åŸæ¡¶å¯¹åº”çš„ç›®å½•é¡¹æŒ‡å‘é•œåƒæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// å±€éƒ¨æ·±åº¦å‡1ï¼ˆå¦‚ä»3å‡åˆ°2ï¼‰ï¼Œè¿™ç±»ä¼¼äºå“ˆå¸Œè¡¨æ”¶ç¼©æ—¶çš„é‡æ–°æ˜ å°„è¿‡ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// éå†é‡‡ç”¨è·³è·ƒå¼æ›´æ–°ï¼Œä¾‹å¦‚æ·±åº¦3æ—¶æ¯éš”4ä¸ªç›®å½•é¡¹æ›´æ–°ä¸€æ¬¡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">for</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">traverse_bucket_idx</span><span class="p">;</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">Size</span><span class="p">();</span> <span class="n">i</span> <span class="o">+=</span> <span class="n">distance</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">SetBucketPageId</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">merge_bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">SetLocalDepth</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">new_local_depth</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// å¤„ç†çˆ¶çº§åˆå¹¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">new_local_depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//å‡è®¾ä¹‹å‰æ˜¯ 011æ»¡äº†æ‰¾åˆ°äº†111
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">//è®¡ç®—å½“å‰é•œåƒæ¡¶çš„çˆ¶çº§é•œåƒæ¡¶ç´¢å¼•
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">split_image_bucket_index</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetSplitImageIndex</span><span class="p">(</span><span class="n">merge_bucket_index</span><span class="p">);</span>  <span class="c1">// 11-&gt;01
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// è·å–çˆ¶çº§é•œåƒæ¡¶çš„é¡µID
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">split_image_bucket_page_id</span> <span class="o">=</span> <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">GetBucketPageId</span><span class="p">(</span><span class="n">split_image_bucket_index</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//  è·å–çˆ¶çº§é•œåƒæ¡¶çš„å†™ä¿æŠ¤
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">WritePageGuard</span> <span class="n">split_image_bucket_guard</span> <span class="o">=</span> <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">FetchPageWrite</span><span class="p">(</span><span class="n">split_image_bucket_page_id</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// çˆ¶çº§é•œåƒæ¡¶ä¸ºæ— æ•ˆæ—¶ï¼Œåˆ™è·³è¿‡åˆå¹¶æµç¨‹ã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">if</span> <span class="p">(</span><span class="n">split_image_bucket_page_id</span> <span class="o">==</span> <span class="n">INVALID_PAGE_ID</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}</span>
</span></span><span class="line"><span class="cl">      <span class="c1">//  æ›´æ–°å½“å‰æ¡¶ä¿¡æ¯
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">auto</span> <span class="n">helper</span> <span class="o">=</span> <span class="n">bucket_page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// æˆ‘å½“æ—¶æ˜¯å’‹æƒ³çš„ï¼Ÿå†™å‡ºä¸‹é¢è¿™ä¸€è¡ŒæŠ½è±¡ä»£ç â€¦â€¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// gradescopeä¸æä¾›æµ‹è¯•æºç ï¼Œæˆ‘è¿™ç§å¤ç°ä¸äº†æµ‹è¯•çš„èœé¸¡é‡æ–°reviewäº†ä¸€éä»£ç æ‰æ‰¾å‡ºè¿™ä¸ªbugã€‚
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// directory_page-&gt;SetBucketPageId(bucket_index, 0);
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="c1">// æ›´æ–°å½“å‰æ“ä½œç›®æ ‡ä¸ºçˆ¶çº§é•œåƒæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">bucket_index</span> <span class="o">=</span> <span class="n">split_image_bucket_index</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">bucket_page_id</span> <span class="o">=</span> <span class="n">split_image_bucket_page_id</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="n">bucket_guard</span> <span class="o">=</span> <span class="n">std</span><span class="o">::</span><span class="n">move</span><span class="p">(</span><span class="n">split_image_bucket_guard</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">bucket_page</span> <span class="o">=</span> <span class="n">bucket_guard</span><span class="p">.</span><span class="n">AsMut</span><span class="o">&lt;</span><span class="n">ExtendibleHTableBucketPage</span><span class="o">&lt;</span><span class="n">K</span><span class="p">,</span> <span class="n">V</span><span class="p">,</span> <span class="n">KC</span><span class="o">&gt;&gt;</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// åˆ é™¤åŸæ¡¶
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="n">bpm_</span><span class="o">-&gt;</span><span class="n">DeletePage</span><span class="p">(</span><span class="n">helper</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Can not merge because of (LD != LD(split_image))
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="k">break</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="c1">// å‡å°‘ç›®å½•æ·±åº¦ï¼šé€šè¿‡é€’å½’åˆå¹¶çˆ¶çº§æ¡¶ï¼Œå¯èƒ½è¿›ä¸€æ­¥æ”¶ç¼©ç›®å½•çš„å…¨å±€æ·±åº¦ï¼Œå‡å°‘ç›®å½•é¡¹æ•°é‡
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="k">while</span> <span class="p">(</span><span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">CanShrink</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">DecrGlobalDepth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="c1">// æ£€æŸ¥æ˜¯å¦æ‰€æœ‰ç›®å½•é¡¹çš„å±€éƒ¨æ·±åº¦éƒ½å°äºå½“å‰å…¨å±€æ·±åº¦
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// é€æ­¥æ”¶ç¼©å…¨å±€æ·±åº¦ï¼Œè¿™ç±»ä¼¼äºC++å“ˆå¸Œè¡¨æ‰©å®¹çš„é€†è¿‡ç¨‹
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="c1">// å…¨å±€æ·±åº¦å†³å®šäº†ç›®å½•é¡¹çš„æ€»æ•°ï¼ˆ2^global_depthï¼‰
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="k">while</span> <span class="p">(</span><span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">CanShrink</span><span class="p">())</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="n">directory_page</span><span class="o">-&gt;</span><span class="n">DecrGlobalDepth</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="k">return</span> <span class="n">remove_success</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="c1">//*****************************************************************************
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ä»»åŠ¡-4---å¹¶å‘æ§åˆ¶">ä»»åŠ¡ #4 - å¹¶å‘æ§åˆ¶
</h2><p>æ­£å¦‚å®˜ç½‘æ‰€è¯´ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">â€œæˆ‘ä»¬å»ºè®®æ‚¨ä½¿ç”¨ FetchPageWrite æˆ– FetchPageRead ç¼“å†²æ±  API æ¥å®Œæˆæ­¤ä»»åŠ¡ï¼Œå…·ä½“å–å†³äºæ‚¨æ˜¯è¦ä½¿ç”¨è¯»å–æƒé™è¿˜æ˜¯å†™å…¥æƒé™è®¿é—®é¡µé¢ã€‚â€
</span></span></code></pre></td></tr></table>
</div>
</div><p>å¾—ç›Šäºæˆ‘ä»¬åœ¨Task #1è‡ªå·±æ„å»ºçš„RAllç»“æ„å¹¶åœ¨åç»­çš„ä¸¥æ ¼éµå®ˆï¼Œæ‰€ä»¥Task #4 - Concurrency Controlçš„å®ç°æ˜¯æ°´åˆ°æ¸ æˆçš„ï¼Œä¸å†éœ€è¦ä»€ä¹ˆé¢å¤–å·¥ä½œã€‚</p>
<p><strong>å‚è€ƒæ–‡ç« ï¼š</strong>
<a class="link" href="https://www.cnblogs.com/fenfeng9/p/18003336"  target="_blank" rel="noopener"
    >CMU 15-445(Fall 2023) Project2 Extendible Hash Indexä¸ªäººç¬”è®° - ç„šé£ - åšå®¢å›­</a></p>
<p><a class="link" href="https://zhuanlan.zhihu.com/p/679864158"  target="_blank" rel="noopener"
    >CMU15-445 2023 Fall Project#2 - Extensible Hash Index - çŸ¥ä¹</a></p>
<p><a class="link" href="https://zhuanlan.zhihu.com/p/622221722"  target="_blank" rel="noopener"
    >CMU 15-445 P1 Extendible Hash Table å¯æ‰©å±•å“ˆå¸Œè¯¦ç»†ç†è§£ - çŸ¥ä¹</a></p>
<p>[<a class="link" href="https://blog.csdn.net/MarksSa/article/details/135646298"  target="_blank" rel="noopener"
    >15-445 fall 2023] P2ä»£ç è§£æ-CSDNåšå®¢</a></p>
<p><a class="link" href="https://blog.csdn.net/weixin_49614712?type=blog"  target="_blank" rel="noopener"
    >é²¤é±¼_1-CSDNåšå®¢</a></p>
<p><a class="link" href="https://blog.csdn.net/weixin_49614712/article/details/144061184?spm=1001.2014.3001.5502"  target="_blank" rel="noopener"
    >CMU_15-445ï¼ˆfall 2023ï¼‰-P2ï¼ˆä¸‹ï¼‰å¯æ‹“å±•å“ˆå¸Œå®ç°åŠå¹¶å‘æ§åˆ¶_15-445 fall2023 p2-CSDNåšå®¢</a></p>
<p><a class="link" href="https://blog.csdn.net/weixin_49614712/article/details/143818840?spm=1001.2014.3001.5502"  target="_blank" rel="noopener"
    >CMU15-445-P2ï¼ˆä¸­ï¼‰ä¸‰çº§hash_pageè¯¦è§£-CSDNåšå®¢</a></p>
<p><a class="link" href="https://blog.csdn.net/weixin_49614712/article/details/143774289?spm=1001.2014.3001.5502"  target="_blank" rel="noopener"
    >CMU15-445-P2ï¼ˆä¸Šï¼‰å…¨å±€æ€è·¯ä»¥åŠpage_guardè¯¦è§£_cmu15445 p2-CSDNåšå®¢</a></p>

</section>


    <footer class="article-footer">
    

    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    <section class="article-lastmod">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



        <span>
            æœ€åæ›´æ–°äº Mar 21, 2025 21:48 &#43;0800
        </span>
    </section></footer>


    
</article>

    

    

     
    
        
    <script
    src="https://giscus.app/client.js"
    data-repo="1878247293/1878247293.github.io"
    data-repo-id="R_kgDONMr1fg"
    data-category="Announcements"
    data-category-id="DIC_kwDONMr1fs4CkNCD"
    data-mapping="pathname"
    data-strict="0"
    data-reactions-enabled="1"
    data-emit-metadata="0"
    data-input-position="top"
    data-theme="light"
    data-lang="zh-CN"
    data-loading="lazy"
    crossorigin="anonymous"
    async
></script>
<script>
    function setGiscusTheme(theme) {
        let giscus = document.querySelector("iframe.giscus-frame");
        if (giscus) {
            giscus.contentWindow.postMessage(
                {
                    giscus: {
                        setConfig: {
                            theme: theme,
                        },
                    },
                },
                "https://giscus.app"
            );
        }
    }

    (function () {
        addEventListener("message", (e) => {
            if (event.origin !== "https://giscus.app") return;
            handler();
        });
        window.addEventListener("onColorSchemeChange", handler);

        function handler() {
            if (document.documentElement.dataset.scheme === "light") {
                setGiscusTheme('light');
            } else {
                setGiscusTheme('dark_dimmed');
            }
        }
    })();
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2024 - 
        
        2025 æ˜å¤©å†è§
    </section>
    
    <section class="powerby">
        ä½¿ç”¨ <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> æ„å»º <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.30.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.1e9a3bafd846ced4c345d084b355fb8c7bae75701c338f8a1f8a82c780137826.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.css">
<script src="https://cdn.jsdelivr.net/npm/aplayer/dist/APlayer.min.js"></script>
<div id="aplayer"></div>

<script>
	const home = "https://1878247293.github.io/"
	const ap = new APlayer({
    container: document.getElementById('aplayer'),
	
    audio: [{
        name: 'å¤©ä¸‹æœ‰æƒ…äºº',
        artist: 'å‘¨åå¥',
        url: home+'music/å¤©ä¸‹æœ‰æƒ…äºº-å‘¨åå¥/song.mp3',
        cover: home+'music/å¤©ä¸‹æœ‰æƒ…äºº-å‘¨åå¥/cover.jpg',
		 
    },
	{
		
	}]
});
</script>
<style>
  body {
    background: url(https://1878247293.github.io/background/7nzi4hch.png) no-repeat center top;
    background-size: cover;
    background-attachment: fixed;
  }
</style>
<script src=https://1878247293.github.io/background/sakura.js></script>
<div id="particles-js"></div>

<script src=https://1878247293.github.io/background/particles.min.js></script>
<script>
  particlesJS.load('particles-js', "https://1878247293.github.io/background/particlesjs-config.json", function() {
    console.log('particles.js loaded - callback');
  });
</script>

<style>
  #particles-js {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    z-index: -1;
  }
</style>


<script>
const live2d_path = "https://fastly.jsdelivr.net/gh/stevenjoezhang/live2d-widget@latest/";

const cssPath = "https://1878247293.github.io/waifu/waifu.css"
const waifujosnPath = "https://1878247293.github.io/waifu/waifu-tips.json"
const live2dPath = "https://1878247293.github.io/waifu/live2d.min.js"

function loadExternalResource(url, type) {
	return new Promise((resolve, reject) => {
		let tag;

		if (type === "css") {
			tag = document.createElement("link");
			tag.rel = "stylesheet";
			tag.href = url;
		}
		else if (type === "js") {
			tag = document.createElement("script");
			tag.src = url;
		}
		if (tag) {
			tag.onload = () => resolve(url);
			tag.onerror = () => reject(url);
			document.head.appendChild(tag);
		}
	});
}


if (screen.width >= 768) {
	Promise.all([
		loadExternalResource(cssPath, "css"),
		loadExternalResource(live2dPath, "js"),
		loadExternalResource(live2d_path + "waifu-tips.js", "js")
	]).then(() => {
		
		initWidget({
			waifuPath: waifujosnPath,
			
			cdnPath: "https://fastly.jsdelivr.net/gh/fghrsh/live2d_api/",
			tools: ["hitokoto", "asteroids", "switch-model", "switch-texture", "photo", "info", "quit"]
		});
		initWaifuMouseEvent();
	});
}
function initWaifuMouseEvent() {
        const waifu = document.getElementById("waifu");
        let isDown = false;
        let waifuLeft;
        let mouseLeft;
        let waifuTop;
        let mouseTop;
        
        waifu.onmousedown = function (e) {
            isDown = true;
            
            waifuLeft = waifu.offsetLeft;
            mouseLeft = e.clientX;
            
            waifuTop = waifu.offsetTop;
            mouseTop = e.clientY;
        }
        
        window.onmousemove = function (e) {
            if (!isDown) {
                return;
            }
            
            let currentLeft = waifuLeft + (e.clientX - mouseLeft);
            if (currentLeft < 0) {
                currentLeft = 0;
            } else if (currentLeft > window.innerWidth - 300) {
                currentLeft = window.innerWidth - 300;
            }
            waifu.style.left = currentLeft  + "px";
            
            
            
            
            
            
            
            
        }
        
        window.onmouseup = function (e) {
            isDown = false;
        }
    }
</script>





    </body>
</html>
